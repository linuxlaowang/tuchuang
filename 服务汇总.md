# 旨在规范服务类应用
## keepalived 部署
vip部署:备节点
```
[root@ecs-x86-bdnb-p2p97 ~]$ cat /etc/keepalived/keepalived.conf
global_defs {
    notification_email {
     root@localhost                                # # 故障通知接收邮箱（可多个，此处仅本地 root）
    }
   notification_email_from root@localhost              # # 发送通知的邮箱地址
    smtp_server 127.0.0.1                       # # 发送邮件的 SMTP 服务器（本地邮件服务）
    smtp_connect_timeout 30                 ## SMTP 连接超时时间（30秒）
    router_id dd000097          # # 节点唯一标识（建议与主机名相关，用于区分集群中的节点）。需要不一致
}
#核心作用：配置故障时的邮件通知参数（但实际中若未部署本地邮件服务，此功能可能不生效），router_id 是集群中节点的唯一标识，避免混淆。
vrrp_instance VI_1 {                ## VI_1 是实例名（同一集群内实例名需一致）

    state BACKUP
    nopreempt
    interface ens192
    virtual_router_id 098
    priority 95
    advert_int 1
    authentication {
        auth_type PASS                      #认证方式：密码认证
        auth_pass 026000096                 ## 认证密码（同一集群所有节点必须相同）
    }   
    virtual_ipaddress {
        172.26.0.98/24 dev ens192 label ens192:1
    }
}
```
主节点
```
[root@ecs-x86-bdnb-p2p96 ~]$ cat /etc/keepalived/keepalived.conf
global_defs {
    notification_email {
     root@localhost
    }
   notification_email_from root@localhost
    smtp_server 127.0.0.1
    smtp_connect_timeout 30
    router_id dd000096                                #需要区分。多多云96末尾ip。不一致
}

vrrp_instance VI_1 {                    ## VI_1 是实例名（同一集群内实例名需一致）

    state BACKUP                               #统一为BACKUP,防止其他情况
    nopreempt                   #非抢占模式，即使原主节点恢复且优先级更高，VIP 也不会切回原主节点。
    interface ens192                                #实际网卡
    virtual_router_id 098              #VRRP 协议的 “集群标识”同一集群的所有节点（主、备）必须配置相同的值（如 098），否则节点间无法识别为同一集群，无法实现 VIP 漂移。
    priority 100                          #节点优先级：
    advert_int 1                            #节点每秒发送一次 “心跳包”（VRRP 通告）
    authentication {
        auth_type PASS
        auth_pass 026000096
    }
    virtual_ipaddress {
        172.26.0.98/24 dev ens192 label ens192:1              #应该适用于多网卡， VIP 为 172.26.0.98/24
    }
}
```
## p2p部署
1. x86服务器上开启ipv4 转发
永久转发
```
vi /etc/sysctl.conf
net.ipv4.ip_forward = 1
```
生效  `sysctl -p`
检测：
```
sysctl net.ipv4.ip_forward
cat  /proc/sys/net/ipv4/ip_forward      #是否为1,临时生效为echo 1 >/proc/sys/net/ipv4/ip_forward
```
2. centos7 想要使用：service iptables save 命令，需要下载服务，否则报错不支持
CentOS 6 或已安装 iptables-services 的 CentOS 7+
```
yum -y install iptables-services
```
3. 保存规则
```
mkdir -p /data/paas
cd /data/paas
cp /etc/sysconfig/iptables iptables.bak.xxx          #报存一份iptables规则
#iptables -t nat -F 清除nat规则，这里一般用不到
```
4. 清理线上多余的规则和多余的链，一般由于firewalld 引起
停掉firewalld
`systemctl disable --now firewalld`
删除持久化规则，之前已备份
`rm -f /etc/sysconfig/iptables`
重启iptables后即可恢复为最简单的表、链规则
```
systemctl restart iptables
iptables -t nat -nvL|wc -l               #这里就恢复正常了
```
5. iptables 添加转发规则:MASQUERADE
`cat /etc/sysconfig/iptables |wc -l ; iptables -t nat -A POSTROUTING -j MASQUERADE && service iptables save; cat /etc/sysconfig/iptables |wc -l`
6. pass平台添加iptables节点：vip、三线域名、机房信息
7. 确保系统集成同事 部署好vip节点，p2p 无切换脚本。服务器故障自动切换，切换逻辑见上方keepalived 配置
8. 确保外网域名的iptables映射规则，由客户或者网络侧处理。常用规则如下：

| 服务 | 机房 | 三线域名 | 二线(电移) |二线(联移 )| 二线(电联) | 单线(移动) | 单线(联通) | 单线(电信) | 外网端口 | IP | 内网端口 | 协议 | 推流方式 |
| :-- | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--:| --: |  
| P2P | PCLOUD机房 | nbp2p.fzyinghe.com ||||||| 20001 - 60000 | 172.26.0.98 | 20001 - 60000 | TCP | P2P推流 |
| P2P | PCLOUD机房 | nbp2p.fzyinghe.com ||||||| 20001 - 60000 | 172.26.0.98 | 20001 - 60000 | UDP | P2P推流 |

## 
