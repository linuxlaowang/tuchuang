- [笔记大全- 笔记大全](#笔记大全--笔记大全)
  - [常规不熟悉的命令](#常规不熟悉的命令)
    - [nginx 文件服务器](#nginx-文件服务器)
    - [常见问题](#常见问题)
  - [支持人员](#支持人员)
  - [wsphone\_nodes](#wsphone_nodes)
    - [私有化上架流程](#私有化上架流程)
    - [公有云上架注意](#公有云上架注意)
    - [刷机：运管平台常见到的问题](#刷机运管平台常见到的问题)
    - [其他常见问题](#其他常见问题)
    - [关于内核中内存的相关介绍](#关于内核中内存的相关介绍)
- [用于 Linux 内核中启用 LRU generation 机制，用于优化内存页面的回收策略](#用于-linux-内核中启用-lru-generation-机制用于优化内存页面的回收策略)
    - [云手机离线问题处理集合1](#云手机离线问题处理集合1)
    - [预警处理](#预警处理)
    - [刷机各问题](#刷机各问题)
        - [应用加白，白名单](#应用加白白名单)
        - [内存隔离问题](#内存隔离问题)
    - [刷机之安装桌面apk、内置应用apk-----常见刷机问题1](#刷机之安装桌面apk内置应用apk-----常见刷机问题1)
        - [背景： 云手机更换成客户自己的桌面程序](#背景-云手机更换成客户自己的桌面程序)
        - [背景： 内置apk的回验问题](#背景-内置apk的回验问题)
        - [刷机中su 的问题](#刷机中su-的问题)
      - [版本型号汇总](#版本型号汇总)
    - [pcdn](#pcdn)
  - [ebtables隔离问题汇总](#ebtables隔离问题汇总)
  - [pgsql 最近涉及到的sql命令](#pgsql-最近涉及到的sql命令)
  - [待学排查](#待学排查)
    - [接口查询工具](#接口查询工具)
  - [周报汇总](#周报汇总)
  - [post请求，找时间实验下](#post请求找时间实验下)
- [--max-time 10：超时时间（10 秒内没响应就停止等待）](#--max-time-10超时时间10-秒内没响应就停止等待)
  - [shell脚本思路](#shell脚本思路)
    - [shell 脚本中可以直接嵌套脚本，用于相同逻辑函数调用。 要注意变量和 ？ \* 的通配符 在函数中使用时，若是双重解析的话不可以使用引号。](#shell-脚本中可以直接嵌套脚本用于相同逻辑函数调用-要注意变量和---的通配符-在函数中使用时若是双重解析的话不可以使用引号)
  - [数组相关理解](#数组相关理解)
      - [采用shell 去判断一个物理机的多个变量值的模板](#采用shell-去判断一个物理机的多个变量值的模板)
      - [采用shell 实现：1个物理ip，多个虚机ip的情况，只需要for循环即可](#采用shell-实现1个物理ip多个虚机ip的情况只需要for循环即可)
      - [采用shell 实现：密钥对分发](#采用shell-实现密钥对分发)
      - [采用shell 去备份system命令](#采用shell-去备份system命令)
      - [采用shell 去本地物理机去实现，1个物理ip。多个虚机ip。重复调用函数的情况。 若是想1个物理机ip，和多个虚机在一行，并用：分隔，可以参考之前的checklist脚本或者memory\_scan.sh 脚本。](#采用shell-去本地物理机去实现1个物理ip多个虚机ip重复调用函数的情况-若是想1个物理机ip和多个虚机在一行并用分隔可以参考之前的checklist脚本或者memory_scansh-脚本)
      - [经常用到的云手机执行命令的函数模板](#经常用到的云手机执行命令的函数模板)
  - [upload\_batch 大脚本的各种场景适配](#upload_batch-大脚本的各种场景适配)
  - [pass各服务问题定位](#pass各服务问题定位)
    - [服务汇总，manage-proxy manage-agent ctrl-server](#服务汇总manage-proxy-manage-agent-ctrl-server)
  - [F12定位问题汇总](#f12定位问题汇总)
  - [各值班问题汇总](#各值班问题汇总)
  - [值班服务问题汇总。有各种服务地址问题：优先去243 的ansible上查看。](#值班服务问题汇总有各种服务地址问题优先去243-的ansible上查看)
    - [反馈机房网络延迟数值很高，判断是否和推流有关系](#反馈机房网络延迟数值很高判断是否和推流有关系)
      - [登录243：ansibles    cd /data/mci/kioa/\_ansibleBasic/base-service](#登录243ansibles----cd-datamcikioa_ansiblebasicbase-service)
      - [值班汇总1：客户端流量使用高](#值班汇总1客户端流量使用高)
      - [值班问题1 控制服务主故障1分，切到备机，备机内存条有问题，导致服务异常引起的故障。](#值班问题1-控制服务主故障1分切到备机备机内存条有问题导致服务异常引起的故障)
      - [值班问题2：toc主营海外零散报备：虚机离线、受控离线等问题](#值班问题2toc主营海外零散报备虚机离线受控离线等问题)
      - [值班问题3：防火墙iptables问题 检测是否正常](#值班问题3防火墙iptables问题-检测是否正常)
      - [值班问题4：汇总各种离线，错误码、无法连接云手机问题](#值班问题4汇总各种离线错误码无法连接云手机问题)
      - [值班问题5：阻止安装问题](#值班问题5阻止安装问题)
      - [值班问题6： x86内存泄露问题](#值班问题6-x86内存泄露问题)
      - [值班问题6：](#值班问题6)
      - [值班问题7：限速问题](#值班问题7限速问题)
      - [值班问题8：错误码汇总场景](#值班问题8错误码汇总场景)
  - [如流机器人使用方法](#如流机器人使用方法)
    - [md语法send](#md语法send)
    - [link + 艾特(@群成员(仅可以与TEXT类型、LINK类型一起使用，IMAGE类型、MARKDOWN类型不能使用AT类型))](#link--艾特群成员仅可以与text类型link类型一起使用image类型markdown类型不能使用at类型)
    - [图片send](#图片send)
    - [基础text](#基础text)
  - [值班服务问题学习汇总 1：管理代理 服务： manage-proxy](#值班服务问题学习汇总-1管理代理-服务-manage-proxy)
  - [值班问题汇总](#值班问题汇总)
    - [各种理解](#各种理解)
    - [通用问题](#通用问题)
    - [交付问题汇总](#交付问题汇总)
- [排查问题汇总](#排查问题汇总)
    - [TOb-P2P配置check是否丢失](#tob-p2p配置check是否丢失)



# 笔记大全- [笔记大全](#笔记大全)
## 常规不熟悉的命令
1. tr 命令
   echo -e "11.32.75.96 \n10.0.3.1" |tr '\n' '|' |sed 's/|$//'         #tr 是 "translate"（转换）的缩写，用于字符替换或删除 第一个参数 '\n' 表示要被替换的字符（换行符） 第二个参数 '|' 表示替换后的字符（竖线）
```
root@mciserver:~# echo "apple,banana,orange" | tr ',' '\n'               #tr 的换字符法。基本字符替换
apple
banana
orange

echo "abc123def456" | tr -d '0-9'  # 输出: abcdef                     #tr 删除数字

echo "hello   world    python" | tr -s ' '  # 输出: hello world python         ## 压缩连续的空格为单个空格

#字符类
tr 支持预定义的字符类（需用 [: :] 包裹）：
[:lower:]：所有小写字母
[:upper:]：所有大写字母
[:digit:]：所有数字
[:space:]：所有空白字符（空格、制表符等）
[:punct:]：所有标点符号

# 字母大小写互换
echo "Hello World" | tr '[:lower:][:upper:]' '[:upper:][:lower:]'
# 输出: hELLO wORLD

```
2. 时间手动同步  
root用户：设置时间  `date -s "xxxx"`             #例如：date -s "2025-01-14 15:30:00"  
设置完成后同步到硬件时钟 `hwclock -w`  
```
1、 Centos7 ssh远程登录。  需要 vi /etc/ssh/sshd_config  将PermitRootLogin yes  放开注释即可。
```
1. authorized_keys该文件作用：存储公钥的地方，用于私钥认证。这个文件存有允许以 SSH 方式登录到当前用户账户的公钥。若其他用户想通过 SSH 密钥认证的方式登录到根用户账户，就得把他们的公钥添加到这个文件里。  
#原理：   A服务器登录B C 服务器，需要把A 服务器自己生成的pub 公钥给到b c 服务器，以此可以用于ssh免密连接。 
1. unzip -l 用于在线解压查看。
2. exportHISTTIMEFORMAT='%F %T '      用于显示history带时间戳。不一定准确。
3. pcdn 出现突发情况，设备侧止损，网络侧给出物理ip后，确认虚拟机ip，对齐设备进行 断网操作。指令如上  ifconfig eth0 down
4. ssh -i 连接报错，可以尝试
ssh 连接报错：
no matching host key type found .Their offer:ssh -rsa
sign_and_send_pubkey : no mutual signature supported
```
ssh -o PubkeyAcceptedAlgorithms=+ssh-rsa -o HostKeyAlgorithms=+ssh-rsa 用户名@服务器IP
# ssh-rsa  ,这个是x86 服务器中的/root/.ssh/ssh-rsa        #这个可以变化。
```
### nginx 文件服务器
```
[root@nginx ~]# cat /etc/nginx/nginx.conf

user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;
server {
        listen  8080;
        server_name  localhost;
        charset utf-8;
        #root 指令用来指定文件在服务器上的基路径
        root /data/statics;
        #location指令用来映射请求到本地文件系统
        location / {
           autoindex on; # 索引
           autoindex_exact_size on; # 显示文件大小
           autoindex_localtime on; # 显示文件时间
        }
   }

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}

wget 限速：  wget --limit-rate=500K               #单位500KB/s

自定义systemed 配置

[Unit]
Description=run suspicious_process_killer.sh
After=manage-main.service
Requires=manage-main.service

[Service]
ExecStart=/data/local/init_sh/suspicious_process_killer.sh
Type=simple
Restart=always
RestartSec=10
StartLimitIntervalSec=10min
StartLimitBurst=5
TimeoutStopSec=30
LogLevelMax=emerg
[Install]
WantedBy=multi-user.target
```
2. debian 系统使用 upload_batch.sh ，需要：
 * timeout 55 command ssh -p ${ssh_port:-62485} ${PARAM} root@$1 'pwd' >>/dev/null          #global_func.sh 删除command。debian默认无该命令
 * apt install -y gawk   apt install -y lsof
3. curl 的使用  
   curl cip.cc 或者 curl ipinfo.io   或者通过浏览器去访问测速网，也可以看到自己的出口公网地址。
当我们刷机遇到rootfs 等功能包下载失败的问题，可以手动测试是否可以稳定复现，以此判断arm设备是否存在异常
例如：
```
curl -H 'desKey:6f35483c070042789472a54664e4f3ee' -o test.tar.gz https://cd-file-server.armvm.com:9811/route_to_download/paas/android/file_permanent/456de122338f186cb8bbffae5b51525c.tar.gz             #deskey 以及 https 地址 均可以通过： op-agent的serverlog日志过滤taskid 获取。 -o 起一个名字。

-H（或 --header）：用于添加 HTTP 请求头信息。
desKey:6f35483c070042789472a54664e4f3ee：这是一个自定义请求头，由两部分组成：
desKey：头字段名称（可能是服务端约定的 “解密密钥标识” 或 “身份验证标识”）；
6f35483c070042789472a54664e4f3ee：头字段值（看起来是一个 32 位的十六进制字符串，可能是用于文件解密的密钥或校验凭证）。
-o（或 --output）：指定下载文件的本地保存路径和文件名。
这个命令的核心作用是 “使用指定的身份凭证（desKey）通过 HTTPS 从特定服务器下载一个压缩包文件，并保存到本地”。执行时的稳定性依赖于网络质量、服务器状态和本地 TLS 配置，偶发的加密错误通常与这些因素相关。

遇到的报错有：
curl: (56) OpenSSL SSL_read: error:1408F119:SSL routines:ssl3_get_record:decryption failed or bad record mac, errno 0 是一个 TLS/SSL 层的加密传输错误，具体含义和核心原因如下：

bad record mac：解密后的数据校验失败 —— 发送方会对每个加密数据包计算一个 MAC（消息认证码）（用于验证数据完整性和真实性），接收方解密后计算的 MAC 与发送方附带的 MAC 不匹配，说明数据在传输中被篡改或损坏。
errno 0：表示系统层面无额外错误码，问题完全出在 TLS/SSL 协议层。

MAC（消息认证码）的全程是 Message Authentication Code。：它是一种通过密码学算法生成的校验值，用于验证消息的 完整性（确保消息未被篡改）和 真实性（确认消息来自合法发送方）。
在 TLS/SSL 协议中，MAC 通常基于共享密钥和消息内容计算得出，发送方会将 MAC 与加密后的消息一同发送，接收方使用相同的密钥和算法重新计算 MAC 并与收到的 MAC 比对，若一致则说明消息可信。
```
4. debian 常见install报错问题：
```shell
apt install -y dnsutils     #安装报错nginx 的错误。无法解决，需要卸载掉nginx或者重装。dnsutils 与nginx可能无关，由于nginx有错误，无法继续安装
root@mciserver:~# apt-get remove -y nginx

Job for nginx.service failed because the control process exited with error code.
See "systemctl status nginx.service" and "journalctl -xe" for details.
invoke-rc.d: initscript nginx, action "start" failed.
● nginx.service - LSB: starts the nginx web server
     Loaded: loaded (/etc/init.d/nginx; generated)
     Active: failed (Result: exit-code) since Thu 2025-10-16 19:21:01 HKT; 18ms ago
       Docs: man:systemd-sysv-generator(8)
    Process: 2719 ExecStart=/etc/init.d/nginx start (code=exited, status=1/FAILURE)

Oct 16 19:21:01 mciserver systemd[1]: Starting LSB: starts the nginx web server...
Oct 16 19:21:01 mciserver nginx[2719]: Starting nginx: nginx
Oct 16 19:21:01 mciserver nginx[2730]:  failed!
Oct 16 19:21:01 mciserver systemd[1]: nginx.service: Control process exited, code=exited, status=1/FAILURE
Oct 16 19:21:01 mciserver systemd[1]: nginx.service: Failed with result 'exit-code'.
Oct 16 19:21:01 mciserver systemd[1]: Failed to start LSB: starts the nginx web server.
dpkg: error processing package nginx-core (--configure):
 installed nginx-core package post-installation script subprocess returned error exit status 1
dpkg: dependency problems prevent configuration of nginx-full:
 nginx-full depends on nginx-core (>= 1.18.0-6.1+deb11u5); however: 
  Package nginx-core is not configured yet.
 nginx-full depends on nginx-core (<< 1.18.0-6.1+deb11u5.1~); however:
  Package nginx-core is not configured yet.

dpkg: error processing package nginx-full (--configure):
 dependency problems - leaving unconfigured
Errors were encountered while processing:
 nginx-core                                                   #报错1
 nginx-full                                                   #报错2
E: Sub-process /usr/bin/dpkg returned an error code (1)

root@mciserver:~# dpkg --remove --force-remove-reinstreq nginx-full            #针对报错2解决
(Reading database ... 18515 files and directories currently installed.)
Removing nginx-full (1.18.0-6.1+deb11u5) ...
root@mciserver:~# dpkg --remove --force-remove-reinstreq nginx-core             #针对报错1解决
(Reading database ... 18511 files and directories currently installed.)
Removing nginx-core (1.18.0-6.1+deb11u5) ...

####################################################################
root@mciserver:~# apt remove -y nginx                           #再次删除即可
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
Package 'nginx' is not installed, so not removed
The following packages were automatically installed and are no longer required:
  fontconfig-config fonts-dejavu-core libdeflate0 libfontconfig1 libfreetype6 libgd3 libgeoip1 libjbig0
  libjpeg62-turbo libnginx-mod-http-auth-pam libnginx-mod-http-dav-ext libnginx-mod-http-echo
  libnginx-mod-http-geoip libnginx-mod-http-geoip2 libnginx-mod-http-image-filter
  libnginx-mod-http-subs-filter libnginx-mod-http-upstream-fair libnginx-mod-http-xslt-filter
  libnginx-mod-mail libnginx-mod-stream libnginx-mod-stream-geoip libnginx-mod-stream-geoip2 libpng16-16
  libtiff5 libwebp6 libxpm4 libxslt1.1 nginx-common
Use 'apt autoremove' to remove them.
0 upgraded, 0 newly installed, 0 to remove and 5 not upgraded.
```
### 常见问题
1、cat /proc/fault_events,可以看到文件系统是否有损坏的问题      #文件系统（如 ext4）当前未检测到错误
 dmesg -T| grep -iE 'error|fail|module|hardware' | tail         #这里可以看到系统异常重启，可能是加载内核模块的问题
2、 file flags /flæɡ/  
最基础含义：旗子；旗帜（如国旗、信号旗等）  （电脑 / 文件系统中）标志；标记；属性（如你之前遇到的 "file flags" 即 “文件属性标志”）。  
chattr: Operation not supported while reading flags on /data/lxc_container/data/0   出现这个问题。 df -T /data/lxc_container/data/0  
```root@mciserver:~# df -T /data/lxc_container/data/0
Filesystem     Type      1K-blocks     Used Available Use% Mounted on
dufs           dufs.dufs 222778080 40315948 171072796  20% /data/lxc_container/data/0            #可以看到dufs配置，卸载dufs服务后，再次尝试即可

```
3、 lsof   
lsof /dev/msi_gps             #可以看到占用这个文件的进程有哪些    
4、time 统计时间  
nohup 统计时间：  
nohup bash -c 'time sh upload_batch.sh -h ip.txt -s uptime' >output.log &  
5、readlink 用法
```
ln -s $(readlink container_mgr) container_mgr.bak
ln -sf container_mgr.1.5.conf container_mgr
ln -sf $(readlink container_mgr.bak) container_mgr
```
6、sed 清理空白行
sed -i 's/^[[:space:]]*//g' daishuai.txt    #11.33.8.76  变为  11.33.8.76    

sed '/^[[:space:]]*$/d' 文件名  #删除所有空白行（行首到行尾全是空白）    

grep '[[:space:]]' 文件名      #查找包含空白的行：    

#如果只需要删除空行，保留原有格式（不处理空格），可以简化为：sed '/^$/d' daichuli_ip.txt > no_empty_lines_ip.txt  
```
其他常见的预定义字符类可以辅助记忆，比如：
[[:digit:]]：匹配数字（digit 是 “数字”）
[[:alpha:]]：匹配字母（alpha 是 “字母”）
[[:alnum:]]：匹配字母 + 数字（alnum = alpha + num）
它们的格式都是 [[:xxx:]]，功能与 xxx 的英文含义直接相关，[[:space:]] 同理。
```

7、 复制 调试  
```shell
禁止：不让复制的调试
控制台输入：
document.designMode = 'on'
```
8、两种按行输出的方式echo 和printf  
echo 10.40.68.{49..58} | tr ' ' '\n'
printf "%s\n" 10.40.68.{49..58}
9、 maxdepth  
find /data/lxc_volumns -maxdepth 1 -name 'system' -type d
10、 findmnt  
findmnt -t ext4    # 查找所有 ext4 文件系统
findmnt -t overlay # 查找所有 OverlayFS 挂
findmnt /data   #直接查看  
11、 linux 内核查看文件
cat /proc/version  
12、 losetup -a 的作用
它会列出系统中当前所有 loop 设备 及其挂载源文件。  
例如：/dev/loop6: [45829]:4587542 (/data/lxc_volumns/super_f2fs_aosp12_rk3588_base_2.46.0.mcir5.base_0701_1530_1.img)  

13、 diff
#提示： 当物理机的一个文件时间戳 和 云手机中的时间戳 不同，并不代表他们没有被rsync 。可能是内容一致。
diff 参数 -y -q                #-q：只报告不同的文件  -y 2列看差异，    
```
root@mciserver:/data/lxc_container/data/0/local/tmp# diff -q md6.txt md6.txt2
root@mciserver:/data/lxc_container/data/0/local/tmp# diff  md6.txt md6.txt2
root@mciserver:/data/lxc_container/data/0/local/tmp# vi md6.txt
root@mciserver:/data/lxc_container/data/0/local/tmp# diff -q md6.txt md6.txt2
Files md6.txt and md6.txt2 differ
root@mciserver:/data/lxc_container/data/0/local/tmp# diff  md6.txt md6.txt2
119c119
< dfa6975e8687fd7d606e8d7924eb84db72            # <代表为左边的文件多一行。
---
> a6975e8687fd7d606e8d7924eb84db72                 #代表为右边的文件

例如：0a1,8             #代表：右边的多件多一行。 左边文件第0行开始，右边文件比左边 1-2行多了如下行
> VM010110004081
> VM010110004082
```  
14、 comm
comm -13 已排序的文件1 已排序的文件2          #结果是排除文件2中，和文件1共同的内容后。 只输出文件2 独有的内容。
comm -3 已排序的文件1 已排序的文件2        #得出文件1 和文件2 有差异的结果。
comm -12 已排序的文件1 已排序的文件2        #得出文件1和2 共同的内容。  
15、 find+grep 过滤文件内容
```shell
 find /data -type f |grep -rl dropbear  #用于过滤出文件内容中包含dropbear的文件，即：/data/.mci/dropbear_service。       
 或者：find /system -type f |xargs grep -rl dropbear       #可以看到：/system/xbin/dropbear_service  以及rc 文件。           注意：我们需要的是rc 的配置。
 cat /data/.mci/dropbear_service               #当然这个文件也有可能是空的。 那一版就需要手动去启动了
 #可以看到如下配置：    
 SSHD_PORT=`getprop ro.sshd.port 62485`
 /system/xbin/dropbear -p $SSHD_PORT -A -j -e -k -R  /data/.ssh/authorized_keys -r /data/.ssh/dropbear_rsa_host_key
 上面有个变量为：$SSHD_PORT 。获取方式为getprop
 #经过find 和grep 过滤出该文件出现在： 最好是 find         /data  /vendor/ /odm/ /system    都尝试下，这样速度会更快一点 
 cat /vendor/build.prop |grep ro.sshd.port                 #经过测试该文件中的ro参数都可以通过getprop 得出。  /system/build.prop 也可以，经过测试其他文件都可以这样获取。
ro.sshd.port=62485 -p 22
#################手动启动dropbear 以及解决无法启动成功的问题。
1、思路：去正常机器查看下22 或者 62485 端口。  例如：dropbear -A -F -e -j -k -R /data/.ssh/authorized_keys -r /data/.ssh/dropbear_rsa_host_key -p 62485 -p 22   #这个去rc配置中找
2、进入异常设备执行： /system/xbin/dropbear -A -F -e -j -k -R /data/.ssh/authorized_keys -r /data/.ssh/dropbear_rsa_host_key -p 62485 -p 22   && echo $?    
3、若执行不成功，则 ls -lrt /data/.ssh/authorized_keys  ls -lrt /data/.ssh/dropbear_rsa_host_key          #一般是这2个文件为空了。去其他正常的设备cp一份即可。 
4、copy思路：find /data -type f -name dropbear_rsa_host_key|xargs ls -lrt            #直接执行这个即可。
root@mciserver:~# find /data -type f -name dropbear_rsa_host_key |xargs ls -lrt
-rw------- 1 root root   0 Jul 31 23:42 /data/lxc_container/data/1/.ssh/dropbear_rsa_host_key                               #替换
-rw------- 1 root root   0 Jul 31 23:42 /data/local/acb-dufs/dufs-dir/remote/VM010251230030/.ssh/dropbear_rsa_host_key          #替换
-rw------- 1 root root  96 Jul 31 23:42 /data/local/acb-dufs/dufs-dir/cache/home/VM010251230030/.ssh/dropbear_rsa_host_key
-rw------- 1 root root 805 Aug  4 16:15 /data/lxc_container/data/0/.ssh/dropbear_rsa_host_key
5、替换后重新执行命令即可成功。
##################
```
16、apt源  
apt-update 不成功，也可以apt install 下载
#该错误信息 “E: The repository 'https://mirrors.tuna.tsinghua.edu.cn/debian bullseye - backports Release' does not have a Release file.” 表示从清华大学镜像源获取 Debian 的 bullseye - backports 仓库的 Release 文件时失败，通常是因为相关仓库已停止维护。
17、 windows 清理dns缓冲  
ipconfig /flushdns  
18、 md5值**windows**校验  
打开cmd：  
certutil -hashfile C:\Users\wangyulong\Downloads\zboot-rk3588_android12_2.9.0.lxc_0422.img md5
19、 windows-**powershell**-md5校验  
Get-FileHash -Path system_backup.tar.gz  -Algorithm MD5  
20、修改时间，时区问题  
linux一切皆文件
```
手动修改时区（适用于无 systemd 的老系统）系统没有 timedatectl（极少数情况），可手动修改时区符号链接

ls -l /etc/localtime
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

结果：root@mciserver:~# ls -l /etc/localtime
lrwxrwxrwx. 1 root root 34 Apr  3 06:50 /etc/localtime -> /usr/share/zoneinfo/Asia/Hong_Kong
```
```
date 查看时间
timedatectl    #查看时间以及时区
timedatectl list-timezones | grep Asia/Shanghai  #过滤上海时区
timedatectl set-timezone Asia/Shanghai   #设置为中国上海时区
timedatectl   #再次查看时间以及时区

```
` getprop | grep timezone  #虚机过滤时区`
21、  paste命令  
#主要功能是按列合并多个文件的内容，默认用制表符分隔列。它的用法灵活，既可以处理单个文件，也能合并多个文件，还能自定义分隔符。  
eg：sh data_batch.sh -h ip.txt -s "paste -d '|' /sys/devices/platform/fe330000.sdhci/mmc_host/mmc1/mmc1:0001/life_time /sys/devices/platform/fe330000.sdhci/mmc_host/mmc1/mmc1:0001/pre_eol_info"
多文件：paste f1 f2 → 按列合并，适合对齐数据。
单文件：paste -s f1 → 多行转单行，适合串联内容。
自定义分隔符：-d 选项可替换默认制表符，适应不同格式需求。
##一行用逗号展示：    
[mci_opert@XJP-10.4.50.1 wangyulong]paste -sd ',' ip.txt               #-s：将所有行合并为一行。-d ,：用逗号 , 作为分隔符。多行 md5sum 结果会被 逗号分隔 拼接成一行输出
11.17.2.30,11.17.2.14
```
[device@zc-10-6-42-115 tmp]$ cat test.sh
f
23
445

[device@zc-10-6-42-115 tmp]$ paste -s test.sh
f	23	445

[device@zc-10-6-42-115 tmp]$ paste test.sh test.sh
f	f
23	23
445	445

[device@zc-10-6-42-115 tmp]$ paste -sd , test.sh
f,23,445

[device@zc-10-6-42-115 tmp]$ paste -sd "|" test.sh
f|23|445
```
22、awk 的求和命令
[device@zc-10-6-42-115 wangyulong]$ cat vm.ip |awk '{sum += $2}END {print sum}'
127

```shell
#paste 的用法
[device@zc-10-6-42-115 linshi]$ cat file1.txt file2.txt
apple
banana
cherry
red
yellow
pink
[device@zc-10-6-42-115 linshi]$ paste file1.txt file2.txt
apple	red
banana	yellow
cherry	pink
[device@zc-10-6-42-115 linshi]$ paste -d "|" file1.txt file2.txt
apple|red
banana|yellow
cherry|pink

```
22、 ncdu命令  
du -sh 某些目录。由于下面的小文件太多，导致无法直接读取，可以使用ncdu更加快捷
eg：
![ncdu](https://github.com/linuxlaowang/tuchuang/blob/master/nodes/F8ECB676-D48E-4F53-879F-4DF5EF42BC30.JPG?raw=true)  
```
#当出现play保护机制的问题，可以执行该命令：绕过或关闭用户对于应用包验证的确认提示：settings put global package_verifier_user_consent -1  （重启会失效）

```
23、
## 支持人员
```
apass 平台（百度云手机前台）：RD 王萌  吕抒钰
张锦辉： 云手机sdk开发问题。
推流问题： 思民、万钊
toc海外授权问题报错（9692051）：杨杨，潘利才
@张锦辉 处理：授权无法加载到客户的红手指。
gps定位不协同问题：lsof /dev/msi_gps  #看是否只有remote-play调用           找陈思民 和陈娇
值班支持人员：toc先找朱坤、tob找黄陈养
朱坤处理的是：镜像、虚机问题。      
   吴强解决的是：arm设备上服务的问题
   若是发现arm设备端未从服务端正常接收信息，找刘庭（红手指后台：国内主营）
   以及客户端推流等问题、 王辉（红手指后台：国外主营）
adb问题：若自检无问题，用户反馈，可以找：江城  
nfv 推流问题：刘俊云。可能存在（pass侧是物理网络，需要去pass侧检查推流方式，实际使用的虚机推流：pass侧为nfv 的映射。@王辉 帮清下会话。处理后正常。）
--播放失败：282254.通过客户端日志，可以看到：连接报错：nfvzc5003.armvm.com 5507 onDisconnected   。联系刘俊云。
推流：
关于tob 设备连接云手机推流问题：锦辉 去测试下客户端 连接推流后，才可以看到日志中的关键词。

客户端中： 点击一键新机：报错：正在更新，请稍等一会儿使用功能。提示：被授权的是不支持一键新机，但是云手机内下载扩展服务是可以操作的。后续反馈：设备里的一键新机插件不可用，需要找杨福志同学帮忙看看。可以联系 李伟，叶志东 
针对：红手指客户端问题，可以联系 肖强强、叶志东，姚泽彬， 蔡振斌 ，孙朗(李伟--客户端RD) ，可以解决红手指国内外客户端问题； （一键新机、潘利才、江城、甘振杰、刘庭、吴成锦、杨杨、王蔚宏（杨平平--后端）服务端）  
客服系统、客户页面无法加载，报错19001，ERP信息面板：杨扬、王蔚宏

TOB上传apk后。，后台没有安装包：显示上传成功，但是解析失败。        ----这种问题找  刘庭、志伟查看相关服务是否正常。

云手机跳出： 桌面快捷程序  可以找 李伟，孙朗，叶志东：桌面只是透传消息，客户端接受消息处理，这个在客户端上应该是有次数限制的配置控制，@王宪鹏 产品判断一下是否需要关闭线上的开关处理。
            云机安装完应用，回到桌面，就发透传消息，这个是用户无感知触发的
 红手指客户端：目前PC普通版和专业版进入收银台会出现报错提示404。  PC专业版营销工具界面打开是空白的 我们自己账号打开也是一样的------郭加辉，杨名雄。 黄林 可以提供url
          收银台是 nginx 转发有问题，回退处理了；营销工具目前回退了 h5，暂未确定原因 -------甘振杰
需要关掉谷歌安全防护的, 可以联系 郝竟伊 

settings put global package_verifier_enable 0
settings put global package_verifier_user_consent -1



###游戏
 冒险岛世界，辅助搬砖帝
  夜鸦
  时空猎人
  无尽冬日

```
24. 分析高占用内存、cpu，导致oom 异常的问题.通过ps 查看主进程，在查看子进程号。
  ![内核占用进程分析](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/%E5%86%85%E6%A0%B8%E5%AD%90%E8%BF%9B%E7%A8%8B%E5%8D%A0%E7%94%A8%E5%88%86%E6%9E%90.PNG?raw=true)
## wsphone_nodes
1. 提示：settings命令主要用于在 Android 系统中读取、修改或者删除系统设置；getprop命令用于查询 Android 系统的属性
```
:/ # settings list global |grep hide              #该命令的作用是列出系统全局设置中的所有参数。
hide_navigation=1                                 #这一结果表明当前系统已将导航栏隐藏

:/ # settings delete global hide_navigation
Deleted 1 rows                                     #将其删除并不能将其默认打开。需要设置为0

settings put global hide_navigation 0                    #设置其为0
```
2. 进入云手机后，ls /sdcard 发现没有该目录。  执行：dg config -r prop  ，可以看到是否恢复了。需要重启生效后查看
3. 如何区分 tob toc 的remote-play 进程：
```
toC的remote进程 有一个rtmp地址.  remote-play rtmp://10.0.88.8:1931/live/ 10.6.194.201:9916 5 VM010055230079 2 console          #这里10.6.194.201:9916 是控制服务的ip:端口。
toB的remote进程 有一个8800的监听端口参数    remote-play 8802 5 VM010245191013 2 console /data/local/tmp/sun_remote_2
1. tob 有VMBroker 进程，toc 没有。 toc 进行bc 融合的设备也没有这个进程。
2. 推流等级修改：
root@mciserver:~# cat /data/local/container/manage.conf |grep -i video_bitrate
Video_BitRate=4096,2048,1024,512,512,512                        #rate。 改完后，重启remote-play即可。
1. wss 协议开头的域名： 一般指的是推流服务： 控制服务或者是 p2p 推流域名地址。
2. 推流模式remote-play日志查看，过滤remote-play日志onListen关键字：
1、有Direct是tcp-p2p
2、有Direct和WS是webrtc-p2p
3、没有Direct是控制服务
1. 切换一键新机状态需要重启manage-agent生效
2. cat manage-agent.log.20250908 |grep getConfig         #应该可以看到获取到的配置。可以看到获取的结果那些有问题，例如：不支持23这样的掩码。支持的是点分十进制。
3. cat manage-agent.log.20250908 |grep  xxx          #可以过滤各种 任务id。查看具体的信息等。

```
3. 关于客户挂vpn导致的问题：1个是隧道vpn 第二个是挂代理vpn
```
海外TOB 设备，pc端：上传或者下载图片失败的问题：
调试如下：同网段设备可以，保障设备不可以
curl --connect-timeout 10 --max-time 600 -o /data/local/tmp/1.jpeg "http://10.4.50.99:8808/api/v1/yp-download/2025-11-18/yunpan-af78e4b4-cf45-4448-96be-3bc35bf65fd0.jpeg"
```
排查思路
```
ip a             #可以看到有隧道ip        
ip route         #可以看到路由。 服务端未放通导致的
```
4. dg dump proxy         #可以查看是否有代理
  * 查看代理ip： dg config output proxy.host
    * 删除代理ip： dg config -r proxy                        #现象：进入设备可以ping通baidu.com 。但是进入云手机访问百度：网络却不通。发生这种问题后，查看代理即可。去掉即可恢复
  这里就会出现一个关于线上：无法解析域名的问题。
  若设备启用了代理，系统可能会自动使用代理服务器指定的 DNS（例如： 221.179.155.193）；
执行：删除代理后即可恢复。
#具体排查方法：
```
dumpsys dnsresolver | grep 'DNS servers' -A 1 | head -n 2 | tail -n 1 | awk '{print $1}' #获取dns
可以用获取到的dns去arm物理机去测试该dns是否可以解析域名
安装工具

     #安装报错nginx 的错误。无法解决，需要卸载掉nginx或者重装。
若报错：
Errors were encountered while processing:
 nginx-core
 nginx-full
E: Sub-process /usr/bin/dpkg returned an error code (1)
#执行如下命令即可安装
dpkg --remove --force-remove-reinstreq nginx-full
dpkg --remove --force-remove-reinstreq nginx-core
##
dig @221.179.155.193 www.baidu.com           #使用该dns解析baidu.com

dig @10.255.255.240 www.baidu.com          #这个dns 是可以正常解析的。
```

1. android系统上的挂载重试：
```
#!/system/bin/sh
#version 1.0.1
MOUNT_SUCCESS=false
XPROP_USED=false

if mount -o remount,rw /system 2>/dev/null; then                                    #检查 remount 是否成功
    MOUNT_SUCCESS=true
else
    # 首次挂载失败后尝试xprop
    if command -v xprop >/dev/null 2>&1; then
        if xprop ro.mount.rw_disable false >/dev/null 2>&1; then                  #remount 失败后，执行xprop后再次尝试挂载即可。 
            XPROP_USED=true
            # 二次尝试挂载
            if mount -o remount,rw /system 2>/dev/null; then
                MOUNT_SUCCESS=true
            fi
        fi
    fi
fi
```
3.  printf "  %s\n" "${existing_files[@]}"                   #printf 是用于格式化输出的命令  
" %s\n" 是格式化字符串：
表示输出两个空格
%s 是占位符，用于替换为字符串
\n 表示换行  
"${existing_files[@]}" 表示数组existing_files中的所有元素。
补充： ${#existing_files[@]} ：数组 existing_files 中元素的个数
4. 直接用/data/local/container/.ssh/authorized_keys 把 /data/lxc_container/data/?/.ssh/authorized_keys 覆盖一遍就行了。这个可以直接使用。ssh连接虚机。
5. PCDN限速回验网速：
```
cd /data/local/logs/bitcap_log/ 下： 
grep Mbps bitcap.20250714.log         #可以直接看到最新的日志中的up speed 和 down speend 的速度。
最新的日志单位可能降到了kbps 
grep Kbps bitcap.20250714.log
```
6. overlay 挂载的研究
```
root@mciserver:~# ls /data/lxc_volumns/super_upper_2/overlay/system/app/GoogleWebview
/data/lxc_volumns/super_upper_2/overlay/system/app/GoogleWebview
root@mciserver:~# rm -rf /data/lxc_volumns/super_upper_2/overlay/system/app/GoogleWebview

root@mciserver:~# ls -lrt /data/lxc_volumns/super_2/system/app/GoogleWebview/
ls: cannot access '/data/lxc_volumns/super_2/system/app/GoogleWebview/': No such file or directory

root@mciserver:~# reboot

root@mciserver:~# ls -lrt /data/lxc_volumns/super_2/system/app/GoogleWebview/
total 217316
drwxr-xr-x 4 mci mci      3452 Aug 20 21:56 lib
-rwxr-xr-x 1 mci mci 222304918 Aug 20 21:56 base.apk


或者：直接重新挂载
umount /data/lxc_volumns/super_0
mount -t overlay overlay_super_0 -o rw,relatime,lowerdir=/data/lxc_volumns/super,upperdir=/data/lxc_volumns/super_upper_0/overlay,workdir=/data/lxc_volumns/super_upper_0/overlay-workdir /data/lxc_volumns/super_0

upperdir 为读写层 优先级高于 只读层。 当2层都有：system/app/GoogleWebview     的情况下，读写层是优先的。
#案例1：删掉只读层的目录。不会影响super_? 下面的内容（即使重新挂载，因为读写层还存在）
#案例2：删掉读写层GoogleWebview目录。会发现super_? 下的内容都会消失，无法直接读取只读层的目录。需要重新挂载后，可以获取到只读层的内容，这种方式为了节省磁盘空间
#案例3：在案例2的基础上，再删掉只读层的目录。会立即发现：super_? 下面的GoogleWebview目录 会直接丢失。
#案例4：删除了只读层的GoogleWebview目录。然后安装super_?下面的GoogleWebview，会提示GoogleWebview目录不存在的问题
data/lxc_volumns/super_0//system/app/GoogleWebview': No such file or directory

结论：
1、明明目录存在，但是报错，是因为底层目录没有了。会直接安装到读写层。但是需要重新挂载生效
2、为了后期避免这各类问题，我们在super 以及 super_? 都安装即可。
也就是说：
a. 脚本安装出错：ls -lrt /data/lxc_volumns/super//system/app/GoogleWebview/     #GoogleWebview 目录需要存在
b. 看读写层是否存在。读写层存在，reboot或者umount后生效。
c. 手动mkdir -p 目录后并reboot后，再次安装即可。

```

```
root@mciserver:~# ls -lrt /data/lxc_volumns/super/system/app/GoogleWebview/
total 217316
drwxr-xr-x 4 mci mci      3452 Aug 20 21:56 lib
-rwxr-xr-x 1 mci mci 222304918 Aug 20 21:56 base.apk
root@mciserver:~# touch /data/lxc_volumns/super/system/app/GoogleWebview/1.txt
root@mciserver:~# ls -lrt /data/lxc_volumns/super/system/app/GoogleWebview/
total 217316
drwxr-xr-x 4 mci  mci       3452 Aug 20 21:56 lib
-rwxr-xr-x 1 mci  mci  222304918 Aug 20 21:56 base.apk
-rw-r--r-- 1 root root         0 Aug 20 22:25 1.txt


root@mciserver:~# umount /data/lxc_volumns/super_2
root@mciserver:~# mount -t overlay overlay_super_2 -o rw,relatime,lowerdir=/data/lxc_volumns/super,upperdir=/data/lxc_volumns/super_upper_2/overlay,workdir=/data/lxc_volumns/super_upper_2/overlay-workdir /data/lxc_volumns/super_2

root@mciserver:~# ls -lrt /data/lxc_volumns/super_2/system/app/GoogleWebview/
total 217316
drwxr-xr-x 4 mci  mci       3452 Aug 20 21:56 lib
-rwxr-xr-x 1 mci  mci  222304918 Aug 20 21:56 base.apk
-rw-r--r-- 1 root root         0 Aug 20 22:25 1.txt

root@mciserver:~# ls -lrt /data/lxc_volumns/super_upper_2/overlay/system/app/GoogleWebview
ls: cannot access '/data/lxc_volumns/super_upper_2/overlay/system/app/GoogleWebview': No such file or directory

#但是touch到目录2.txt ，这个就会存在
root@mciserver:~# touch /data/lxc_volumns/super_2/system/app/GoogleWebview/2.txt
root@mciserver:~# ls -lrt /data/lxc_volumns/super_upper_2/overlay/system/app/GoogleWebview
total 0
-rw-r--r-- 1 root root 0 Aug 20 22:28 2.txt
#但是删除
root@mciserver:~# rm -rf /data/lxc_volumns/super_2/system/app/GoogleWebview
root@mciserver:~# ls -lrt /data/lxc_volumns/super_upper_2/overlay/system/app/GoogleWebview
c--------- 2 root root 0, 0 Aug 20 22:28 /data/lxc_volumns/super_upper_2/overlay/system/app/GoogleWebview          #这个目录会变成C，字符设备文件。这是一个无效的字符设备文件，而非正常目录，建议直接删除它，然后重新检查 overlay 挂载：
overlay 的核心规则是 “上层优先”：
#综上，由于upperdir 的存在，只要这个与lowdir同级存在相同目录，则会造成优先读取upperdir 的。所以看不到lowerdir 的修改。但是删除了upperdir 的上一层目录，并reboot或者重新挂载，就可以读取到lowdir 的修改了。
#当然，就算重新挂载了。overlay 的内容也不会被lowdir 覆盖。因为upperdir 非下面说的tmpfs，所以说重启后还是存在的。
################################
#如果 upperdir 和 workdir 位于持久化存储（如硬盘、分区）：
重启后不会消失。因为修改都保存在 upperdir 中，重启后重新挂载 overlay 时，会重新合并 lowerdir 和 upperdir，之前的修改会保留（如你在 super_0 中创建的文件）。
如果 upperdir 和 workdir 位于临时文件系统（如 tmpfs、内存盘）：
重启后会消失。临时文件系统的数据存储在内存中，重启后内存清空，upperdir 中的修改会丢失，挂载点会恢复为 lowerdir 的原始状态。
#######################################
lowerdir	只读基础层，提供原始文件
upperdir	可写层，存储修改内容
workdir 	临时工作区，内部使用（不可以修改）
简单说：lowerdir 是 “源头”，upperdir 是 “个性化修改”，workdir 是 “幕后工具人”，三者分工明确，共同实现了 overlay 的 “分层合并” 功能。

#故后续安装apk，要都安装才不会出问题。

overlay 的挂载方式：
umount /data/lxc_volumns/super_1
mount -t overlay overlay_super_1 -o rw,relatime,lowerdir=/data/lxc_volumns/super,upperdir=/data/lxc_volumns/super_upper_1/overlay,workdir=/data/lxc_volumns/super_upper_1/overlay-workdir /data/lxc_volumns/super_1
```
7. 去掉应用市场步骤
```
包名：com.android.market
pm path com.android.market
/data/lxc_volumns/system_0/app/AppStorePaasOEM/base.apk                这个是 应用市场。
```
8. TOB关于json文件转换为csv的方法（json 对象如何通过jq 转为csv）
   首先通过F12调试，获取json 文件。点击后会获取，先清除。
   例如：json文件
   [
  {"name": "Alice", "age": 30, "city": "New York"},
  {"name": "Bob", "age": 25, "city": "London"},
  {"name": "Charlie", "age": 35, "city": "Paris"}
]
转换命令：jq -r '(.[0] | keys_unsorted) as $keys | $keys, map([.[ $keys[] ]])[] | @csv' data.json
解释：
(.[0] | keys_unsorted) as $keys：获取第一个对象的所有键作为表头
$keys：输出表头
map([.[ $keys[] ]])[]：将每个对象的值按表头顺序排列
@csv：将结果格式化为 CSV

例如：JSON 包含嵌套结构
[
  {"user": {"name": "Alice", "age": 30}, "address": {"city": "New York"}},
  {"user": {"name": "Bob", "age": 25}, "address": {"city": "London"}}
]
如果 JSON 包含嵌套结构，需要显式指定要提取的字段：
jq -r '["name", "age", "city"], (.[] | [.user.name, .user.age, .address.city]) | @csv' data.json

-r：输出原始字符串，避免 JSON 格式的引号转义
(.[] | ...)：遍历 JSON 数组的每个元素。前提：输入的 data.json 必须是JSON 数组结构（如 [{}, {}, {}]），否则该命令会报错。[] 表示 “取 JSON 数组的所有元素”，| 是 jq 的管道符，意为 “将数组的每个元素依次传入后面的处理逻辑”。
@csv：jq 的内置函数，用于将数组转换为 CSV 格式

   

### 私有化上架流程
```
一、预备阶段
1、登录vpn后，查看pass服务清单，登录pass后台。 可以借鉴 公有云上架流程文档
2、查看工单中上架型号、以及上架的云手机ip
3、pass后台查看云手机ip，看是否有这个网段存在，防止冲突。 没有则继续看上架流程。以及设备型号，上架多少ip，网段是否够。
二、工程阶段
1、开始上架：看工单确定设备的最大虚机数，在（pass后台）基础设置-设备配置                ？疑问：这里能设置多次吗，这次和上次设置开数的区别是什么。
2、pass后台：物理设备--------新增 ：  
    设备编码：一般填客户的首字母即可。例如：JSQ          
    设备ip、型号、系统版本：批量新增，指的是arm设备。型号、版本都可以从工单中获取。
    虚机设备开始ip：要看工单中指定的私有化ip网段。  例如：172.17.124.0/23           
    网关 掩码：都要填写工单中的私有化： 虚机ip的网关、掩码               #########注意：掩码不能填数字，需要用ip4位的格式。例如23位掩码：255.255.254.0 
3、上架后，可以点击查询即可看到上架后的设备ip，虚机ip 了以及对应的 开数。
4、bmcip 需要sql去更新即可。  物理设备，可以看到目前管理口ip为空，现在用下面的sql上架后再次查询即可。
5、千万不要忘记还有一步：静态ip下发
select pad_code from rf_pad rp,rf_device rd where rp.device_id=rd.device_id and substring(device_ip from '\d+.\d+.\d+.') in ('11.37.11.','11.37.12.');              #查询pad_code，私有化上架查，记得进入对应的库：redfinger_paas，以及注意最后要有 分号；不然不会生效，导致后续会出现问题。
#导出命令1
#COPY  (select pad_code from rf_pad rp,rf_device rd where rp.device_id=rd.device_id and substring(device_ip from '\d+.\d+.\d+.') in ('172.17.121.')) TO '/home/postgres/outpu.txt';  可以copy到物理机设备上
#导出命令2
psql -U 用户名 -d 数据库名 -Atqc "SELECT pad_code FROM rf_pad rp, rf_device rd WHERE rp.device_id=rd.device_id AND substring(device_ip from '\d+.\d+.\d+.') IN ('172.17.121.')" > output.csv
例如：/opt/pgsql-12.11/bin/psql -d redfinger_paas -Atqc "SELECT pad_code FROM rf_pad rp, rf_device rd WHERE rp.device_id=rd.device_id AND substring(device_ip from '\d+.\d+.\d+.') IN ('172.17.122.')" > 122_output2.txt 

工程：静态ip下发（多个段可以一起操作）
云手机配置：通过pass后台也可以导出pad_code后， 
云手机配置-----修改是否启用静态ip： 填是，加上padcode即可             --------------完成上架。绑定了私有化ip后就不用绑定mac了。私有化是这样。

私有化上架bmc的方法：
select bmc_manage_port_ip from rf_device where substring(device_ip from '\d+.\d+.\d+.') in ('10.1.10.');
·
UPDATE rf_device SET bmc_manage_port_ip='172.26.0.211' WHERE substring(device_ip from '\d+.\d+.\d+.') in ('10.1.11.');
```
```
上架私有化刷机：#更改manage-proxy地址以及ftp地址和密码
sed -i 's/^FTPUrl.*/FTPUrl=ftp:\/\/10.10.8.252:21/' /data/local/container/manage.conf
sed -i 's/^UserPwd.*/UserPwd=private-cloud:ed323paasF/' /data/local/container/manage.conf
sed -i 's/^Server.*/Server=10.10.8.252:7918/' /data/local/container/manage.conf
#检验是否更改
cat /data/local/container/manage.conf|egrep '^Server=|ftp|UserPwd'
```
#最后记得要 授权云手机，否则lxc-ls -f 无任务输出。 授权后，云手机会被自动拉启。
### 公有云上架注意
```
公有云上架注意事项：

1、 3588 上架掩码为啥是22？

由于公有云3588，上架为7开----96片。   96*7=672个虚机ip。
利用子网掩码计算器可以得到：
掩码22：255.255.252.0        ---有：1022 可用ip
掩码23：255.255.254.0        ---有：510 可用ip ，显然22才会符合要求。
但是：以192.168.0.0 为例
22位可用ip：192.168.0.1--------192.168.3.254
672个ip。其中除去广播地址255外。第672个ip为：192.168.2.164   正好第三个段会被浪费。但是没有办法
即：
192.168.0.1-192.168.0.254（254个）、192.168.1.1-192.168.1.254（254个）、192.168.2.1-192.168.2.164（164个） 254+254+164=672


2、模板在： 桌面，名称叫： 物理机录入模板，白色标注为无须改动的地方。
系统版本：默认用android10.op-agent 部署后会自动上报。
虚拟设备开始ip：都是从1开始。具体可以查询上一个物理网段的虚机ip用到了哪里。
设备管理节点，可以去 grafana ：看到proxy节点id。
掩码只支持点分十进制

3、物理机录入模板后报错：物理机不存在找陈思。 类似bmc地址、物理机型号等都是从资管平台同步过来的

4、不要忘记：启用静态ip。

5、不要忘记：完成后，需要将内容提交到工单中。网络根据自己配置的上架信息 需要配置。可以参考https://console.cloud.baidu-int.com/devops/icafe/issue/ARM-ITIL-01-1363/show?source=copy-shortcut

6、如果是没有了网段。需要申请。可以参考：https://console.cloud.baidu-int.com/devops/icafe/issue/ACSI-6069/show?source=copy-shortcut
```

### 刷机：运管平台常见到的问题
1、  常见错误1：物理机脚本执行报错：内部服务通信失败，无非就是manage-agent 到 proxy 到 server 的问题。
paas-base-dg.armvm.com     manage-server服务。可以参考： https://console.cloud.baidu-int.com/devops/icafe/issue/ACSI-5297/show?source=drawer-header  
2、  常见错误2：遇到刷机后配置不符的，需要去arm-op-agent 去 过滤对应当时下发给arm设备的信息。大概率是资源包会覆盖掉-c 的配置文件。
3. 常见问题： 
   * 刷机rootfs报错超时：一般是 arm设备dns 的问题：2025-09-02T18:11:35.741+0800 [ERROR] [arm-op-agent/file_part_download_handler.go:1426] request 10.231.30.38 error, err: Post "http://10.231.30.38:1323/main-board-internal/download-info?nonce=1756807785560": context deadline exceeded (Client.Timeout exceeded while awaiting headers)  
   * 或者是网卡问题， ethtool -S 网卡名|grep error 
4. 
### 其他常见问题
1、调整CPU使用策略解除绑核，调整内存/swap使用优先级
```shell
解除绑核策略：
背景：单开挂虚拟机场景，光速虚拟机。用户测试我们的设备cpu跑不满8个核，是因为我们cpu策略绑大核了。物理内存使用最大只能到50-60%，就会用swap
综上背景，需要更改 cpu策略与swap策略如下：
1、物理机root镜像里的init.rc文件，以下都注释掉              # /data/lxc_volumns/root_?/init.rc
#write cgroup cpuset
write /dev/cpuset/foreground/cpuset.cpus 4-7
write /dev/cpuset/background/cpuset.cpus 0-3
write /dev/cpuset/system-background/cpuset.cpus 0-7
write /dev/cpuset/top-app/cpuset.cpus 4-7
write /dev/cpuset/camera-daemon/cpuset.cpus 4-7
调整内存/swap使用优先级：
1、固化操作，物理机container_$SN.conf增加lxc.cgroup.memory.swappiness=1        
# /data/lxc_container/container_?.conf  以及  /data/lxc_container/ro.container_?.conf    都需要改,否则reboot后，配置文件会被还原。
2、立即生效，虚拟机内：echo 1 > /dev/memcg/memory.swappiness
```

2、 ebtables 隔离策略清除问题
手动执行ebtables规则清除命令。 ebtables -F ，重启是会被pass还原  
需要： ebtables -F; rm /data/local/init_sh/paas_*  

pass侧隔离失败的一个问题：
  当一个arm物理机的虚机有2片属于公共池子，有2片分给指定用户，刷隔离会报错：虚机所属商户不唯一的问题。  移动到统一客户账号即可。分组不同是没有问题的。

3、这个是在启动CDN服务前 部署arm设备的的dufs原因
解决办法：每一片执行： /data/local/acb-dufs/acb-dufs.sh register-device  。#可以看到dufs报错，没有注册信息，dufs日志报错400。如下
```
 2025-08-0710：37：56.882 [ERR] /work/src/curl.cpp:RequestPerform(2391): HTP response code 400， returning EIO. Body Text: {"msg":"parameter max_nodes required for new machin
es. could not continue","instance_id":"dufs-cdgames-000","ip":"10.4.156.1"}
```

4、网络问题定位  
当ssh概率卡顿，需要考虑网络侧是否存在了问题。即：可能模块存在问题（更换后未成功）。如下截图
![ssh虚机，概率会卡着](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/ssh-%E7%BD%91%E7%BB%9C%E5%AE%9A%E4%BD%8D.PNG)

5、 查看云手机patch 的apk路径  
dg apt show patch:bosszhipin|grep bosszhipin
dg dump patch |grep damai          #查看patch 的补丁包是否存在。
6、 查看云手机的apk及路径  
pm list packages  
pm path com.xxx
7、 apk 路径  
pm list packages -f |grep -i magisk                 #一般安装的apk的物理机路径为：/data/lxc_volumns/super_0/system/app/
package:/system/app/Magisk-v29.0/base.apk=com.topjohnwu.magisk  

root@mciserver:~# ls /data/lxc_volumns/super_0/system/app/Magisk-v29.0/     #/data/lxc_volumns/super_$sn/system   指定安装路径为这里后，会放到app下
base.apk  lib
8、 查看apk的详细信息  
dumpsys package com.topjohnwu.magisk
9、 查看云手机启动时间  
```
查看进程启动时间-----以此可以获取到云手机的启动时间。
eg: 
lxc-info -n 1
root@mciserver:/data/local/tmp/linshi# ps -p 5044 -o lstart         #这里查看 -o
                 STARTED
Sat Mar 15 18:36:49 2025                 #mar 为3月
获取进程pid：
pidof bitcap
######
或者：
ls -lrt /data/system/dropbox |grep -i boot          #为虚机启动时间，如果有文件，认为该云手机被启动过。
# 如何判断安装一个apk包的时间： dumpsys package com.instagram.android |grep -i first                   #可以看到关键词 firstInstallTime=  具体时间。  
从而可以判断出 安装包后，并未重启云手机的问题。
```
还可以用此方法查看   
```
logcat -b all |grep "boot completed"                    #-b all 表示同时查询所有日志缓冲区。也可以不加，默认仅查询 main 缓冲区
05-20 14:43:58.287   838   838 D BluetoothManagerService: Bluetooth boot completed
```
10、 logcat  
```
logcat *:E  #查看错误日志
# 清空现有日志后监听崩溃信息
logcat -c
logcat --pid=1234 
logcat -f /sdcard/log.txt
#logcat 的另外一个作用，可以看到刚才安装的包，在云手机中的包名。即：com开头的叫啥
例如：给客户安装新桌面，会给一个apk包。2步：1 安装apk 2改配置后重启
1|:/ # logcat |grep -i app-aosp               #app-aosp-release.apk   这个是apk包名
08-22 16:52:40.091   921   921 I PackageManager: /system/app/app-aosp-release changed; collecting certs
08-22 16:52:41.312   921  1097 W DGLog   : [AppInfoSnapshot] checkXModule() assets/xposed_init not found in the app: com.sh.launcher3(/system/app/app-aosp-release/base.apk)
2、reboot 后云手机，我们就可以通过 pm list packages 去过滤下
即：
:/ # pm list packages |grep -i com.sh.launcher3
package:com.sh.launcher3
:/ # pm list packages -f com.sh.launcher3
package:/system/app/app-aosp-release/base.apk=com.sh.launcher3             #可以直接看到包名的位置
3、改配置如下：
root@mciserver:~# cat /data/lxc_volumns/system_4/etc/business-conf.xml|grep -i launcher
    <combo key="settings.DefaultLauncher" enable="true">com.sh.launcher3/com.android.launcher3.Launcher</combo> 

    #其中的com.sh.launcher3/com.android.launcher3.Launcher     分别为包名/类名。需要解压apk查看。
```
11、 getprobe 过滤时区  
```
getprop | grep timezone  #虚机过滤时区
getprop |grep net     # 可以看到网关         #ro.net.provisioned.gw       ro.net.provisioned.ip      可以分别得到网关和ip地址
getprop |grep version.release #可以看到版本号等
```
12、 修改fps帧数  
将/data/lxc_volumns/super_$SN/vendor/build.prop中的60帧，需要改成30：（上次是system，优先级没有vendor高，被覆盖了导致没生效）
比如：msiq.display.config=720x1280@60,320
         msiq.display.config=720x1280@30,320
测试方法：  
查看帧率设置：`getprop msiq.display.config`
查看实时帧率：`setprop debug.display.show_fps true; logcat | grep do_post`  # 云机渲染帧率查看，拉起桌面,点击后会有数据出现。
13、 sdk日志位置  
/sdcard/Android/data/应用包名/files/log目录下的sw开头的文件，默认保留7天。
14、 查看分辨率日志  
``shell
#查看摄像头中的分辨率
过滤remote-play日志，camera和width就可以看到了
#回显如下：
[07 25 15:37:48.471 44813][CameraRemoteImpl]cameraInfo, RFVIDEO_GET_PIXFORMAT, width:1280, height:720, fmt:876758866

 摄像头不能指定申请分辨率 这是云机app回调给镜像HAL层 再到remote-play 最后返回到客户端的分辨率，云机app决定了摄像头的分辨率
 #上面这句话有待确认
 #所以说，一个是镜像版本要支持  二是改镜像配置文件即可。
 
 vendor/build.prop
camera.support.1080P=true
  加了camera.support.1080P=true
重启物理机生效了 这是交付时候没加的配置
``
15、 云手机命令1  
```
#查看刷的资源包版本
root@mciserver:~# cat /data/lxc_volumns/system_0/etc/.resource_package_version        #资源包（如果软件包支持写入版本） ： 云手机的 /system/etc/.resource_package_version
Thu Jul 10 12:46:25 HKT 2025
1.8.0.pg.mcir5.10.aochen_google.20250605

#查看谷歌商店是否存在：可以用  pm path com.android.vending
#查看分辨率 
 wm size     wm density   #查看dpi     dg dump display
#查看分辨率以及fps、dpi 
getprop msiq.display.config
```
物理机对应配置文件：cat /data/local/container/manage.conf
虚机对应配置文件：
android10：cat /data/lxc_volumns/vendor_*/build.prop|grep msiq.display.config
android12：cat /data/lxc_volumns/super_*/vendor/build.prop|grep msiq.display.config
###############################################查看fps，这个命令查看的当前的动态分辨率

dumpsys gfxinfo|grep -i "total frames"
Total frames rendered: 129
Total frames rendered: 542
Total frames rendered: 542
Total frames rendered: 832
Total frames rendered: 832
Total frames rendered: 0
Total frames rendered: 0
Total frames rendered: 0
Total frames rendered: 0
```
#查看时区
getprop | grep timezone
#查看桌面是否启动
ps -ef|grep launcher

提示：这里涉及到一个 云游戏安全桌面的卸载问题。安全桌面和原生桌面 二选一 
ps -ef | grep launcher          #卸载ishunwan的哪个包名的应用就可以.、
#且对应的配置文件是：/system/etc/business-conf.xml 里面的桌面配置。  ##launcher配置，无须更改。 settings.defaultLauncher 这个配置。
综上：卸载掉了云游戏桌面后，壁纸会直接变黑。需要恢复原样。恢复方法：
cd /data/system/users/0             #这个0 是固定的。   
rm -vf wall*           
am restart          #云手机将会重启，即可恢复。
```
15. 桌面打开应用时提示“不允许开启受限应用”时，将物理机/data/lxc_volumns/system/etc/business-conf.xml文件中<multiple key="common.AllowdActivityPackagesWhileRestrictStartActivity" enable="true">  改为false，重启虚拟机
16. 动态分辨率与物理机分辨率不一致会导致：错位的问题。具体查看以及修改的方法如下：
    * 特别注意：动态分辨率不要忘记看了。都是0 才是关闭。
    * 查看物理机层面：cat /data/local/container/manage.conf |egrep -i 'width|height|HWC_Enable|Lcd_density'
                    cat /data/local/container/screen-grab.conf |egrep -i 'width|height|HWC_Enable|Lcd_density'
    * 查看虚拟机层面：
                       安卓12：   cat /data/lxc_volumns/super_?/vendor/build.prop |egrep 'debug.display.use_external_display|msiq.display.config'
                       安卓10：   cat /data/lxc_volumns/vendor_?/build.prop|grep display

17. 当wm size 与 g  一致。 wm size 出现了2个不同的分辨率。不管名称是什么。只要按照16检查没有问题这里还有问题的话，重启虚机是无效的。需要执行  wm size reset
    
18. 卸载plugin的方法：dg apt uninstall patch:ks       以及物理机层面:find /data -name patchconfig           删除/data/lxc_container/data/3/misc/patchconfig/ks

16、 云手机dns问题  
看安卓版本  getprop |grep version.release
aosp版本查询：getprop ro.product.base_version            
| AOSP版本 |   开始支持的版本 |
| :-- | :--: |
| 8.1 |  4.49.0  |
| 10 | 2.56.0  |
| 12 | 2.33.0 |
| 13 | 1.9.0 |
| 15 | 默认支持 |

综上版本支持dns动态修改：  
dns设置：  settings put secure net_override_dns 10.255.255.244  
dns查看：  settings get secure net_override_dns
动态dns置空：  settings put secure net_override_dns null，该dns 可能pass上会每日下发任务到设备，这个值会改变。所以pass端也需要关闭下发任务。
#dns 查看是否生效，请用：  
android10以上：dumpsys dnsresolver  
android10以下：dumpsys netd
提示：
```
:/ # getprop |grep dns
[init.svc.mdnsd]: [running]
[net.dns1]: [10.255.255.243]                   #这种第一个是243，第二个是244.一般243起作用。最好统一下。
[ro.boottime.mdnsd]: [7719826745271749]
[ro.net.provisioned.dns]: [10.255.255.244]
```
17、 云手机安卓版本以及sdk版本以及对应关系  
| Android 版本 | SDK（API Level） |  
| :-- | :--: | 
| Android 14 | 34 |
|Android 13|	33|
|Android 12|	31、32
|Android 11|	30
|Android 10|	29
|Android 9	|28
|Android 8.1|	27
|Android 8.0|	26
```
getprop ro.build.version.release  #查看安卓云手机版本  
#cat /system/build.prop | grep ro.build.version.release  build.prop文件包含了安卓系统的各种配置信息，其中就有系统版本信息
getprop ro.build.version.sdk  #getprop ro.build.version.sdk
```
18、 查看设备型号，芯片型号  
cat /sys/firmware/devicetree/base/compatible  
rockchip,androidrockchip,rk3399-excavator-edp-avbrockchip,rk3399
```
:/ # getprop |grep sdkversion                   #通过这种方式也可以看到设备型号。 
[ro.vendor.sdkversion]: [rk3588_ANDROID10.0_MID_V1.0]
```
针对3399型号的设备，清理data盘数据无脚本，需要rm -rf /data/*   且不关掉 当前shell端后，进行reboot。  **否则删除数据退出后将无法ssh连接设备**

19、 营销平台显示断网原理  
营销云agent插件
`检测物理机是否有lite-agent`
curl判断
营销从dg获取的；dg是根据能否请求 http://lite-ip.cloud-control.top:8778/ip 这个链接来判断的（该url 通过dg dump net 获取）
`/system/xbin/curl http:\/\/lite-ip.cloud-control.top:8778\/`
营销平台根据arm设备执行： dg dump net 后的checkUrl地址判断是否有网络。但是一般这里的*conn.outIp": null* 字段是null的话，说明了应该是没有出口的公网ip，也是无法curl成功的。
22或者62485端口是否开启，一般开一个即可。。

20. 云手机中magisk 残留，可以在 /data/lxc_container/data/0/app  在app中可以看到类似： com.topjohnwu.magisk-... 这种。
21. 感觉云手机重启：
    * 物理机、云手机重启
    * 异常重启：例如 oom 了。排查dmesg  看到面具的 优先级为-1000 。导致的内存泄露。 kswapd 进程活跃。 （内核回收内存进程）
22. 查看云手机是否重启可以看： ls -lrt /data/system/dropbox/ |egrep "RESTART|app_native|BOOT"    是否存在相关日志。
23. apk安装路径：
```shell
root@mciserver:~# find /data -name *.apk|awk -F".apk" '{print $1}' |awk -F"/" '{print $1"/"$2"/"$3"/"$4"/"$5"/"$6}'|sort -u |grep 0
/data/lxc_container/data/0/data                   
/data/lxc_container/data/0/misc                                          
/data/lxc_container/data/0/system
/data/lxc_container/data/0/user_de
/data/lxc_volumns/super_0/product/app
/data/lxc_volumns/super_0/product/overlay
/data/lxc_volumns/super_0/product/priv-app                         
/data/lxc_volumns/super_0/system/app
/data/lxc_volumns/super_0/system/etc
/data/lxc_volumns/super_0/system/framework
/data/lxc_volumns/super_0/system/priv-app              
/data/lxc_volumns/super_0/system_ext/app
/data/lxc_volumns/super_0/system_ext/priv-app
/data/lxc_volumns/super_0/vendor/overlay
/data/lxc_volumns/super_upper_0/overlay/system

24. 检测到/run 分区 爆满后，ls /run/NetworkManager/devices |wc -l     这个文件会很大，影响后续systemctl daemon-reload，也就是会影响到刷隔离，以及各种服务的restart。
这个分区内是可以删除的，是：好像是交换机dhcp配置有点问题导致的。
当rm -f 删除，会报错。此时可以用find 去删除。
find . -type f -print0 |xargs -0 rm -f              #简单解释下print0 在这里的作用：用于处理包含空格、换行符等特殊字符的文件名，避免解析错误。输出并以 null 字符（\0）作为文件名的分隔符。

25、物理机虚机， 是都要关掉hwc 才是代表已关闭动态分辨率。刷机指定hwc=false，出现问题的原因：检查下资源包里面是否有配，应该是被资源包覆盖了，资源包配置优先级大于软件包。
1.3的资源包是开着的，后面新版本的资源包会关掉
具体要检查：
* 物理机层面：cat /data/local/container/manage.conf |grep HWC_Enable
* 虚机层面
    * 安卓12：cat /data/lxc_volumns/super_?/vendor/build.prop |grep display
    * 安卓10：cat /data/lxc_volumns/vendor_?/build.prop|grep display
* 虚机中的 /vendor/build.prop |grep display 的值为0
* 物理机中看 /data/local/container/manage.conf |grep -i hwc     #值为0 为关闭。
安卓12：
安卓10：
```
26. 云手机壁纸替换原理
```
/data/lxc_volumns/super_0/vendor/build.prop               # 这是 Android 系统的核心配置文件，里面包含了系统属性（system properties），这些属性会在系统启动时被加载。
/data/lxc_volumns/super_0/vendor/etc/fa7c67fda7bf17da5d71907edf921f2fff7bcbb473740d-so5oTP_fw658webp.jpg          #这是存放 壁纸的路径。在 Android 中的情况：在 Android 系统里，/vendor/etc 一般包含与硬件相关的配置文件，比如音频参数、显示校准数据等。

壁纸替换原理：
cp fa7c67fda7bf17da5d71907edf921f2fff7bcbb473740d-so5oTP_fw658webp.jpg /data/lxc_volumns/super_0/vendor/etc/.
+ sed -i '$a\ro.config.wallpaper=/vendor/etc/fa7c67fda7bf17da5d71907edf921f2fff7bcbb473740d-so5oTP_fw658webp.jpg' /data/lxc_volumns/super_0/vendor/build.prop

/data/lxc_volumns/super_0/vendor/[etc|build.prop]
  │    │            │        │       └── 配置文件或目录
  │    │            │        └── 供应商特定内容
  │    │            └── 容器实例
  │    └── LXC 容器卷管理系统
  └── 数据存储根目录
```
27. 云游戏安全桌面调整
去掉受限应用、去掉安全桌面
```
桌面打开应用时提示“不允许开启受限应用”时，将物理机/data/lxc_volumns/system/etc/business-conf.xml文件中<multiple key="common.AllowdActivityPackagesWhileRestrictStartActivity" enable="true">  改为false，重启虚拟机


去掉安全桌面：ps -ef | grep launcher看看，卸载ishunwan的哪个包名的应用就可以
 /system/etc/business-conf.xml 
 
 修改为false
 <!--指定默认桌面程序-->
<combo key="settings.DefaultLauncher"enable="true">com.ishunwan,wm.launcher/com.android,launcher,Launcher</combo>
```
### 关于内核中内存的相关介绍
1. swap 何时起到作用的标准  
   ![swap使用标准](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/kernel.png)
```
此图解释：
nr_foll_pin_released： 表示已释放的页表项(page table entry)跟随者锁（follower pin）的数量.若该值在短时间内急剧增加，可能意味着系统中正在进行大量的页面映射调整，或者存在某些程序频繁地申请和释放内存，导致页表项操作频繁。
nr_kernel_stack: 代表内核栈的数量.可以辅助判断系统中内核线程的活跃程度.如果 nr_kernel_stack 的值持续增加，可能表示系统中正在创建大量的内核线程，这可能会消耗较多的内存资源
pages 相关字段:
       min：表示内存水位线的最小值。当系统的空闲内存低于这个值时，内核会触发内存回收机制，尝试释放一些内存以满足系统的内存需求。
       low：内存水位线的低阈值。当空闲内存低于 low 但高于 min 时，内核会更加积极地进行内存回收，以避免空闲内存进一步下降到 min 以下。
       high：内存水位线的高阈值。当空闲内存达到或超过这个值时，内核认为内存资源相对充裕，内存回收的压力较小。
spanned：表示系统中内存页的总跨度，即从最低地址到最高地址所涵盖的内存页数。
present：表示系统中实际存在的内存页数，它反映了系统中真正可用的物理内存资源。
managed：代表由内核内存管理子系统管理的内存页数，通常会小于或等于 present，因为可能存在一些内存区域（如被硬件占用的内存 ）是内核内存管理子系统无法直接管理的。
# 如果 managed 远小于 present，可能意味着部分内存没有被正确初始化或存在硬件相关的问题导致内核无法管理这部分内存。
```
1. swappiness 是一个重要的参数，取值范围是 0 - 100.swappiness 用于控制系统将内存数据换出到交换空间（swap space）的倾向程度
   * 值为 0：表示系统尽量避免将内存数据换出到 swap 空间，只有在内存几乎耗尽，实在没有其他可用内存时，才会不得已将部分数据换出到 swap 。
   * 值为 100：意味着系统会非常积极地将内存中不常使用的数据换出到 swap 空间，只要有一定的内存压力，就会主动进行内存与 swap 之间的数据交换。
   * 当 swappiness 设置为 60 时，表明系统在内存管理中对使用 swap 空间持中等积极的态度 
综合1和2：当内存水位线下降到一定程度，系统会按照swappiness 设置的倾向，决定是否将内存页换出到交换空间 。比如，若空闲内存接近min ，系统在进行内存回收时，会以 60% 的倾向去考虑将合适的内存页换入交换空间 ，从而释放物理内存。
1. dmesg |egrep -i fail
  ![内存碎片](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/memory_page.png)
```
截图解释：
关键报错是 page allocation failure（页分配失败），结合内存信息（Mem-Info 部分），可以从 内存碎片、可用内存、分配请求需求 三个维度分析 “失败是否因内存碎片”。
Linux 内核分配物理内存时，会用 “buddy 分配器” 管理内存页（把内存按 2 的幂次分组，如 4KB、8KB、16KB…）。如果系统存在 大量小内存页，但缺少连续的大内存页，就会触发 page allocation failure
page allocation failure: order:4, mode:0x140dc2 ...：代表：如果 buddy 分配器无法找到足够连续的页，就会报错，此时即使系统 “剩余内存总和高”，但 内存碎片化严重（小页多、大页少），也会分配失败。
free 总量高，但大页不足：如果 free 内存很多（比如你这里 free:380987400kB 看似很大），但 buddy 分配器里的 大页（高 order）数量为 0，说明内存碎片化。可通过 cat /proc/buddyinfo 确认各 order 的空闲页数量：
Node 0, zone      DMA32      1      2      3      4      5      6      7
                （order0  order1  order2  order3  order4  order5  order6  order7）
如果 order4（对应 order:4 的分配需求）的数值为 0，但低 order（如 order0/order1）数值很高，就是典型的 内存碎片化导致大页分配失败。如下截图
```
![内存order](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/buddyinfo.png)
```
截图解释：
Node 0, zone      DMA32      72      11618    5455    35    0    0    0    0    0    0
Node 0, zone      Normal    1095    1939    25477    12844    27    0    1    1    1    0 
#order 0 ：72 → 有 72 个独立的 4KB 空闲页。
#order 3 ：35 → 有 35 组连续 8 个 4KB 的页（每组 32KB ）。
#更高 order（4 - 9 ）数值为 0 ，表示没有对应大小的连续空闲页。
```
综上：如果内存碎片化严重：会导致云手机可能无法正常登录。kswap 进程频繁。如果内存不限额。，我们容器内的异步回收就不工作，这种情况就得等全局kswap回收。
优化措施：echo 3 >   /sys/kernel/mm/lru_gen/enabled  #完整启用 LRU generation 内存回收机制
# 用于 Linux 内核中启用 LRU generation 机制，用于优化内存页面的回收策略
```
LRU（Least Recently Used，最近最少使用）是 Linux 内核管理内存页面的经典算法，核心是优先回收 “最近最少被访问” 的内存页，释放内存给更急需的进程。而 LRU generation 是内核 5.18+ 版本引入的 增强型 LRU 机制
0：禁用 LRU generation 机制（使用传统 LRU 算法）。
1：仅对 匿名页 启用 LRU generation。
2：仅对 文件页 启用 LRU generation。
3：对 匿名页和文件页 同时启用 LRU generation（完整启用）。
内存碎片化严重：能更高效地区分 “活跃页” 和 “非活跃页”，减少有用内存页被误回收的概率。
```
RD后续建议
```
排查了主要修改点为两个：
1. 内核默认关闭MGLRU功能。 这是我们移植的一个内存回收方案，在老版本是开的，但是后来在红手指发现偶尔会导致物理机卡死，所以就关掉了。
2. 优化了LMK的机制。 lowmemorykiller之前在容器场景是有Bug的，修复了这个Bug

整体来看对优化卡死、内存不足时主动杀进程是有帮助的。
```
4. 如何判断服务器一直有oom的问题
![oom进程占用时长](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/oom%E7%9B%B8%E5%85%B3%E8%BF%9B%E7%A8%8B.png)
```
kswapd0 进程：它是内核线程，也被称为交换守护进程（swapper daemon）。主要职责是在系统内存不足时，主动扫描内存，将不活跃的内存页换出到交换空间（swap space），以此来释放物理内存，供其他更需要内存的进程使用。例如，当系统空闲内存低于一定的水位线（如 low 水位线 ）时，kswapd0 就会被唤醒并开始工作。
kworker 进程：这是内核工作线程，用于处理内核中的各种工作队列（workqueue）任务
lmkd 进程：全称为 Low Memory Killer Daemon，即低内存杀手守护进程。它会监控系统内存使用情况，当系统内存严重不足时，lmkd 会根据一定的策略（如进程的 oom_score_adj 值 ，该值用于调整进程被 OOM Killer 杀死的优先级 ），主动杀死一些优先级较低的进程，以释放内存，保证系统的稳定性和关键进程的正常运行。
SHR（共享内存大小）：指进程映射到的共享内存区域的大小，这部分内存可以被多个进程共享访问。比如多个进程可能会共享一些库文件（如动态链接库 ），这些库文件所占用的内存就会计入 SHR 中。但需要注意的是，SHR 中统计的共享内存并不一定都实际占用了物理内存，有些共享内存可能只是映射关系，并没有真正分配物理页。
#非swap 交换内存
综上截图来看：
TIME 高：频繁参与内存决策。
当 kswapd0 持续运行（TIME 高）但无法释放足够内存（如内存碎片化严重），free 会持续低迷，触发 lmkd 介入。二者 TIME 高通常是 内存压力的连锁反应：kswapd0 先尝试 “温和回收”，失败后 lmkd 启动 “暴力杀进程”。
资源共享：kworker 协助内存管理
kworker 是内核工作线程，会协助 lmkd/kswapd0 执行 异步内存任务（如回收 slab 缓存、规整内存碎片）。
kworker 的 SHR 高，可能是因为参与了内存管理相关的共享库调用，与 lmkd/kswapd0 复用了内核资源。
 短期缓解：降低内存压力
 释放缓存：echo 3 > /proc/sys/vm/drop_caches 手动回收文件页缓存，提升 free。
 限制进程内存：通过 cgroup 给非关键进程设置内存限额，避免耗尽系统内存。
 lmkd 占用 TIME、RES、SHR 是 系统内存压力的 “症状”：内存越紧张，lmkd 越频繁工作（TIME 高），同时自身需要常驻内存（RES）、依赖共享资源（SHR）。要解决需从根源优化内存使用，要么减少内存占用，要么增强内存回收效率，避免 lmkd 频繁杀进程影响系统稳定性。
```
5、安卓Ion 内存分配器
![android](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/ion.png)
```
ion_system_heap 是 Android 系统的内存分配器（Ion Allocator） 管理的一块内存区域，核心作用是：
为 硬件驱动、图形渲染、多媒体处理 等场景分配 “专用内存”，避免与普通进程内存混用，保障系统关键功能（如显示、相机）的稳定性。
          独立内存池：从系统物理内存中 “预占” 一部分，专门供 Ion 分配器管理（类似给硬件相关功能划一个 “内存特区”）。
          进程名是 “占位符”：ion_system_heap 不是传统意义的 “进程”，而是 Ion 分配器在 top 中的显示名称，实际背后是内核 ion 驱动和 Android 硬件抽象层（HAL）在协同工作。
          
通过使用 Ion 分配器，将硬件相关的内存分配与普通进程的内存分配隔离开来，可以减少不同组件之间的内存竞争和干扰。这样可以确保硬件设备在运行时能够稳定地获取到所需的内存资源，避免因为内存分配问题导致的硬件功能异常（如画面卡顿、相机无法拍照等），从而提高整个系统的稳定性和性能。
ion_system_heap 长时间占用 CPU 可能意味着它在处理内存分配请求时遇到了一些问题，比如内存碎片化严重导致难以找到合适的内存块，或者硬件驱动对内存的请求过于频繁和复杂。这可能会进一步影响到依赖它进行内存分配的硬件设备的正常工作，比如导致图形显示出现花屏、相机预览画面延迟或卡顿、视频播放不流畅等问题。
不过，仅仅通过 TIME+ 长并不能直接确定一定存在问题，还需要结合系统的整体运行状态（如内存使用情况、其他进程的资源占用情况 ）、硬件功能是否正常等多方面因素进行综合判断。
```

### 云手机离线问题处理集合1
1、java. lan.TlgalStateException: Signature nismatch on system package con,google,android.gms for shared user SharedUserseting(6874a6b con.google,uid. ...  
这个从日志可以看出    Signature con,google,android.gms   问题,  gms签名问题,gms缓存导致的            #重启看下效果。 是否启动时间较长。

2、现象：remote-play 未启动，可能是证书问题。
报错：[ERR][07 24 11:52:58.697 6323][remote-service]Failed to **load server certificate**, error:02001002:system library:fopen:No such file or directory
排查：manage.conf 是有2个，即：
root@mciserver:/data/local/container/commdir# ls -lrt /data/local/container/commdir/manage.conf
-rw-r--r-- 1 root root 9417 Jul 24 04:40 /data/local/container/commdir/manage.conf                  #/commdir/manage.conf 
root@mciserver:/data/local/container/commdir# ls -lrt /data/local/container/manage.conf
-rw-r--r-- 1 root root 9411 Jul 24 11:47 /data/local/container/manage.conf                      #manage.conf

root@mciserver:/data/local/container/commdir# cat /data/local/container/manage.conf |grep Cert
CertPem=/commdir/gc.com.cn.crt
CertKey=/commdir/gc.com.cn.key
root@mciserver:/data/local/container/commdir# cat /data/local/container/commdir/manage.conf |grep Cert
CertPem=/commdir/armvm.com.cn.crt
CertKey=/commdir/armvm.com.cn.key                                                                           #这个证书看是否存在，ls commdier/armvm.com.cn.* 
#综上，证书一般不存在，也可以去同网段其他机器看下。证书为 gc.com.cn.*     且 目录下存在这个文件。

解决办法：
root@mciserver:/data/local/container/commdir# sed -i 's@CertKey=.*@CertKey=/commdir/gc.com.cn.key@' /data/local/container/commdir/manage.conf
root@mciserver:/data/local/container/commdir# sed -i 's@CertPem=.*@CertPem=/commdir/gc.com.cn.crt@' /data/local/container/commdir/manage.conf
重启云手机即可。 pass后台正常显示在线。
3. hwc 动态分辨率开启要都开，关也要都关。否则会出现问题
hwc的开关需要在manage.conf中配置HWC_Enable=1，且再对应的虚机的vendor下的 build.prop中开启副屏debug.display.use_external_display=1。  1 为开启，0为关闭。
### 预警处理
【生产环境】
PaaS虚机直连监控
合肥机房-可用区1--VM010119030019 connect fail
截图地址：https://bj.bcebos.com/bac-private/saas-point/qa/rpm/20250720204359.png
解决方案：10.6.34.3 设备离线。 系统测定位内存问题。后续重启恢复。
问题：paas测对应链路未知。

20、 拟真理解  
配IP+刷拟真了，语言没变。需要执行命令 dg  osemu ip
dg osemu --help
21、 dg 和 dumpsys 的用法区别  
dumpsys <service>   #安卓原生命令。查看各种服务的状态
dg #非标准命令
```shell
#dg 命令大全
在云手机中也可以使用内置的dg命令调用系统服务api，功能和效果与sdk一致。即：dg_api       debug_get  或者理解为 device_get     dump 导出
dg dump base      #可以获取到AOSP版本（安卓开源项目）。例如：buildBaseVersion": "1.21.1.mciq85.base             #1.21.1AOSP版本
dg dump plugin            #查看apk插件有哪些，例如：sms、root、kernel、av、apt、proxy、patch（Android热补丁框架，支持app及系统服务热修补能力）
dg dump net               #可以查看出口公网ip。 也可以通过 curl cip.cc  或者 curl ipinfo.io 
#curl 报错：status": 429：
HTTP 状态码 429 是标准的 “请求过多” 错误，表示客户端发送的请求频率超过了服务器的限制。
#error.title": "Rate limit exceeded"
错误标题，直译为 “速率限制已超出”，即请求频率超过了允许的上限。
dg dump pm     #查看pm 相关，可以看到谷歌三件或者5件套。其中keepFingerprintApps    表示：保持 指纹 apps   代表了唯一凭证
dg dump display   #可以看到fps、dpi、分辨率的情况    例如：    getprop msiq.display.config
dg dump av         #可以查到av版本


eg::/ # dumpsys dnsresolver
NetId: 100          #网络标识ID
  DnsEvent subsampling map: 7:10 0:100 default:1
  DNS servers: # IP (total, successes, errors, timeouts, internal errors, RTT avg, last sample)
    10.255.255.240 (64, 64, 0, 0, 0, 0ms, 73s)
    #服务器地址：10.255.255.240
    #统计信息：共 64 次查询，64 次成功，无错误、超时或内部错误，平均 RTT（响应时间）0ms，最后一次采样在 73 秒前
    #这里即可看出：   DNS 服务器工作正常
  No search domains defined      #无 DNS 搜索域，解析规则简单。无法自动补齐域名。如：ww
  DNS parameters: sample validity = 1800s, success threshold = 25%, samples (min, max) = (8, 64), base_timeout = 5000msec, retry count = 2times
  # 超时与重试：基础超时时间为 5000ms（5 秒），重试 2 次，整体容错性中等。
  # 采样与阈值：采样有效期 30 分钟，成功阈值 25%（即只要 25% 的查询成功，就认为服务器可用），说明系统对 DNS 服务器的 “健康度” 要求较低，更容易保留可用状态。
  #无并发查询超时限制（0）：可能允许长时间的并发查询，但也可能导致极端情况下的资源占用。
  DNS64 config: none
  #DNS64 配置：无
  Private DNS mode: OPPORTUNISTIC #opportunistic 模式，优先尝试私有 DNS，失败则用常规 DNS
  Private DNS configuration (1 entries)
    10.255.255.240 name{} status{fail}
  #私有 DNS 配置：10.255.255.240（状态为失败，未成功启用）
  Concurrent DNS query timeout: 0
  #并发 DNS 查询超时：0（无超时限制）

  dg config -a system.su=false -a system.suAllowApps=$pkgName        #大麦定制机器如何开启root权限。用户自己操作：需要将界面展示出来，要OP设置一些配置，重启
```
22、更换镜像 
独立镜像还是共享的？共享的删下overlay的upper目录继续


### 刷机各问题
##### 应用加白，白名单
1. 包名加白，将system/etc/business-conf.xml 中， 配置common.AllowdActivityPackagesWhileRestrictStartActivity 增加包名。
```shell
for i in com.baidu.mobileqq com.tencent.mobileqq;do sed "/<multi key=\"common.AllowdActivityPackagesWhileRestrictStartActivity\" enable=\"true\">/a \        <str key=\"$i\" />" /data/lxc_volumns/super_?/system/etc/business-conf.xml;done
```
2. 需要的launcher 客户那边设置的。黑屏，点击无反应。

##### 内存隔离问题
1. 刷机后，内存隔离与物理机配置的实际无法对应的问题  
看arm-op-agent日志：
```
[log.INFO] install lxcfs 
Reading package lists...
Building dependency tree...
Reqading state information...
Package lxcfs is not available,but is referred to by another package.
This may mean that the package is missing,has been obsoleted,or is only available from another source
```
解决办法
```
1. 安装lxcfs 
apt install -y lxcfs
2. 检查/data/lxc_container/container_${VMsn}.conf是否存在lxc.include = /usr/share/lxc/config/common.conf.d/00-lxcfs.conf 没有加上
3. 重启虚拟机
```
2. 虚机执行报错：
:/ # dg dump net
cmd: Can't find service: dexguard                    #这是由于虚机没有正常启动的问题，ping 下公网可以发现问题。也可以通过pass平台看到是卡死的状态，一般需要重启物理机才可以解决。

1. dns无法解析域名
   排查思路： 域名dns，arm设备是否可以ping通。 无法ping通，找这个网段的其他节点再检查下。一般是同网段的虚机都无法ping通。若是可以ping通网关，不可以ping通dns，需要找系统集成的人员处理。例如：光桥。 安诚是网关人员。
1、 free -h 内存  
free -h 无法准确查看的情况下，echo $(cat /dev/memcg/memory.limit_in_bytes) /1024/1024 | bc      使用这条命令即可（大麦风控、游游峰）
#若是无bc命令可以使用：cat /dev/memcg/memory.limit_in_bytes | awk '{print int($1 / 1024 / 1024)}'
2、 芯片版本  
```shell
设备型号：cat /sys/firmware/devicetree/base/compatible
AOSP 10（Android Open Source Project 10）
1、cat /data/local/device_update/cloudphone_info.conf           
这个看到的应该是软件包的版本和安卓系统版本
2、getprop |grep version.release  
这个看到的是安卓的版本
3、getprop|grep ro.product.base_version             #或者 dg dump base
这个看到的是安卓的aosp的版本号。
例如：
:/ #  getprop|grep ro.product.base_version
[ro.product.base_version]: [2.47.1.mcir5.base]
```
### 刷机之安装桌面apk、内置应用apk-----常见刷机问题1
##### 背景： 云手机更换成客户自己的桌面程序
步骤：
1. 更换Laucher，需要bash builtin-pkg.sh xxx.apk 云手机路径
2. /system/etc/business-conf.xml  需要更换为客户的Launhcer。例如：<combo key="settings.DefaultLauncher" enable="true">com.ishunwan.vm.launcher/com.android.launcher.Launcher</combo>. 更改成客户自己的Launcher，即：中间的部分要改掉。需要解压apk去获取。经过在线解压apk工具，可以得到：com.sh.launcher3/com.android.launcher3.Launcher 是这个路径。替换即可。
#解析：包名（com.ishunwan.vm.launcher）、Android 有四大组件：Activity（活动，用于提供用户界面）：一般是第一个：com.android.launcher3.Launcher
#可以通过在线分析工具直接查看，无需手动分析： `https://www.shenmeapp.com/ `：可以全面检查 APK 包含的内容，包括应用程序代码、资源文件、清单、库、权限、硬件兼容性等。文件采用 256 位 SSL 加密保护，并在 2 小时后自动删除，确保机密性。
1. 云手机路径选择：/system/ 即可           最后会自动安装到：/system/app  下  
参考大脚本函数：apk_geneor apk_launcher

##### 背景： 内置apk的回验问题
步骤：
1. 安卓apk包，bash builtin-pkg.sh xxx.apk 云手机路径
参考大脚板函数：单个apk安装：apk_geneor       多个apk安装：builtin_apk_test

综上，如何check：  **dumpsys可以用来调试分析apk工具包，而不需要再使用上面的解压工具**
```shell
dumpsys package |grep -C 1 lhyzm --color           #可以获取包名
dumpsys package |grep -C 2 android.intent.action.MAIN|grep com.sh.launcher3 --color         #通过上面的包名，再去获取到main入口，即桌面入口程序路径。
删除或者卸载apk，直接rm -rf 最快，删除目录或者apk。
rm -rvf /data/lxc_volumns/super_?/system/app/yingyong

## 提示：
dumpsys package |grep yingyong             #如果你起了一个名字是yingyong.apk 而且找不到的一种方法。不推荐使用，因为现在知道了dumpsys 工具了
for i in $(pm list packages|awk -F: '{print $2}');do pm path $i|grep -i yingyong && echo $i;done         #可以获取包名。
```
参考流水线id：流水线ID `4371809547875086464`
check参考：4371809547875089274
##### 刷机中su 的问题
软件包的root 是整个设备具备root；    cloudphone.root_enabled=true

dg dump system |grep su 是针对所有应用root的总开关 `cloudphone.root_packages_denied = com.fake.package`  配置拒绝授权root的应用列表（其它应用默认授权root）。但是不一定system.su 就一定会为true。优先级不如资源包。手动调整的方法：暂不清楚。
即：
```
:/ # dg dump system|grep su
        "su": true,                          #这里true 为打开，false为关闭。
        "suAllowApps": [],
        "suDenyApps": [],
```
#### 版本型号汇总
1.remote-play版本
```
root@mciserver:/data/local/device_update/software# ls -lrt /data/local/container/remote-play*
lrwxrwxrwx 1 root root       42 Nov  3 20:17 /data/local/container/remote-play -> /data/local/container/start_remote-play.sh
-rwxr-xr-x 1 root root 94311024 Nov  3 20:17 /data/local/container/remote-play-rk_3588_hwc-5.37.0       #这个就是remote-play 的版本
```
获取方法2： `cat /data/local/device_update/software/cloudphone_version.conf`

1. bitcap版本
ls -lrt  /data/local/container/bitcap
2. 资源包版本： cat /system/etc/.resource_package_version
3. rootfs 版本  
grep ROOTFS_PATCHES_VERSION /data/local/init_sh/rootfs-guard.sh  
rootfs-patch：/data/local/device_update/software/rootfs-patch.status          #rootfs-patch  没有就是没有更新过 ，rootfs-patch。1.3.0 版本+支持清理云手机日志
rootfs：/etc/os-buildversion               # 这个可能是rootfs 的构建版本，非 rootfs-patch的。
```shell 
rootfs.enable_dev_info=true
rootfs.dev_info_server_url=http://mcigather.armvm.com/device/monitor/
rootfs.dev_info_server_url_report_interval=60

# 1.22开始支持该配置项，可以用最新1.25

补充：rootfs上报监控
rootfs补丁包配置项（可以参考 rootfs补丁包）
```
rootfs.enable_dev_info=true
rootfs.dev_info_server_url=http://mcigather.armvm.com/device/monitor/
```
检查：monitor是否配置
root@mciserver:~# cat /data/local/init_sh/cron_dev_info.sh |grep monitor
SERVERURL='http://mcigather.armvm.com/device/monitor/'

重启上报服务：  `systemctl restart cron_dev_info`
```
测试是否可以上报成功，可以用post。如：
```shell
root@mciserver:~# /usr/bin/curl -X POST \
>   -H "Content-Type: application/x-www-form-urlencoded" \
>   -d "dev_type=3588&os_type=linux&kernel_ver=4.9.216&cpu_model=RK3588&mem_utilization=30%" \
>   -m 20 \
>   -v "http://mcigather.armvm.com/device/monitor/"                         #这些信息通过/bin/bash -x /data/local/init_sh/cron_dev_info.sh 可以获取
Note: Unnecessary use of -X or --request, POST is already inferred.
*   Trying 106.12.63.205:80...
* Connected to mcigather.armvm.com (106.12.63.205) port 80 (#0)
> POST /device/monitor/ HTTP/1.1
> Host: mcigather.armvm.com
> User-Agent: curl/7.74.0
> Accept: */*
> Content-Type: application/x-www-form-urlencoded
> Content-Length: 83
>
* upload completely sent off: 83 out of 83 bytes
* Mark bundle as not supporting multiuse
< HTTP/1.1 202 Accepted  
< Server: nginx/1.18.0
< Date: Wed, 15 Oct 2025 08:41:23 GMT
< Content-Type: text/html
< Content-Length: 1
< Connection: keep-alive
<
* Connection #0 to host mcigather.armvm.com left intact

root@mciserver:/data/local/logs/device_update# systemctl status cron_dev_info             #查看设备是否有正常上报信息的简单方法是通过status获取。这个有待验证。
● cron_dev_info.service - cron_dev_info server
     Loaded: loaded (/lib/systemd/system/cron_dev_info.service; enabled; vendor preset: enabled)
     Active: active (running) since Wed 2025-10-15 11:31:27 HKT; 5h 18min ago
   Main PID: 699 (bash)
      Tasks: 2 (limit: 9830)
     Memory: 33.5M
     CGroup: /system.slice/cron_dev_info.service
             ├─  699 /bin/bash /data/local/init_sh/cron_dev_info.sh
             └─53937 sleep 5

Oct 15 16:45:05 mciserver sudo[21894]: pam_unix(sudo:session): session opened for user root(uid=0) by (uid>
Oct 15 16:45:05 mciserver sudo[21894]: pam_unix(sudo:session): session closed for user root
Oct 15 16:45:11 mciserver bash[60130]: 1
Oct 15 16:50:07 mciserver sudo[53565]:     root : PWD=/ ; USER=root ; COMMAND=/usr/bin/cat /sys/class/ther>     #可以看到每5min 有一次获取，这个有待查询
Oct 15 16:50:07 mciserver sudo[53565]: pam_unix(sudo:session): session opened for user root(uid=0) by (uid>
Oct 15 16:50:07 mciserver sudo[53565]: pam_unix(sudo:session): session closed for user root
Oct 15 16:50:07 mciserver sudo[53571]:     root : PWD=/ ; USER=root ; COMMAND=/usr/bin/cat /sys/class/ther>
Oct 15 16:50:07 mciserver sudo[53571]: pam_unix(sudo:session): session opened for user root(uid=0) by (uid>
Oct 15 16:50:07 mciserver sudo[53571]: pam_unix(sudo:session): session closed for user root
Oct 15 16:50:09 mciserver bash[22433]: 1
root@mciserver:/data/local/logs/device_update#
root@mciserver:/data/local/logs/device_update#
```
4、 op-agent 版本  
/data/local/arm-op-agent/arm-op-agent version
5、dufs 版本
cat /data/local/acb-dufs/version

6、 重试任务失败（可以后续尝试，这个并未检验）
1、更新mgr版本到3.38
2、虚机在线
长沙测试专用机器 10.0.16.88
yw_opert 用户下，/data/ftp/dyj/download/container_mgr-linux-3.38.0.sh

7、设备离线问题处理
长沙测试专用机器 10.0.16.88
cs_opert 用户下，/home/cs_opert/wangyu/shell/remount_overlay.sh
vi forover.txt 物理IP=sn

8、 各种修复bug脚本服务器
10.6.178.4 cd /data/file_storge/padctl_bin/ 下

1. manage-agentV4.32 支持 1.1 的网络隔离策略

manage-agent-unify-4.55.0
container_mgr-linux-3.41.0.sh
tc-linux-2.5.0.sh                以上（包含）支持对拷功能,所以一般建议刷最新的软件包即可。 通过国内apaas平台的任务：对拷可以看到pass的taskid，该id可以直接在arm设备中通过manage-agent日志去过滤，若是只有接收没有返回给pass的信息，说明是版本不支持。
10. 虚机截图命令：/system/bin/screencap -p /data/local/tmp/1.png
##cd /data/local/container/sh      ./cappicture 1 90 0 0 /data/local/container/test.jpg             #可以这样截图    1代表1号机器。第二个为：压缩的图片质量，后面依次是：旋转角度、要缩放的分辨率
##./cappicture 可以提示截图信息
### pcdn

## ebtables隔离问题汇总
```
1、报错：touch script error touch script error arm isolate update error             #磁盘不足
2、报错：not exist must rule: 10.0.0.0/8 arm isolate update error           #需要重装ebtables，可能源有问题：   apt-get remove ebtables && apt-get install ebtables
备注：如果还是失败报not exist must rule: 10.0.0.0/8 arm isolate update error，可以尝试apt purge -y ebtables --auto-remove删除命令
3、其他报错访问：https://ku.baidu-int.com/knowledge/HFVrC7hq1Q/DdQBwEGTfT/MaG1TWnWDG/XE5-gkeODWk8-l
```

## pgsql 最近涉及到的sql命令
提示：   
```
    * 字符类相关：
        * \d：匹配任意数字，等价于[0-9]。例如在你给出的\d+\.\d+\.\d+\.\d+中，\d就是用于匹配数字的元字符。
        * \w：匹配任意字母、数字或下划线，等价于[a-zA-Z0-9_]。
        * \s：匹配任意空白字符，包括空格、制表符、换行符等。

    * 量词相关：
        * +：表示前面的元素至少出现一次，如\d+表示一个或多个数字。
        * *：表示前面的元素出现零次或多次。
        * ?：表示前面的元素出现零次或一次。
        * {n}：表示前面的元素恰好出现n次。
        * {n,}：表示前面的元素至少出现n次。
        * {n,m}：表示前面的元素出现次数在n到m之间（包含n和m）。

    * 边界相关：
            * ^：匹配字符串的开头。
            * $：匹配字符串的结尾。
            * \b：匹配单词边界。



            * ~和~*操作符：~用于区分大小写的正则匹配，~*用于不区分大小写的正则匹配。

substring函数的用途是从一个字符串里提取子字符串。
```
1. p2p 相关sql，退订下架以及配置p2p可以使用如下4条sql
```
-- 该sql 用于获取哪些网段有iptables规则后，使用第二条sql确认是几条规则
select distinct ide_iptables_pool.ip as vip,
substring(device_ip from '\d+.\d+.\d+.') as 物理机IP
--rf_pad.pad_ip as pad_ip 
from ide_iptables_pool,ide_iptables_mapping,rf_device,rf_pad 
where ide_iptables_pool.iptables_pool_id = ide_iptables_mapping.iptables_pool_id 
and ide_iptables_mapping.pad_id = rf_pad.pad_id and rf_pad.device_id = rf_device.device_id 
and substring(device_ip from '\d+.\d+.\d+.') in (
'11.12.148.','11.12.149.'
)

-- 该sql 用于获取iptables 为4 条规则的情况。即：iim.protocol_type = '6' 的情况。若是没有即为3条iptables规则的情况。确认后回去pad_code 
SELECT distinct iim.protocol_type, substring(rd.device_ip from '\d+.\d+.\d+.') 
FROM ide_iptables_mapping iim
JOIN rf_pad rp ON rp.pad_id = iim.pad_id
JOIN rf_device rd ON rp.device_id = rd.device_id  -- 增加明确的连接条件
WHERE iim.protocol_type = '6' 
  AND SUBSTRING(rd.device_ip FROM '\d+\.\d+\.\d+\.') IN (
    '11.32.84.','11.32.88.','11.32.81.'
  );
  
  

-- 查pad_code，去pass后台进行查询，配置配置vip。或者开启、禁用等功能都需要这个pad_code.

select pad_code from rf_pad where device_id in (select device_id from rf_device where substring(device_ip from '\d+.\d+.\d+.') in ('11.12.148.','11.12.149.')) order by pad_code;


-- 该sql 用于获取iptables库里目前有多少条规则的情况。这个作为一个校验使用。pad_code 还是需要在iptables映射中查看是否启用的（这一条可以忽略。pass侧直接可以查询到，不放心的话可以用这条sql进行查看。）

SELECT count(*) from ide_iptables_mapping a left join (select device_ip, pad_id, pad_sn, pad_code from rf_device a, rf_pad b where a.device_id = b.device_id and a.status = '1' ) b on a.pad_id = b.pad_id where substring(device_ip from '\d+.\d+.\d+.') in ('11.12.111.','11.12.112.','11.12.114.','11.12.115.')
```
2. bmc网关
```
--sql查看rf_device表中的bmc网关，用于bmc救援模式中的 -d 使用。
select bmc_manage_port_ip from rf_device where device_ip = '11.39.61.4';

select bmc_manage_port_ip from rf_device where substring(device_ip from '\d+.\d+.\d+.') in ('10.1.10.');
UPDATE rf_device SET bmc_manage_port_ip='172.26.0.211' WHERE substring(device_ip from '\d+.\d+.\d+.') in ('10.1.11.');
--h或者可以在： paas后台------物理设备--------查看到：管理口ip 
```
2. p2p 校验sql命令：
```sql
select distinct ide_iptables_pool.ip as vip,
substring(device_ip from '\d+.\d+.\d+.') as 物理机IP
--rf_pad.pad_ip as pad_ip 
from ide_iptables_pool,ide_iptables_mapping,rf_device,rf_pad 
where ide_iptables_pool.iptables_pool_id = ide_iptables_mapping.iptables_pool_id 
and ide_iptables_mapping.pad_id = rf_pad.pad_id and rf_pad.device_id = rf_device.device_id 
and substring(device_ip from '\d+.\d+.\d+.') in (
	'11.37.3.','11.37.20.','11.37.44.','11.37.50.','11.37.41.','11.37.43.','11.37.45.','11.37.42.','11.37.25.','11.37.28.','11.37.34.','11.37.26.','11.37.35.','11.37.30.','11.37.24.','11.37.39.','11.37.40.','11.37.38.','11.37.58.','11.37.60.','11.37.65.','11.37.62.','11.37.61.','11.37.64.','11.37.66.','11.37.67.','11.33.217.','11.33.204.','11.33.216.'
)
#这个查到的是 有p2p规则的，且网段对应的。 适合查看
结果如下：
"10.6.234.211"	"11.37.3."               10.6.234.135       10.6.234.137
"10.6.234.212"	"11.37.34."
"10.6.234.212"	"11.37.35."
"10.6.234.212"	"11.37.38."
"10.6.234.212"	"11.37.39."
"10.6.234.212"	"11.37.40."              10.6.234.136         10.6.234.138
"10.6.234.212"	"11.37.41."
"10.6.234.212"	"11.37.42."
"10.6.234.212"	"11.37.43."
"10.6.234.212"	"11.37.44."
"10.6.234.212"	"11.37.45."
"10.6.234.212"	"11.37.50."
#########################################################################
select distinct ide_iptables_pool.ip as vip,
rf_device.device_ip
--rf_pad.pad_ip as pad_ip 
from ide_iptables_pool,ide_iptables_mapping,rf_device,rf_pad 
where ide_iptables_pool.iptables_pool_id = ide_iptables_mapping.iptables_pool_id 
and ide_iptables_mapping.pad_id = rf_pad.pad_id and rf_pad.device_id = rf_device.device_id 
and substring(device_ip from '\d+.\d+.\d+.') in (
	'11.37.3.','11.37.20.','11.37.44.','11.37.50.','11.37.41.','11.37.43.','11.37.45.','11.37.42.','11.37.25.','11.37.28.','11.37.34.','11.37.26.','11.37.35.','11.37.30.','11.37.24.','11.37.39.','11.37.40.','11.37.38.','11.37.58.','11.37.60.','11.37.65.','11.37.62.','11.37.61.','11.37.64.','11.37.66.','11.37.67.','11.33.217.','11.33.204.','11.33.216.'
)
#这个查到的是 有p2p规则的，对应的物理机ip。非常多，不适合查看

```
1、 postgresql 的sql常用命令
```shell
[root@DDY-172.26.0.71 ~]su - postgres             #登录pg 用户
Last login: Fri May 23 14:42:08 CST 2025 on pts/3

[postgres@DDY-172.26.0.71 ~]/opt/pgsql-12.11/bin/psql         #执行登录操作，一般为免密
\list      --查看有那些库 或者 \l
\c 数据库名  --connect  表示连接数据库
\dt        --"Display Tables"（显示表） ，快捷命令相当于：  
-- 查看当前数据库中所有表     
SELECT table_name FROM information_schema.tables WHERE table_type = 'BASE TABLE' AND table_schema = 'public';

 查看 是否有表                           \dt rf_pad 

\d users   --可以查看user表的表结构
eg：
redfinger_paas=# \dt rf_pad
          List of relations
 Schema |  Name  | Type  |   Owner
--------+--------+-------+-----------
 public | rf_pad | table | redfinger
(1 row)

redfinger_paas=# select pad_code from rf_pad where device_id in (select device_id from rf_device where substring(device_ip from '\d+.\d+.\d+.\d+') in ('10.1.65.77','10.1.65.78','10.1.65.79','10.1.65.80')) order by pad_code;
    pad_code
----------------
 VM010002129131
 VM010002129132
 VM010002129133
 VM010002129134
 VM010002129135
 VM010002129136
 VM010002129137
 VM010002129138
 VM010002129139
 VM010002129140
 VM010002129141
 VM010002129142
 VM010002129143
 VM010002129144
 VM010002129145
 VM010002129146
 VM010002129147
 VM010002129148
 VM010002129149
 VM010002129150
(20 rows)

redfinger_paas=#

```
“schemas” 常见读音有英式读音 /ˈskiːməz/     #模式  
columns  英式读音：/ˈkɒləmz/    （表格、数据库中的）列
```pgsql
SELECT distinct rf_idc.idc_name as 机房, rf_pad.pad_source as 设备池, rf_device.device_ip as 物理机IP,rf_device.device_management_entity as 设备管理方,rf_device.server_type as 设备型号,
rf_pad.pad_ip as 虚拟机IP, rf_pad.pad_code as 虚拟机编号, rf_device.device_status as 物理机状态, rf_pad.vm_status as 虚拟机状态
FROM rf_pad,rf_device,rf_idc
WHERE rf_pad.device_id = rf_device.device_id and rf_device.idc_id = rf_idc.idc_id
and rf_pad.pad_source not like '%toC_%'
-- and rf_device.server_type = '3588'
-- and rf_pad.merchant_user_id != '2013'
and rf_device.device_status = '1' 
and rf_pad.grant_open_status = 'on'
and rf_device.device_management_entity = 'toB'
```
综上，根据上面输出：查询设备在线且虚机授权的tob设备sql语句
```
#GROUP BY 本身就会去重每个组合，不需要再加 DISTINCT
SELECT 
  rf_idc.idc_name AS 机房, 
  rf_device.device_ip AS 物理机IP,
  rf_device.device_management_entity AS 设备管理方
FROM 
  rf_pad, rf_device, rf_idc
WHERE 
  rf_pad.device_id = rf_device.device_id 
  AND rf_device.idc_id = rf_idc.idc_id
  AND rf_pad.pad_source NOT LIKE '%toC_%'
  AND rf_device.device_status = '1' 
  AND rf_pad.grant_open_status = 'on'
  AND rf_device.device_management_entity = 'toB'
GROUP BY 
  rf_idc.idc_name, rf_device.device_ip, rf_device.device_management_entity limit 10;
```
![如上sql输出结果](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/sql.png)

```
#待分析sql
update ide_toc_remote set control_ip='10.4.150.211',control_port=9916,capture_ip='10.4.150.203',capture_port=8012 where control_ip='10.4.150.211' and pad_id in (select pad_id from rf_pad where device_id in (select device_id from rf_device where (device_ip like '11.36.1.%'
or device_ip like '10.185.30.%'
or device_ip like '10.185.29.%'
or device_ip like '10.185.28.%'
or device_ip like '10.185.27.%'
or device_ip like '10.185.100.%'
or device_ip like '11.36.4.%')) and idc_id=312);
---------------
SELECT distinct substring(pad_ip from '\d+.\d+.\d+.')
FROM rf_pad
WHERE EXISTS (
  SELECT 1
  FROM unnest(string_to_array(pad_ip, ',')) AS ip
  WHERE 
    split_part(trim(ip), '.', 1) = '10' 
    AND split_part(trim(ip), '.', 2) = '159' 
    AND split_part(trim(ip), '.', 3)::INT BETWEEN 112 AND 220
);
```

## 待学排查
### 接口查询工具
Charles 也没有抓到超时的接口请求。。
## 周报汇总
 1、从大局上整理问题，不要单纯说个人问题（显得自己问题很多）
 2、平时记录下各种吐槽问题，可以周会上汇总。要客观，不能带有主观色彩。
 3、不需要讲错误细节，只需要讲出个人的困难，耗时在哪。具体问题不要讲太泛，也不能讲太细。主要将领导可以理解或者关心的问题，不然会打断讲另外一个话题。讲下遇到的困难的过程及后续结果。
 过程很重要，结果也很重要
 例如：rootfs 更新的问题，不需要将报错细节拉出。 只需要告诉：这批设备更新出问题，重试多少次成功。预计交付时间以及造成的影响。讲出痛点，后续是否修复看rd 方面
 4、汇总说明：本周以交付单为主，还有一些任务单。 这是重点问题回顾
 5、层次要明确，不然找不到你在说哪行。。。这个格式要调整。尽量要用有序或者无序 序列。
## post请求，找时间实验下
curl -X POST https://hl-download.armvm.com/gather/report/software-version.html \
  -H "Content-Type: application/json" \
  -d '{"version": "v2.1.3", "device_id": "abc123456"}' \
  --max-time 10  
  #-X POST：声明这是一个 POST 请求  
  #-H "Content-Type: application/json"：告诉服务器，发送的数据是 JSON 格式  
  #-d '{"version": "...", "device_id": "..."}'：要发送的具体数据（JSON 格式）  
  # --max-time 10：超时时间（10 秒内没响应就停止等待）  

#成功：类似 {"code":0, "msg":"success", "data":{}}（表示版本信息上报成功）  
#失败：比如 {"code":3100003, "msg":"参数[version]格式错误"}（需要按提示修改参数格式，比如换 version 为 2.1.3 或 2.1.3.100 再试）

## shell脚本思路
### shell 脚本中可以直接嵌套脚本，用于相同逻辑函数调用。 要注意变量和 ？ * 的通配符 在函数中使用时，若是双重解析的话不可以使用引号。
1. 函数中可以嵌套其他函数使用
```
root@mciserver:~# dir_pattern="/data/lxc_volumns/super_?"
root@mciserver:~# echo $dir_pattern
/data/lxc_volumns/super_0 /data/lxc_volumns/super_1 /data/lxc_volumns/super_2 /data/lxc_volumns/super_3 /data/lxc_volumns/super_4
root@mciserver:~# echo "$dir_pattern"
/data/lxc_volumns/super_?
root@mciserver:~# echo '$dir_pattern'
$dir_pattern

#综上，变量为/data/lxc_volumns/super_?。但是三中echo 输出的结果都是不一致的
1、echo $dir_pattern。          当变量不加引号引用时（$dir_pattern），Shell 会执行 “双重解析”：
先将变量 dir_pattern 替换为其内容（/data/lxc_volumns/super_?）再对替换后的内容进行 通配符扩展（将 ? 解析为匹配的目录名，如 super_0、super_1 等）。
2、echo "$dir_pattern"          当变量用双引号引用时（"$dir_pattern"），Shell 仅执行 “单次解析”：只将变量 dir_pattern 替换为其内容（/data/lxc_volumns/super_?）；不进行通配符扩展（? 被视为普通字符，不解析为匹配目录）。双引号的核心作用是 “保留变量内容的完整性”，包括空格、通配符等特殊字符，避免被 Shell 二次处理。
3、echo '$dir_pattern'（单引号引用变量）    单引号是 Shell 中 “最强的引用方式”，会将引号内的所有内容视为 纯字符串，不做任何解析：不替换变量（$dir_pattern 不会被替换为变量内容，直接输出 $dir_pattern）；不解析通配符、转义字符等（即使内容中有 ? 或 \，也会原样输出）。

综上，再去结合 'EOF'：
结合 << 'EOF' 的特殊性
<< 'EOF' 的作用是 阻止本地 Shell 解析任何内容，确保变量和通配符原封不动传递到远程。因此：
无引号的 ${dir_pattern} 在远程 Shell 中会触发 “变量替换 + 通配符扩展”，符合你需要匹配目录的需求。 #要注意我们这里是引用变量，想要它被双层解析，所以不要加引号。否则会有问题。
有引号的 "${dir_pattern}" 仅触发 “变量替换”，但阻止通配符扩展，导致 ls 无法找到目标。  即：输出：ls: cannot access '/data/lxc_volumns/vendor_?': No such file or directory
```
```
解析：
PATTERN='^(ro\.(device\.(imei|wifi_mac)|serialno|product\.(android_id|model|brand|manufacturer)|settings\.android_id))='
匹配的具体属性
该正则表达式精确匹配以下几类 Android 系统属性（按分组拆分）：
ro.device.imei 或 ro.device.wifi_mac
对应设备的 IMEI 号码（移动设备识别码）和 WiFi 物理地址（MAC 地址）
ro.serialno
对应设备的序列号（出厂时分配的唯一标识）
ro.product 系列属性
ro.product.android_id：设备的 Android ID（用于标识设备的软件指纹）
ro.product.model：设备型号（如 "Pixel 6"）
ro.product.brand：设备品牌（如 "Google"）
ro.product.manufacturer：设备制造商（如 "Google LLC"）
ro.settings.android_id
部分系统中用于存储的设置相关 Android ID（与 ro.product.android_id 功能类似，视系统版本而定）
```
2. 双引号的使用2
   
```
Shell 中，当变量不加双引号时，会触发 “单词拆分”（word splitting） 机制，将变量内容按空白字符（空格、制表符、换行符）分割成多个 “单词”，并忽略多余的空白；而加双引号时，会保留变量的原始格式（包括换行符）。
1、不加双引号时，$file 会被拆分成多个路径（super_0 到 super_7），这些路径之间的换行符被视为 “空白分隔符”，最终被合并成一行输出（路径之间用空格分隔）：
即：/data/lxc_volumns/super_0 /data/lxc_volumns/super_1 ... /data/lxc_volumns/super_7
2、加双引号时，"$file" 会完整保留变量的原始格式（包括 ls -1 产生的换行符），输出的内容是 8 行独立的路径：
/data/lxc_volumns/super_0
/data/lxc_volumns/super_1
...
/data/lxc_volumns/super_7
总结
不加双引号：变量内容被 “扁平化” 处理（换行变空格，多空白合并），最终为 1 行；
加双引号：变量内容保留原始格式（包括换行符），因此按实际行数（8 行）统计；
单引号：不解析变量，仅作为字符串处理，永远是 1 行。
这是 Shell 中变量引用的基础特性，在处理包含换行符的变量（如多行命令输出）时，加双引号是保留原始格式的关键。
```
举例说明
```
root@mciserver:~# file=$(ls -1d /data/lxc_volumns/super_?/system/etc 2>/dev/null)
root@mciserver:~# echo $file                        #不加双引号，不保留源格式
/data/lxc_volumns/super_0/system/etc /data/lxc_volumns/super_1/system/etc /data/lxc_volumns/super_2/system/etc /data/lxc_volumns/super_3/system/etc /data/lxc_volumns/super_4/system/etc /data/lxc_volumns/super_5/system/etc /data/lxc_volumns/super_6/system/etc /data/lxc_volumns/super_7/system/etc
root@mciserver:~# echo "$file"                      #加双引号，保留源格式。但是for 循环可以不加，因为空格的结果。for循环也是可以读取多个文件的。所以这里根据目的使用双引号。
/data/lxc_volumns/super_0/system/etc
/data/lxc_volumns/super_1/system/etc
/data/lxc_volumns/super_2/system/etc
/data/lxc_volumns/super_3/system/etc
/data/lxc_volumns/super_4/system/etc
/data/lxc_volumns/super_5/system/etc
/data/lxc_volumns/super_6/system/etc
/data/lxc_volumns/super_7/system/etc
root@mciserver:~# echo '$file'                      #不解析变量
$file
```
3. 双引号的使用3
```
for file in \$(ls -1d /data/lxc_volumns/super_?/system/etc 2>/dev/null); do
      if [ -d "\$file" ]; then                           #这里的file可以加双引号，也可以不加双引号。原因：for 循环会把 “换行分隔的结果” 拆成多个元素，逐个处理，所以输出多行。
      INFO_MAGISK=\$(ls \$file/*.sh 2>/dev/null)   
#综上，这里的       INFO_MAGISK=\$(ls \$file/*.sh 2>/dev/null)  如果写成了：INFO_MAGISK="\$(ls \$file/*.sh 2>/dev/null)"  外侧加上了双引号，会造成的一种结果是：双引号抑制了 * 通配符的扩展，同时 $file 包含多个目录路径（换行分隔），导致路径无效。双引号包裹后，"$file/*.sh" 中的*不会被解析
```
4. 双引号的使用4
   举例说明：
```
root@mciserver:~# echo $file/test.sh             #没有双引号，会输出到一行为一个整体
/data/lxc_volumns/super_0/system/etc /data/lxc_volumns/super_1/system/etc /data/lxc_volumns/super_2/system/etc /data/lxc_volumns/super_3/system/etc /data/lxc_volumns/super_4/system/etc /data/lxc_volumns/super_5/system/etc /data/lxc_volumns/super_6/system/etc /data/lxc_volumns/super_7/system/etc/test.sh
root@mciserver:~# echo "$file"/test.sh             #有$file 的双引号下，不使用for循环的话，只会在最后加test.sh
/data/lxc_volumns/super_0/system/etc
/data/lxc_volumns/super_1/system/etc
/data/lxc_volumns/super_2/system/etc
/data/lxc_volumns/super_3/system/etc
/data/lxc_volumns/super_4/system/etc
/data/lxc_volumns/super_5/system/etc
/data/lxc_volumns/super_6/system/etc
/data/lxc_volumns/super_7/system/etc/test.sh
root@mciserver:~# for i in $file;do echo $i;done          #使用for循环，一切都正常
/data/lxc_volumns/super_0/system/etc
/data/lxc_volumns/super_1/system/etc
/data/lxc_volumns/super_2/system/etc
/data/lxc_volumns/super_3/system/etc
/data/lxc_volumns/super_4/system/etc
/data/lxc_volumns/super_5/system/etc
/data/lxc_volumns/super_6/system/etc
/data/lxc_volumns/super_7/system/etc
root@mciserver:~# for i in $file;do ls $i/*.sh;done
/data/lxc_volumns/super_0/system/etc/test.sh                    #测试的test.sh 也正常
ls: cannot access '/data/lxc_volumns/super_1/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_2/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_3/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_4/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_5/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_6/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_7/system/etc/*.sh': No such file or directory
root@mciserver:~# for i in $file;do ls "$i/*.sh";done              #但是如果*号被双引号包裹，则不会被解析。这样的结果是有问题的。所以双引号不可以随意使用。
ls: cannot access '/data/lxc_volumns/super_0/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_1/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_2/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_3/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_4/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_5/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_6/system/etc/*.sh': No such file or directory
ls: cannot access '/data/lxc_volumns/super_7/system/etc/*.sh': No such file or directory
```
1.虚机传包
```
function vm_scp()
{
 ssh_fun $1 "mkdir -p /data/local/tmp"
 scp_fun $1 file/ks.apk /data/local/tmp
 ssh_fun $1 "/bin/bash -s" << 'EOF'
      for sn in $(lxc-ls);do rsync -a /data/local/tmp/ks.apk /data/lxc_container/data/$sn/local/tmp/;done      #映射虚机目录：/data/local/tmp/
          for sn in $(lxc-ls);do lxc-attach -n $sn -- cp /data/local/tmp/ks.apk /sdcard;done
EOF
  ssh_fun $1 'for sn in $(lxc-ls);do lxc-attach -n $sn -- sh -c "dg apt install patch:/sdcard/ks.apk;mkdir -p /data/misc/patchconfig;chmod755 /data/misc/patchconfig;echo com.fenbi.android.zenglish.hd >> /data/misc/patchconfig/ks;echo com.fenbi.android.zenglish >> /data/misc/patchconfig/ks;chmod 644 /data/misc/patchconfig/ks";done'

}

```
1、
```shell
1、当有三种情况。
过滤总内存，过滤M， 过滤G 。 三个逻辑又各自有if判断。 这样的话 else 嵌套太深，需要 将第一次if去掉。
if grep -q ^MemoryLimit /lib/systemd/system/manage-main.service;then
grep ^MemoryLimit.*M /lib/systemd/system/manage-main.service
grep ^MemoryLimit.*G /lib/systemd/system/manage-main.service
...
...
else
  TOTALMEM="wupeizhi"
fi
}


优化思路：
local MEMLINE=$(grep ^MemoryLimit /lib/systemd/system/manage-main.service 2>/dev/null)          #直接给总内存赋值，根据结果进行if判断，这样else 不会嵌套太深。
    if [[ -z "$MEMLINE" ]]; then
        MEM_RESULT="wucfg"
        echo "$MEM_RESULT"
        return
    fi
```
2、lxc-ls 本地执行与远程执行效果不同
```
[device@zc-10-6-42-115 wangyulong]$ ssh -i wsy_wsy -p 62485 root@11.28.204.90 'lxc-ls'
0
1
2
3
4            #每个容器名单独占一行，这是 lxc-ls 在非交互式环境（无终端）下的默认输出格式。

Last login: Fri Aug  1 18:36:17 2025 from 10.6.42.115
root@mciserver:~# lxc-ls
0    1    2    3    4
```
3、 bash中双小括号的使用
```
if (( $a < $b )); then
也是有效的，但不必要加 $          #在 Bash 的整数条件表达式语法 ((...)) 中，变量名前面可以 不加 $，这是语法的特性之一。
```
3、 脚本中遇到reboot后继续执行的脚本如何处理（待检验）
```
  1、重启后继续执行脚本的原理
 思路： 创建启动后执行的脚本+创建临时的systemd 服务
#创建启动后执行的脚本
tee /usr/local/bin/post_reboot.sh >/dev/null <<'EOF'
#!/bin/bash
# 重启后执行的动作
echo "$(date '+%F %T') success" >> /tmp/reboot.log
# 你也可以改成发钉钉、飞书等通知，比如：
# curl -X POST -H "Content-Type: application/json" \
#      -d '{"msg":"server rebooted"}' https://example.com/webhook
EOF
chmod +x /usr/local/bin/post_reboot.sh
#创建临时的systemd服务
tee /etc/systemd/system/post-reboot.service >/dev/null <<'EOF'
[Unit]
Description=Post reboot action
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/post_reboot.sh
# 执行一次后就删除自己
ExecStartPost=/bin/bash -c 'systemctl disable post-reboot.service'

[Install]
WantedBy=multi-user.target
EOF

执行服务：sudo systemctl enable post-reboot.service
执行重启：reboot。
* 重启后，post_reboot.sh 会自动执行一次
* 执行完会自动把自己 disable 掉，不会下次开机再触发
```
4、shell中对于sudo 命令的使用。
sudo echo 'abc' >> /tmp/test.sh              #对应非sudo无权限执行的用户来说，这个无法执行。 （重定向操作不继承 sudo 的权限） 
核心原因是 重定向操作（>>）不受 sudo 权限提升的影响  
a. sudo 会提升 echo 命令的权限
b.但 重定向操作 >> /tmp/test.sh 是由当前 shell 进程执行的，而非 sudo 提升权限后的进程。 也就是说，>> 操作的权限依赖于 当前登录用户的权限，而非 sudo 赋予的 root 权限。     
实现方法1：
sudo bash -c "echo 'abc' >> /tmp/test.sh"
方法2：
echo 'abc' | sudo tee -a /tmp/test.sh > /dev/null

5. shell矫正思路
```
function get_result_samplerate()
{
  ssh_fun $1 "/bin/bash -s"  << EOF |tee -a ${DATE_LOG}/result.csv
  for sn in \$(lxc-ls); do
  SAMPLERATE_INFO=\$(lxc-attach -n "\$sn" -- egrep "^ro.audio_in.samplerate" /vendor/build.prop 2>&1)  
  echo "$1,\$sn,\${SAMPLERATE_INFO:-null}"
  done
EOF
}
#这个是正确写法。因为lxc-attach 在并发高的情况下，可能无法进入虚机。报错：lxc-attach: 3: ../src/lxc/attach.c: get_attach_context: 406 Connection refused - Failed to get init pid。因为单片物理机执行是不会复现的。 你用 2>&1  ,也会得到将错误信息输入到了 这个变量中，是可以找出问题的。如果没有的话，无法获取错误结果。 下面是更错的一种思路写法：

#function get_result_samplerate()
#{
#  ssh_fun $1 "/bin/bash -s"  << EOF |tee -a ${DATE_LOG}/result.csv
#  for sn in \$(lxc-ls); do
#  SAMPLERATE_INFO=\$(
#        lxc-attach -n "\$sn" -- cat /vendor/build.prop |grep ro.audio_in.samplerate || echo 0
#    )
#  echo "$1,\$sn,\$SAMPLERATE_INFO"
#  done
#EOF
#
#}
#综上，这种写法 若是lxc-attach 无法进入，直接会echo 0，会让你误认为是 没有这个配置，那么结果就大大错误了。很容易造成线上的问题。所以我们不能这么草率的写 || .尤其是云手机层面，意外错误太多。
而且若是没有/vendor/build.prop 这个文件，也会echo 0，也不准确，应该2>&1 有错误结果。 且 若是没有该配置，后续扫描尽量用变量去表达，即：${SAMPLERATE_INFO:-null}
```
6. 针对于云手机与物理机的关系。尽量在物理机层面去做工程。好处是：方便处理与回验。
   * 处理方面：若是采用云手机层面。首先通过物理机lxc-attach，这个方式并不可靠。云手机异常或者被重启极大可能，还有未知问题。脚本也不好写，以及/vendor 一般都是ro。还需要remount，这个非常难
   * 采用物理机层面，不会随意重启。配置文件也相对固定。可以加-f 检测文件存在则执行，可以先进行一次扫描即可。具体看打脚本中的samplerate。
  
7.  
android12=$(ls -1d /data/lxc_volumns/super_? 2>/dev/null)
      if [ -n ${android12} ];then              #这种表达式错的，会报错，参数太多
原因：
```shell
当 android12 变量包含 多个值（如匹配到多个目录：/data/lxc_volumns/super_1 /data/lxc_volumns/super_2）时，未加双引号的 ${android12} 会被 Bash 拆分为两个独立参数。
#此时条件判断会变成：[ -n /data/lxc_volumns/super_1 /data/lxc_volumns/super_2 ] #这种表达式错的，会报错，参数太多

解决办法：需对 所有条件判断中的变量 和 循环中的路径变量 添加双引号，确保 Bash 将变量值视为一个整体。
修复后，即使变量包含多个值，Bash 也会将其视为一个整体：
当 android12 有多个目录时，"${android12}" 会被当作 一个字符串参数 传递给 [ -n ]，条件判断变为：
[ -n "/data/lxc_volumns/super_1 /data/lxc_volumns/super_2" ]。 即：双引号内为一个整体。
此时 [ -n ] 仅接收 1 个参数，判断变量非空，不会报错。
```
8. 如果需要检测的配置项太多，可以用 && && && && echo success || echo failed  #这种去判断前面的结果都正确后才可以输出success
9. cat tongji.log|egrep '[0-9] $'|wc -l         可以通过这个来区分，0-9 的任意一个数字。
## 数组相关理解
1. 关联数组定义.  核心区别在于元素的存储和访问方式
   * 定义关联数组，顺序不规定。通过key去找值.用自定义 key（键，如字符串、数字） 存储元素
               declare -A cloudphone_memory
   * 定义索引数组，适合严格按照顺序插入.用默认数字索引（0,1,2...） 存储元素
               declare -a cloudphone_memory=()
  * 不提前声明，直接使用。 
                 * 若不声明，直接写 user["name"]="Alice"，Bash 会自动创建关联数组；
                 * 若不声明，直接写 fruits[0]="apple"，Bash 会自动创建索引数组。
       * 不提前声明可能遇到的问题：若之前有同名的普通变量（非数组），不声明直接赋值会报错，而提前声明会强制将其转为数组：
```
user="Bob"  # 普通变量
user["name"]="Alice"  # 报错：user 是普通变量，不能当数组用

declare -A user  # 声明为关联数组（强制转换） 
user["name"]="Alice"  # 成功
#早期 Bash 版本（<4.0）不支持关联数组，必须声明才能使用；索引数组则无此限制。
```
#综上，建议：
若需要 “键值对” 存储（如 name→Alice），用关联数组 declare -A；
若需要 “有序列表”（如 [0]→apple, [1]→banana），用索引数组 declare -a；
提前声明不是必须的，但写脚本时加上，代码会更易读、少出错。
```shell
# 1. 关联数组（通过 key 访问）
declare -A user  # 声明关联数组
user["name"]="Alice"
user["age"]=25
echo "姓名：${user["name"]}"  # 输出：姓名：Alice（通过 key 找值）

# 2. 索引数组（通过索引访问）
declare -a fruits  # 声明索引数组
fruits+=("apple")
fruits+=("banana")
echo "第2个水果：${fruits[1]}"  # 输出：第2个水果：banana（通过索引0,1...找值）
```
2. 数组定义
       fruit=(apple banana)  #“创建 / 覆盖数组”
       fruit+=(apple banana banana)       # “向已有数组添加元素”  当然这个可以拆分为：
```
fruit=()               # 初始化空数组
fruit[0]="apple"       # 第一个元素（索引0）
fruit[1]="banana"      # 第二个元素（索引1）
```
#综上，举例说明
```
# 示例：向数组添加元素
fruit=("orange")          # 初始数组：(orange)
fruit+=("apple" "banana") # 追加后：(orange apple banana)
echo "${fruit[@]}"        # 输出：orange apple banana（原有元素保留）
```
3. 综上理解后，可以记忆如下数组：
  * 数组创建：数组名+=("元素") 最常用，提前定义加 declare -a；
  * 元素访问：${数组名[索引]}，全体元素用 ${数组名[@]}；
  * 长度获取：${#数组名[@]}（# 号 + 数组名）；
  * 拼接字符串：$(IFS=分隔符; echo "${数组名[*]}")（* 号带星，按分隔符拼接）
```
phy_file=$(IFS=':'; echo "${file_array[*]}") 是将数组元素用指定分隔符（这里是 :）拼接成字符串的.
区别：
${数组名[*]}：展开数组所有元素，用 IFS 的第一个字符分隔；
${数组名[@]}：展开数组所有元素，每个元素作为独立字符串（遍历数组时常用）；
IFS=,; 是临时修改分隔符，只在当前 $() 环境中生效，不影响全局。
```
4. 数组模板，# 用于存放多个变量输出。主要用于同一个物理机的多个变量输出拼接的方式
```
#提前理解：
for file in $(grep wang root_keys.sh);do echo 1223;done           #这个由于grep 过滤的内容为空。所以这个for 循环不会执行

function get_phy_filelog() {
  ssh_fun "$1" "/bin/bash -s" << EOF | tee -a "${DATE_LOG}/result.csv"
    # 初始化数组存储文件路径和对应的数量
    declare -a file_array=()
    declare -a num_array=()
    
    # 查找匹配的文件（跳过二进制文件）
    files=\$(grep -i irq_status -rl /var/log/* -I)
    
    # 遍历文件并填充数组
    for file in \$files; do                                #所以这里的file 变量无值的话，不会被执行。不需要判断if 是否存在。
  #    if [ -f "\$file" ]; then
        num=\$(grep irq_status "\$file" --text | wc -l)
  #    else
  #      num="null"
  #    fi
      file_array+=("\$file")
      num_array+=("\$num")
    done
    
    # 处理无文件的情况
    if [ \${#file_array[@]} -eq 0 ]; then
      file_array=("null")
      num_array=("null")
    fi
    
    # 拼接数组元素为字符串（用冒号分隔）
    phy_file=\$(IFS=':'; echo "\${file_array[*]}")              #双引号的作用是：将变量值视为一个整体。空格和换行不会被解析为 “字段分隔符”。这样会在csv中提现到。csv 如何在一个空格中输出多行的问题。需要加双引号，不然可能会导致出现多行的问题。
    phy_num=\$(IFS=':'; echo "\${num_array[*]}")
    
    # 输出结果
    echo "$1,\$phy_file,\$phy_num"                     
EOF

}
提示：双引号的用法。记住口诀：“变量引用加双引，空格特殊不担心，空值判断更分明”。
1、变量中包含 *、?、$ 等特殊字符时，双引号会使其按字面意义处理，不触发通配或变量扩展
file="a*.txt"
echo $file       # 输出当前目录中所有以 a 开头、.txt 结尾的文件（通配符生效）
echo "$file"     # 输出：a*.txt（特殊字符按字面显示）
2、当变量为空时，双引号会保留其 “空字符串” 属性，避免被解析为 “无参数”。[ ] 即test 在判断为无参数时，恒为真，会出现问题。如下：所以加双引号。
[mci_opert@XJP-10.4.50.1 wangyulong]test -n && echo 234
234
[mci_opert@XJP-10.4.50.1 wangyulong]test -n "" && echo 234
3、空格被当作分隔符：变量中的空格会导致内容被拆分成多个字段（类似按空格分割数组）。
name="Alice Smith"
echo $name       # 输出：Alice Smith（看似正常，但实际是巧合）
echo "$name"     # 输出：Alice Smith（正确保留空格）

# 关键区别：在循环中
for word in $name; do    # 按空格分割成两个元素：Alice 和 Smith。1个变量被分隔为2个。由于未加双引号。
  echo $word
done
# 输出：
# Alice
# Smith

for word in "$name"; do  # 整个字符串作为一个元素
  echo $word
done
# 输出：
# Alice Smith

########综上，优化后为：
function get_phy_array_filelog() {
  ssh_fun "$1" "/bin/bash -s" << EOF | tee -a "${DATE_LOG}/result.csv"
    # 初始化数组存储文件路径和对应的数量
    declare -a file_array=()
    declare -a num_array=()
    
    # 查找匹配的文件（跳过二进制文件）                  
    files=\$(grep -i irq_status -rl /var/log/* -I)
    
    # 遍历文件并填充数组
    for file in \$files; do                              
        num=\$(grep irq_status "\$file" | wc -l)
      file_array+=("\$file")
      num_array+=("\$num")
    done
    
    # 处理无文件的情况
    if [ \${#file_array[@]} -eq 0 ]; then
      file_array=("null")
      num_array=("null")
    fi
    
    # 拼接数组元素为字符串（用冒号分隔）
    phy_file="\${file_array[*]}"
    phy_num="\${num_array[*]}"
    
    # 输出结果
    echo "$1,\$phy_file,\$phy_num"
EOF
}

##提示：
上面的跳过二进制文件：
      -I选项的含义是如果文件是二进制文件，则不搜索该文件 。
      -a 选项的含义是：-a选项的含义是将二进制文件视为文本文件进行处理，也可以写成--binary-files=text。
  例如： grep -a "getConfig" manage-agent.log.20250918

  # 输入?，后面跟上要查询的指定字段，例如要查询error，则输入?error。 这样会直接定位到最后面。  n 往下翻。 N 往上翻。

## 批量过滤文件
  for i in `ls *_cloud`;do grep -x -f tmp.txt $i;done 

# -f tmp.txt：从tmp.txt文件中读取 “搜索模式”（即把tmp.txt中的每一行作为一个要查找的关键词）。
-x：精确匹配整行内容（全字匹配）。只有当被搜索文件（$i）中的某一行与tmp.txt中的某一行完全一致时，才会被匹配并输出。
（例如，tmp.txt中有123，则1234或a123不会被匹配，只有123整行才会被匹配）。
```
#### 采用shell 去判断一个物理机的多个变量值的模板
```
function get_phy_filelog()
{
  ssh_fun "$1" "/bin/bash -s" << EOF | tee -a "${DATE_LOG}/result.csv"
     curr_num=""
     curr_file="null"
     for file in \$(grep -i irq_status -rl /var/log/* -I);do
        NUM=\$(grep irq_status \$file|wc -l)

   curr_file=\$(echo "\$curr_file:\$file")
   curr_num=\$(echo "\$curr_num:\${NUM:-null}")
    done
    PHY_NUM=\$(echo \$curr_num|sed 's/^://')                 #核心点，这里使用拼接的方式。
    PHY_FILE=\$(echo \$curr_file|sed 's/^://')
    echo "$1,\$PHY_FILE,\$PHY_NUM"
EOF
}
```
#### 采用shell 实现：1个物理ip，多个虚机ip的情况，只需要for循环即可
```
function get_phy_samplerate()
{
  ssh_fun "$1" "/bin/bash -s" << EOF | tee -a "${DATE_LOG}/result.csv"
    for file in \$(ls -1 /data/lxc_volumns/super_?/vendor/build.prop); do
      if [ -f "\$file" ]; then
        SAMPLERATE=\$(grep 'ro.audio_in.samplerate' "\$file" || echo "null")
      else
        SAMPLERATE="error"
      fi
      echo "$1,\$file,\$SAMPLERATE"                    #每次for循环，即echo 一次ip即可实现。
    done
EOF
}
```

#### 采用shell 实现：密钥对分发
```
function new_root_key
{
   new_pub=$(cat key/wsy_ds02.pub)
   ssh_fun $1 "sed -i '/^$/d' /root/.ssh/authorized_keys && echo ${new_pub}>>/root/.ssh/authorized_keys"
}
```

#### 采用shell 去备份system命令
```
原始命令是否存在。以及查看为755
for sn in $(lxc-ls);do lxc-attach -n $sn -- ls -lrt /system/bin/mciu; done
for sn in $(lxc-ls);do lxc-attach -n $sn -- ls -lrt /system/bin/xu; done
备份
for sn in $(lxc-ls);do mv /data/lxc_volumns/super_$sn/system/bin/xu /data/lxc_container/data/$sn/local/tmp/xu.bak;done
for sn in $(lxc-ls);do mv /data/lxc_volumns/super_$sn/system/bin/xu /data/lxc_container/data/$sn/local/tmp/xu.bak;done

工程
上传mciu。授权chmod 755 mciu
for sn in $(lxc-ls);do rsync -a /data/local/tmp/linshi/mciu /data/lxc_container/data/$sn/local/tmp/;done
for sn in $(lxc-ls);do rsync -a /data/lxc_container/data/$sn/local/tmp/mciu /data/lxc_volumns/super_$sn/system/bin/;done

回验即可。
```

#### 采用shell 去本地物理机去实现，1个物理ip。多个虚机ip。重复调用函数的情况。 若是想1个物理机ip，和多个虚机在一行，并用：分隔，可以参考之前的checklist脚本或者memory_scan.sh 脚本。
```
#! /bin/bash
# description: checklist脚本

# 仅支持debian系统

#版本号
VERSION='1.0.1'

# 配置信息路径
DEVICE_UPDATE="/data/local/device_update"

# 定义变量
## 物理机层
DEVICE_IP=""                # 物理机IP
# 定义关联数组
declare -A cloudphone_memory

#容器层
VM_NUM=""                   # 虚机数量
VM_STATUS=""                # 虚机启动状态(1, 正常;0 ,异常)，比如，3个容器：1:1:1
SOFTWARE_VER=""            # 软件包版本
RESOURCE_VERSIONS=""      # 资源包版本，比如，3个容器：1.0.0:1.0.1:1.0.0
CPU_INFO=""               # CPU使用率
GPU_INFO=""               # GPU使用率
APP_INFO=""               # 应用信息


# 获取物理IP和mac地址
function getDeviceIp() {
    #DEVICE_IP=$(ifconfig br0|sed  -rn '2s/^[^0-9]+([0-9.]+) .*$/\1/p')
    DEVICE_IP=$(ifconfig | grep -w "inet" | grep -v "127.0.0.1" | awk '{print $2}' | head -n 1)
}

# 获取软件包版本
function getSoftwareVersion() {
    SOFTWARE_VER=$(cat /data/local/device_update/cloudphone_info.conf | grep common.version | awk -F '=' '{print $2}')
}
# 获取资源包版本
function getResourceVersion() {
    local sn=$1
    RESOURCE_VERSIONS=$(
        a_raw=$(lxc-attach -n "$sn" -- cat /system/etc/.resource_package_version)
        a=($a_raw)
        a=${a[-1]}
        echo  $a
     )
}

function getCpuInfo (){
    local sn=$1
    CPU_INFO=$(
        lxc-attach -n "$sn" -- uptime
    )
}


function getGpuInfo  () {
    GPU_INFO=$(
        lxc-attach -n "$sn" -- cat /sys/class/devfreq/fb000000.gpu/load     #这里的$sn 表示为虚机的sn。for循环会传参。。arm设备也可以查看。rootfs 收集这个大概是1h一次
        echo
    )
}

function getAppInfo  () {
    local sn=$1
    APP_INFO=$(
        lxc-attach -n "$sn" -- ps -A|egrep -v "NAME|ps" |awk '{print $NF}'|tr '\n' '|'
    )
}

function getData() {

     getDeviceIp

for sn in $(lxc-ls); do                                         #将for 循环放到一个函数中，再去调用不通的函数。
    getSoftwareVersion "$sn"
    getResourceVersion "$sn"
    getCpuInfo "$sn"
    getGpuInfo "$sn"
    getAppInfo "$sn"
    echo "$DEVICE_IP,$sn,$SOFTWARE_VER,\"$RESOURCE_VERSIONS\",\"$CPU_INFO\",\"$GPU_INFO\",\"$APP_INFO\""          #每次一个for循环都会echo ip 和对应的值。
done
}

function main() {
    getData
}

main
```
#### 经常用到的云手机执行命令的函数模板

```
待补充：
```
## upload_batch 大脚本的各种场景适配
1. 在 upload_batch.sh 的大脚本中，当执行某个函数时，会遇到卡死。为了解决该问题：timeout 1600 ssh -p ${ssh_port:-62485} ${PARAM} root@$1 "$2"  或者timeout 12m ssh -p ${ssh_port:-62485} ${PARAM} root@$1 "$2"
2. 
## pass各服务问题定位
### 服务汇总，manage-proxy manage-agent ctrl-server
```
服务用户(paas)
 manage-proxy 与 manage-server
一、检查proxy服务是否正常（一般场景是：大量pass状态离线、任务执行失败。==要检查proxy节点是否正常）
1、看进程    vip位置。以及vip脚本是否正常
2、有进程，看日志
cd /data/paas/base-service/manage-proxy/node节点/logs
3、过滤看是否出现  heartbeat  心跳检测或者 过滤 connected
二、manage-proxy 与 manage-server 的关系， proxy、server 互相链接 的服务。（例如：paas后台的一个重启任务，pass后台给到server，server给到proxy。再去给设备。 回调相反即可。）
manage-server 由其他同事管理

三、大量pass状态离线、任务执行失败。==要检查proxy节点是否正常
检测方法。例如：11.14.4.80
1、 arm设备telnet proxy 的ip和端口 是否通
arm设备： ps-ef|grep mange-agent              #manage-agent 10.6.42.218:7918  这个ip:端口即proxy的ip和端口
这个telnet通代表了进程是存在的，服务是否正常还需要进一步排查。
2、看日志
cd /data/paas/base-service/manage-proxy/node节点/logs  #cat 后出现：connection refused  
这个代表的是无法连接管理服务。即：manage-server
现象：pass后台执行任务失败（例如：重启remote-play），pass报错：mange-proxy节点链接失败。一般就是 manage-proxy的配置文件错了  或者是  manage-server 服务
a. 进入manage-proxy的配置文件
cat run.sh |grep manage_server。 再配合ps -ef|grep mange-proxy 可以看参数对应的意义
-a :manage_server_ip
-p :manage_server_port
-n : node_name
-P : node_port
-t : status_timeout

确定 server的ip 端口是否可以telnet 通。 在 manage-proxy节点测试。
b. 确定mange-server 的信息（通过node-name去查询）
manage-server 的ip 和端口，  可以通过243 服务器进行查看对应的ip和端口。

设备--proxy--管理服务--paas

通过243  过滤#查看节点编号node_name=DRILL-MANAGE-PROXY-01
vi /data/mci/kioa/_ansibleBasic/base-service/hosts-manage-proxy-vip     例如：

[proxy_drill_vip_01]

PROXY-DRILL-VIP-01    node_name=DRILL-MANAGE-PROXY-01    manage_proxy_port=7918    manage_server_ip=10.6.218.203   manage_server_port=8988

[proxy_drill_vip_01:vars]
ansible_host=10.6.42.218

c.
去42.115 上看  ps-ef|grep proxy      #看到的是 manage——proxy -a -p   #表示管理-server的ip和端口8988，检测是否一致。
若不一致： 更改run.sh后
sh run.sh stop 后会自动拉齐proxy进程。再去看看日志即可。
########################
推流演练：控制+nginx （一一对应） ：推流不到控制节点，就会黑屏。

 控制（控制节点）是一个池子，用户链接后随机分配。是否分配有pass后台对应节点是否启用决定。节点ip对应的是x86地址
提示：一台服务器上可能部署了多个节点，有相同ip的多个端口
控制是用来推流的，用户的画面。
proxy是用来管理设备一些任务状态         推给remote-play后展现出来。

控制节点： 节点类型 这里可以查到。

https://manager-prod.cloud-control.top/armvm-console-manager/facility/pad/connectDevice?padCode=VM010248007067&packname=&controlIp=paasdrillc.armvm.com&controlPort=10027&sessionId=console966297cfca834aa48b191ca31a387505&userId=8184381

解释： 
1、
10027 就是websocket端口，禁用掉一个后，去自动切换到其他节点。      端口逻辑，在pass后台中的控制节点中： 有节点端口 和 websocket（NG） 端口。-----转给节点端口 。提示：websocket 最后一位的7是固定的。
websocket 的中间编号代表了 节点编号。（百+千位）
节点端口：例如：10020 代表第2个节点  10160  代表第16个节点。
2、
controlIp  就是节点ip的域名

控制服务+ remote 是一组
管理-proxy + manage-agent 是一组。

3、control-server 重启会生成一个新进程
```
## F12定位问题汇总
云手机黑屏f12定位如下：
![f12定位方法](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/f12%E5%AE%9A%E4%BD%8D%E9%94%99%E8%AF%AF.JPG?raw=true)\

F12 清除cookie方法：
* 进入后，点击与network 同栏的Application -------Storage（会展开有个cookies）------Cookies展开后点击url，右键：Clear

## 各值班问题汇总
1、 针对于命令执行失败的问题解决  
a. 一般都是命令不通。例如dg dgbak  或者am ams  。cp 或者mv 一份即可。但是有些没有权限操作
b.  简单有效的办法是去：物理机直接cp 一份到对应的虚机目录下。这样不会担心没有权限的问题。也不用有额外的操作。

2、 dns错误导致 www.baidu.com 无法解析（未尝试，一般reboot即可恢复）
```
1、dumpsys dnsresolver           #可以看到dns为：10.255.255.242（当时未启用，导致dns解析出问题）
2、第二种查询方式
getprop | grep dns
[net.dns1]: [10.255.255.242]            #这个可能是由于设置了：net_override_dns=10.255.255.242
[ro.net.provisioned.dns]: [10.255.255.240,10.255.255.240]           #这个未启用
3、
执行 settings list system｜grep dns（设置的覆盖分辨率 导致）

4、想要恢复默认dns：
settings put secure net_override_dns 10.255.255.240；settings delete secure net_override_dns;         #出现2中dns修复方法
```
3、开启adb权限，又称为绑定adb 
```
将 /data/local/container/manage.conf 文件中的adbSwitch=0 改为 adbSwitch=1
将 sys.powerboot.adbd=ture 追加到 /data/lxc_volumns/system_0/build.prop (不通的安卓版本目录不一样)

##### 手动执行命令为（无需重启生效）：dg config -a system.adb=true;setprop persist.adb.auth false;stop adbd;start adbd
进入虚机执行：
netstat -tnlp             
#可以看到：
tcp6       0      0 :::5555                 :::*                    LISTEN      31637/adbd              #5555  客户端端口     
tcp6       0      0 :::5557                 :::*                    LISTEN      31637/adbd              #5557 服务端端口
有这个进程和端口存在的情况下，我们可以尝试去adb 连接查看
243 ansible用户： 
adb connect  云手机ip， 连接后 adb shell  即可进入云手机shell中。如下
[ansible@guangzhou016243 ~]$ adb connect 10.55.196.86
connected to 10.55.196.86:5555
You have new mail in /var/spool/mail/ansible
[ansible@guangzhou016243 ~]$ adb shell
error: more than one device and emulator               #这里报错，已有设备进入了。

补充： 
查看当前adb连接的设备信息： adb devices     
断开指定adb： adb disconnect 10.55.224.40:5555
断开所有adb： adb disconnect

```
5. rclone 备份日志： /data/local/tmp/rclone_backup_${vmSn}下面有日志
   报错如下
```
root@mciserver:/data/local/tmp/rclone_backup_0# cat rclone.log
2025/09/30 16:40:10 NOTICE: S3 bucket cloudphone-save-cn-baoding: Streaming uploads using chunk size 5Mi will have maximum file size of 48.828Gi
2025/09/30 16:40:11 ERROR : snap__VM010048247103__20250930__1390424922207141553: Post request rcat error: multipart upload failed to initialise: create multipart upload failed: operation error S3: CreateMultipartUpload, https response error StatusCode: 400, RequestID: , HostID: , api error BadRequest: Bad Request
2025/09/30 16:40:11 NOTICE: Failed to rcat with 2 errors: last error was: multipart upload failed to initialise: create multipart upload failed: operation error S3: CreateMultipartUpload, https response error StatusCode: 400, RequestID: , HostID: , api error BadRequest: Bad Request

#这个报错是说，在使用 rclone 进行备份时，尝试通过分块上传（multipart upload）的方式把名为 snap__VM010048247103__20250930__1390424922207141553 的文件上传到 S3 兼容存储桶 cloudphone - save - cn - baoding 时失败了。
错误原因是创建分块上传的请求（CreateMultipartUpload）被返回了 400 Bad Request，也就是云存储服务认为这个上传请求是非法的，可能是因为请求里的参数不符合要求，或者存储桶、访问密钥等配置有问题。

```
## 值班服务问题汇总。有各种服务地址问题：优先去243 的ansible上查看。
### 反馈机房网络延迟数值很高，判断是否和推流有关系
#### 登录243：ansibles    cd /data/mci/kioa/_ansibleBasic/base-service
```
1、先登录ARM机器上看看P2P日志，可以看remote的相关日志。查询方式如下：
cat remote-play.log.5.20251011  | grep -i "10:0[0-9]:" |egrep-i 'loss' --color                  #查看remote 中的cum_loss 丢失情况
cat remote-play.log.5.20251011  | grep -i "10:0[0-9]:" |egrep-i 'rtt_ms' --color                #查看rtt_ms 网络交付延迟，代表网络延迟
cat remote-play.log.5.20251011  | grep -i "10:0[0-9]:" |egrep"encoding_fps" --color             #查看推流fps 情况

日志可以看到：
WebRTC（Web Real - Time Communication），即网页实时通信，是一项免费开源的技术标准与框架，让浏览器、移动应用等能在无需额外插件或软件的情况下，直接实现实时音视频通话、数据传输 ，广泛用于视频会议、在线教育、直播连麦等场景，以下从核心功能和理解角度拆解：

rtt_ms  :即往返时延，单位是毫秒（ms）.一个数据包往返一次的时间是 65 毫秒  
retransmit_bps 是 重传数据的比特率，单位是比特每秒（bps） 。 133008 bps 意味着当前每秒有 133008 比特的数据在进行重传操作。重传率高（该数值大），通常反映网络存在较多丢包、不稳定的情况，可能导致视频画面花屏、卡顿，因为需要不断补发数据来填补丢失的内容. 这里高通常会看到cum_loss 也会高  
cum_loss 是 累计丢包数 。 指从通话开始到当前时刻，发送出去但未被成功接收（也未通过重传等机制弥补）的数据包总数。这里 140 就是累计丢包的数量  
这些指标都是用于衡量 WebRTC 视频通话过程中网络传输质量和稳定性的关键参数，通过它们能排查网络延迟、丢包、重传等问题对通话体验的影响。

##在视频处理（比如 WebRTC 相关的视频捕获、编码流程）场景中，interval 通常表示两次捕获操作、编码操作或者相关统计事件之间的时间间隔（单位一般为微秒或毫秒，需结合具体上下文判断）。它可以帮助开发者或运维人员了解视频处理过程中各项操作的时间节奏，比如视频帧捕获的间隔是否稳定、编码操作的时间间隔是否符合预期等，进而用于分析视频处理的性能、稳定性等情况。
```

#### 值班汇总1：客户端流量使用高
这个和后台配置的码率策略有关，这台设备申请了8Mbps码率，回退成2Mbps的码率，符合用户反馈的流量有上涨的情况。----之前有反馈过，分析是画面清晰度码率调整到8M引起
当然，这个图片也可以看到帧率的大小：framerate ：50fps  
提升8Mbps、50fps的事情，可以咨询产品设置的范围，只要是把码率提升到8Mbps，用户使用的流量是会上涨，符合预期
![查看码率问题](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/remote-play%E6%9F%A5%E7%9C%8B%E7%A0%81%E7%8E%87.JPG)


#### 值班问题1 控制服务主故障1分，切到备机，备机内存条有问题，导致服务异常引起的故障。
1、tail -f control-server-worker_ZHTW-PAD-CONTROL-01_20250715-194617.239150
检测日志有正常输出


2、/etc/keepalived/keepalived.conf  为keepalived 的配置文件可以过滤出201vip 使用的检测脚本是哪个。

    script "/home/ctlserver/HA/sh/ha_switch.sh"
    notify_master "/etc/keepalived/notify.py master"
    notify_backup "/etc/keepalived/notify.py backup"

3、通过查看/home/ctlserver/HA/sh/ha_switch.sh。发现每几秒执行这个脚本：/home/ctlserver/HA/sh/process.sh stop (vip 已经飘走)

4、/home/ctlserver/HA/sh/process.sh 可以看到都执行了：/home/ctlserver/HA/sh/chk_nginx.sh

declare -a all_processes_config=(
"root  $SHELL_PATH/  chk_nginx.sh  null  null  root  chk_nginx  null"
)

5、[ctlserver@TW-10.6.181.1 logs]cat check_process.log-20250714 |grep "23:05:"
---------- start app on all nodes ... [ 2025-07-14 23:05:10 ] -----------
---------- start app on all nodes ... [ 2025-07-14 23:05:19 ] -----------
---------- start app finish ... [ 2025-07-14 23:05:19 ] -----------------
---------- switch to backup server ... [ 2025-07-14 23:05:19 ] ----------               #可以看到切换到了备机

6、[ctlserver@TW-10.6.181.1 logs]cat /var/log/messages |grep VI_2
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Changing effective priority from 100 to 95
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Received advert with higher priority 99, ours 95
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Entering BACKUP STATE
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) removing protocol VIPs.
Jul 14 23:06:37 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Changing effective priority from 100 to 95
Jul 14 23:06:43 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Changing effective priority from 95 to 100
Jul 14 23:53:53 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Transition to MASTER STATE
Jul 14 23:53:54 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Entering MASTER STATE
Jul 14 23:53:54 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) setting protocol VIPs.
Jul 14 23:53:54 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Sending/queueing gratuitous ARPs on bond0 for 10.6.181.201
Jul 14 23:53:59 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Sending/queueing gratuitous ARPs on bond0 for 10.6.181.201

##################
7、[ctlserver@TW-10.6.181.1 logs]cat /var/log/messages |grep -C 10 VI_2
Jul 14 23:05:06 tw181001 systemd-logind: Removed session 48555217.
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: Process [68139] didn't respond to SIGTERM
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: Process [68140] didn't respond to SIGTERM
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: Process [68141] didn't respond to SIGTERM
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: pid 68139 exited due to signal 9
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Script(ha_switch_redfinger) timed out
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Script(ha_switch) timed out
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Script(ha_switch_proxy) timed out
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_8) Changing effective priority from 100 to 95
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_3) Changing effective priority from 100 to 95
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Changing effective priority from 100 to 95
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: pid 68140 exited due to signal 9
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: pid 68141 exited due to signal 9
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: /home/redfinger/HA/sh/ha_switch.sh exited due to signal 15
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: /home/ctlserver/HA/sh/ha_switch.sh exited due to signal 15
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: /home/manageproxy/HA/sh/ha_switch.sh exited due to signal 15
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_1) Received advert with lower priority 99, ours 100, forcing new election
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: Sending gratuitous ARP on bond0 for 10.6.181.240
#### 值班问题2：toc主营海外零散报备：虚机离线、受控离线等问题
1. 进入arm设备，kill manage-agent 进程后，一般会自动拉启remte-play 进程。 所以需要检测该进程是否存在。   
2. remote-play 进程异常，需要进入remote-play 目录下查看报错日志： remoteEXIT  
```
grep err:如下日志
[ERR][08 27 13:35:50.572 15726][Qcom865PCMSource]updateConfig, audio_config param error, samplerate:0, channels:0, buf_size:0      #这表明音频配置参数存在问题，采样率（samplerate）、声道数（channels）和缓冲区大小（buf_size）都被设置为 0，这是无效的配置。通常这可能是由于音频设备驱动问题、配置参数传递错误或音频服务异常导致的。
[ERR][08 27 13:35:50.573 15726][EventConnection]id:1, onEvent, get an error on the connection errno:111          #errno:111 对应 "Connection refused"（连接被拒绝），说明某个进程尝试连接到另一个进程，但目标进程没有在指定端口上监听，或者连接被防火墙 / 权限阻止。结合前面的音频配置错误，这可能是音频相关服务未能正常启动，导致后续连接尝试失败。
[08 27 13:36:03.586 15726][BusinessProcess]onCheckPackageName, app:com.android.settings, errorcode:0              #这行日志显示检查包名（com.android.settings，即系统设置应用）时返回了错误码 0，通常表示操作成功，可能与前面的音频错误无关。

#日志中看到status=0 或者1  只是状态，非报错。 errorcode:0 代表无错误码。
服务端出问题根因：
#刷机的arm设备，大批量未交付的由于证书未刷，将一直请求remote-play 服务端，造成积压，正常设备无法请求处理的问题。如下未交付arm设备报错：
[08 27 13:24:47.421 41796][PadInfo]initFromConfigFile, ErrorPostAddr:https://check.redfinger.com
[ERR][08 27 13:24:47.439 41796][remote-service]Failed to load server certificate, error:02001002:system library:fopen:No suchfile or directory

```
1. 经过验证，主营海外平台显示 虚机离线、受控离线的问题。是由于remote-play 的上游积（即：**会话**造成了积压）压导致。 可以造成arm设备显示无ip，但是手动可以启动的问题。
排查思路：


4. 补充：错误码，可以过滤remote-play 的errcode
[08 27 16:41:15.309 34687][SessionPAAS]id:18, onDisconnected, errcode=196615, checking_error=0, mSessionStatus:0
#### 值班问题3：防火墙iptables问题 检测是否正常
```
1、检查是否开启了转发
// 临时生效，永久生效，需要修改/etc/sysctl.conf文件
echo 1 > /proc/sys/net/ipv4/ip_forward   
```

2、检查p2p规则中是否开启了MASQUERADE 转发， 匹配-j 这种，grep 后需要加 -- ，否则报错。
```shell
cat /etc/sysconfig/iptables |grep -- "-j MASQUERADE"      # -- 标记的作用是 “终止选项解析”，告诉 grep 后续的内容都是要匹配的字符串，无论是否以 - 开头，都不会被当作选项处理。     
```
补救方法：  
```shell
cat /etc/sysconfig/iptables |wc -l ; iptables -t nat -A POSTROUTING -j MASQUERADE && service iptables save; cat /etc/sysconfig/iptables |wc -l

#补充：
iptables -t nat -vnL | awk '$11 !~ /:/ {print $0}'          #grep 看无：的有12行
即：
[root@CShan-10.6.234.173 tmp]iptables -t nat -vnL | awk '$11 !~ /:/ {print $0}'
Chain PREROUTING (policy ACCEPT 748 packets, 66124 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain INPUT (policy ACCEPT 748 packets, 66124 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 664 packets, 41716 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
2340K  146M MASQUERADE  all  --  *      *       0.0.0.0/0            0.0.0.0/0               #可以看到MASOUERADE 转发
```
3、zbbix查看是否有p2p节点，网卡流量变化
4、可以查看/proc/net/nf_conntrack 这个文件中是否有流量。
```
ls -lrt /proc/net/nf_conntrack             #有时间变化。
```
5、检测p2p域名：端口 是否 telnet 通。不通用具体的case找网络解决。 
```
场景1：p2p规则冲突导致，可以使用243的python脚本查看。 手动查看方法，用具体的case。grep 本地的DNAT端口，是否有冲突即可。
提示，当然也可以用整体端口是否冲突来检查
iptables -t nat -vnL|awk '{print $11}'|awk -F: '{print $2}'| sort|uniq -c|sort -rn |head             #过滤。忽略12行的空白统计次数。从第二行开始大于2的dport 即为本地端口重复，需要删除冲突的规则，见最下面的解决步骤
例如：
[root@CShan-10.6.234.173 tmp]iptables -t nat -vnL|awk '{print $11}'|awk -F: '{print $2}'|sort |uniq -c|sort -rn |head
     12
      2 27488              #正常，一般有tcp、udp 2种
      2 27487
      2 27486
      2 27485
      2 27484
      2 27483
      2 27482
      2 27481
      2 27480

场景2：网络出现问题，域名 端口，telent 不通。
提示：p2p 的域名服务器的端口：在p2p服务器上线的时候就已经开通了any端口到公网使用。所以这个在哪里telnet都可以测试。

补充：p2p刷机完成后，要进行校验，grep 过滤要加关键字to：防止隐性源ip未出现被匹配
################p2p过滤：iptables回验

cat /etc/sysconfig/iptables |egrep "11.20.217.|11.20.222."|wc -l             #因为临时规则，所以一般用文件去过滤
#################
[root@CShan-10.6.234.169 tmp]iptables -t nat -nvL|egrep "to:11.37.3.|to:11.37.44.|to:11.37.50.|to:11.37.41.|to:11.37.43.|to:11.37.45."|wc -l
16128        #加to，规则正常
[root@CShan-10.6.234.169 tmp]iptables -t nat -nvL|egrep "11.37.3.|11.37.44.|11.37.50.|11.37.41.|11.37.43.|11.37.45."|wc -l
16129         #不加to，多一条
[root@CShan-10.6.234.169 tmp]iptables -t nat -nvL|egrep "11.37.3.|11.37.44.|11.37.50.|11.37.41.|11.37.43.|11.37.45." >aaa.txt
[root@CShan-10.6.234.169 tmp]cat aaa.txt |grep "to:11.33.25.73:9810"
  711 37836 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:40865 to:11.33.25.73:9810          #过滤的11.33.25.73并不是我条件中的，但是确实会被过滤出来。过后续过滤前加" to:网段. " 即可
```
6、相同规则冲突排查
```
#当tcp与udp协议类型的head头部的条数=1为正常，无重复步骤。否则，为有重复步骤，需要去重。
#仅限于 重复规则的发现，若是查看是否是重复端口，需要使用上面的整体冲突规则。
cat /etc/sysconfig/iptables |grep 11.39.61|grep udp|awk '{print $8}'|sort|uniq -c|sort -k1 -rn|head
cat /etc/sysconfig/iptables |grep 11.39.61|grep tcp|awk '{print $8}'|sort|uniq -c|sort -k1 -rn|head
```

补充：日志看推流模式
推流模式remote-play日志查看，过滤remote-play日志onListen关键字：
1、有Direct是tcp-p2p
2、有Direct和WS是webrtc-p2p
3、没有Direct是控制服务

#### 值班问题4：汇总各种离线，错误码、无法连接云手机问题
1、云手机白屏，无法连接云手机问题。或者是会话超时问题。
处理思路。比对：同类型中tob、toc 中的manage.conf  的配置文件是否正确。 通常涉及到：会话地址、会话密钥 不正确。 导致白屏，无法连接云手机的问题。处理办法：
```
a. 打注释：大概是改这些。有问题还需要再看，看到FrameReqAppKey FrameReqAppSecret  有的一样，有的不一样。应该是可以忽略的。
sed  '/^Appkey\|^AppSecret\|^DesKey/ s/^/#/g' /data/local/container/manage.conf |egrep 'Appkey|AppSecret|DesKey'
sed '/^SessionServerAddr\|ErrorPostAddr/ s/^/#/g' /data/local/container/manage.conf |grep -i addr
b. 改为tob侧新的配置
sed '111a SessionServerAddr=https://paas.armvm.com\nErrorPostAddr=https://paas.armvm.com\nAppkey=a4d4cf34b943429488cd6690f4dd373a\nAppSecret=244d43ca991b8817153a2a2d28c71ab1\nDesKey=7f3e6028b8c0059c496497e5ed12ece8' /data/local/container/manage.conf |egrep 'Appkey|AppSecret|DesKey|Addr'

2. 关于logcat 看到的日志报错： 尤其是javalang等问题，直接对应的就是apk包的问题。 或者看到类似 E Magisk ： cp afc /debug ramdisk/.magisk/mirror/system/bin/yes >/debug ramdisk/.magisk/worker/system/bin/yes failed: Operation not supported on transport endpoint (os error 95) #很明显是magisk 引起的设备异常，找镜像RD陈养看下就可以。

3. 红手指客户端预览无法使用
           可能是磁盘空间满的问题 /data目录
  预览可以使用，控制手机测报错：262254， 从错误码列表分析是： 网络连接失败的问题。这里就要看是p2p 的链接还是nfv的链接，可以从pass测查看。设备端如下检查：

  root@mciserver:~# brctl show       
bridge name	bridge id		STP enabled	interfaces
br0		8000.342301001771	no		ethUSB0
							veth_br0                                     #nfv 网络。NFV 推流：1 个 NFV 实例通过 1 个 veth_br0 桥接物理网，承载 “虚拟化的网络推流功能”；
lxcbr0		8000.00163e000000	no
##brctl show 命令用于显示 Linux 系统中当前存在的网桥（bridge）及其相关信息。你提供的输出展示了系统中存在的两个网桥，分别是 br0 和 lxcbr0。 这里就代表了是虚机nfv 推流网络。若是出现白屏无法连接云手机的问题。报错：262254.可能是这里的问题。需要检查nfv的相关文件是否正常，且文件大小不为0.可以在群： 主营vpc 询问刘俊云。
可以检查：ls /data/local/nfv-agent/ -lrt  下的文件大小不为0.     且 ps -ef|grep nfv 有4个进程。 ovsdb-server  ovs-vswitchd  nfv-agent  nfv-agent-ovs-controller

补充：物理机网络为这样：
root@mciserver:~# brctl show
bridge name	bridge id		STP enabled	interfaces
br0		8000.402426011814	no		ethUSB0
							veth_vm0
							veth_vm1
							veth_vm2
							veth_vm3
lxcbr0		8000.00163e000000	no          #物理网络推流叫法：4 台虚拟机通过 4 个独立 veth 桥接物理网，每台 VM 像 “物理机” 一样独立跑推流任务，侧重 “分布式部署”。

3. 查看remote-play、screen-grab 进程是否正常，对应的源文件大小是否正常。这2个文件可以用相邻的机器替换

小提示： 查看manage.conf 中的BusinessName=PAAS。
有的没有ps -ef|grep VMB        VMBroker 进程。toc 的没有


```
#### 值班问题5：阻止安装问题
```
问题定位：
出现用户安装限制的弹框，是因为在软件包有**两处矛盾的配置**
1. cloudphone.app_auth_enabled=true                                                             ---------------------------------------------TOB 配置
2. cloudphone.app_verify_url=http://audit.vm.gc.com.cn:8811/audit/app/checkNewAppWhite.html     ---------------------------------------------TOC 配置
TOC TOB限制同时作用，导致的安装限制的问题。
```
完整形式可能类似 Security exception: User restriction prevents installing（安全异常：用户限制阻止安装）。
在/system/etc/business-conf.xml 
<bool key="common.PackageManager.DisablePackageInstallation" value="true" />
value值改成false
或者
am broadcast -a user.restricted --ez installRestricted false  解释下，执行后可以解决云手机：安装异常的问题
#### 值班问题6： x86内存泄露问题
思路：
1. 查看对应ip的x86服务器监控，查看内存是否存在近1-3个月有明显的内存下降趋势
2. 查看有内存明显下降开始的时候，是否启动了某些服务。 #联系RD进行排查即可。或者记得有jstack 查看java内存中线程泄露的问题。

#### 值班问题6：
查看服务是否已经正常连接过会话服务。可以用：`grep -C 20 "manage server connected" *20251019*.log` 这样的方式看到

#### 值班问题7：限速问题
默认限速查询
```
tc class show dev veth_vm${vmsn}
classid 1:10    外网下行流量限速
classid 1:20    内网下行流量限速
``` 
动态限速查询
```
tc class show dev veth_vm${vmsn}
classid 1:50  外网下行流量限速
classid 1:60  内网下行流程限速
```
![限速问题](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/%E9%99%90%E9%80%9F.JPG)

限速日志查看  
manage-agent 日志
```
/data/local/logs/manage-agent# cat manage-agent.log.20251016|grep  -i policy
[2025-10-16 11:47:21.509][pid:1106][tid:1417][procImpl.cpp:2328][do_it()][info]>>pipe msg recv:0002|0082|vm sn:3, set_bandwidth_policy [inup:-1/indown:-1],[exup:-1/exdown:5120], success..                 #exdown:5120 这个是触发动态限速
```
bitcap 日志
```
cd /data/local/logs/bitcap_log/
cat bitcap.20251016.log |grep -i mbps          #这个可以看到设备当前速度。
```
#### 值班问题8：错误码汇总场景
1. 262254：表示网络正常，服务不通的情况
错误日志： reconnect 显示重连中
[10 26 16:41:02.987 19376][PlayDataSource]id:60, reconnect, errcode:262254
[10 26 16:41:02.987 19376][PlayDataSource]onReconnect mReconnRryCount 1  
检查：一般客户会提供客户端日志，直接搜索errcode 可以得到错误码，查看错误码代表的意思
本次为视频流预览服务，点开预览界面：发现画面无法同步报错：不支持  
解决思路：  
a. telnet 视频流公网服务ip: 端口，发现网络不通。最后定位如下：  
paashlmain.armvm.com:10820
这几台是因为toB视频流预览服务域名解析没配置，导致的视频流预览画面没更新，且转截图流预览失败（原因待排查）
现在op已修复怀来机房paashlmain.armvm.com域名解析，刷新列表可恢复预览



## 如流机器人使用方法
```
群主创建机器人：获取webhook地址和群id以及个人id+回调地址（个人搭建的网站用来接收机器人消息，回调结论）
例如：
webhook地址：http://apiin.im.baidu.com/api/msg/groupmsgsend?access_token=de34b0b530b106d15178e2630ea7f790d
群id：即群号：11461246
个人id：即去掉邮箱后缀即是
```
### md语法send
```
curl -X POST 'http://apiin.im.baidu.com/api/msg/groupmsgsend?access_token=de34b0b530b106d15178e2630ea7f790d' \
  -H "Content-Type:application/json" \
  -d '{
    "message": {
      "header": {
        "toid": [11461246]
      },
      "body": [
        {
          "type": "MD",
          "content": "# 大狗子反馈 \n不要摸鱼<font color=\"red\">，请相关同事注意。</font>"
        }
      ]
    }
  }'
```

### link + 艾特(@群成员(仅可以与TEXT类型、LINK类型一起使用，IMAGE类型、MARKDOWN类型不能使用AT类型))
```
curl -X POST 'http://apiin.im.baidu.com/api/msg/groupmsgsend?access_token=de34b0b530b106d15178e2630ea7f790d' \
  -H "Content-Type:application/json" \
  -d '{
    "message": {
      "header": {
        "toid": [11461246]
      },
      "body": [
        {
          "type": "LINK",
          "href": "https://www.baidu.com/"
        },
        {
                "atuserids":["wangyulong09"],
                "atall":false,
                "type":"AT"
        }
      ]
    }
  }'
```
### 图片send
```
curl -X POST 'http://apiin.im.baidu.com/api/msg/groupmsgsend?access_token=de34b0b530b106d15178e2630ea7f790d' \
  -H "Content-Type:application/json" \
  -d '{
    "message": {
      "header": {
        "toid": [11461246]
      },
      "body": [
        {
          "type": "IMAGE",
           "content": "/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAMgAyADASIAAhEBAxEB/8QAHAAAAQUBA......................WUCTEpFRKofMlcKCSInmCbMopXRUgUswUbpkBLpXULpIJlw3J7hDSvZAS6V1AFPdBK4TqCV0RO6V1DMU90U5KV1EnVNdBNMSo3T3QODdPdRumREimuE10rqtP//Z"
        }
      ]
    }
  }'

##1、获取base64 编码的方法cmd，特别长。但是必须经过处理放到一行
certutil -encode "C:\Users\wangyulong\Desktop\tsl.jpg" temp.txt && type temp.txt | findstr /v "BEGIN" | findstr /v "END" > img_base64.txt && del temp.txt
##2、不能在curl 的代码上加注释，例如 //图片byte数据base64编码后的值，byte小于1m
```
### 基础text
```
curl -X POST 'http://apiin.im.baidu.com/api/msg/groupmsgsend?access_token=de34b0b530b106d15178e2630ea7f790d' \
   -H "Content-Type:application/json" \
   -d '{
    "message": {
       "header":{
            "toid":[11461246]
        },
        "body": [
		  {
		  "type": "TEXT", 
		  "content": "hi, robot!"
		  }
		       ]
     }
  }'
```
综上。如截图所示  
![如流机器人send_result](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/reboot.JPG)

## 值班服务问题学习汇总 1：管理代理 服务： manage-proxy
```
1、国内\外  pass后台： 物理机配置： 查询ip，可以看到机房，防火墙------------确定机房位置              设备管理节点：可以看到这片物理机分别的管理节点
2、控制节点：节点类型为管理节点 防火墙为：例如：江苏常熟百度防火墙
```

## 值班问题汇总
### 各种理解

1. 理解wss 与 https 之间的区别
   * WSS 和 HTTPS 用的是同一种加密技术（SSL/TLS），只是应用在不同的通信场景里。
   * HTTPS/http 管 “单次请求”（打开网页、提交表单），WS/WSS 管 “实时长连接”（聊天、弹幕）；
   * HTTPS 网页 “强制禁止” WS（明文），“只允许” WSS（加密）；http 浏览器支持ws，已经基本被淘汰。

```
#加深理解：
你在网上买衣服，下单时需要把 “收货地址、手机号” 发给商家，这是一次 “你→商家” 的单向请求，商家回复 “订单已确认” 后，这次沟通就结束了（一次性、短连接）。
http特点：“一问一答” 式通信，每次请求后连接会断开，不适合 “实时互动”（比如你和客服实时聊天，总不能每说一句话就刷新一次页面吧？）。

WS：“未上锁的实时专线”—— 用于 “持续互动”
补充：MySQL 的本地连接确实可以用 “socket”（Unix 域套接字），但这是本地进程间的通信方式，和 Web 领域用于网络实时通信的 WebSocket（WS）没有任何关系，二者只是名称中都包含 “socket”，实际原理和用途完全不同。
```

2. ——toB控制服务代码已支持wss，不用额外部署js代理服务，但toC控制服务不支持。  
   
3. 理解manage-agent：Manage-agent负责启动和停止vmbroker，remote-play，以及虚拟机容器。其中manage-agent与vmbroker或manage-proxy都是通过unix域套接字通信，manage-agent通常充当vmbroker与manage-proxy之间转发消息的通道  

### 通用问题
1. 云手机内logcat *：E                可以看到明显的null 指针的问题。
例如：比如读取文件失败返回 null 后未处理。空指针本质上是代码逻辑漏洞—— 没有正确处理 “对象可能为 null” 的情况。
························故遇到该问题，要看造成空指针的原因
案例1：
        Process: com.android.provider.multiapp,PID: 36257             #可以看到空指针的前提条件是：multiapp 插件进程出现了问题
        java.lang.NullPointerException         
                at com.android.dexguard.multiapp.App$b.k(Source File:394)
      提示：也可以在remote-play 进程中看到。。
恢复方法：
1、pm clear com.android.provider.multiapp              #方法1不行执行2即可。
2、com.android.provider.multiapp卸载了 
案例2：
        java.io.FileNotFoundException: /system/etc/fonts.xml: open failed: ENOENT (No such file or directory)
        ....
        System zygote died with fatal exception
        java.lang.NullPointerException: Attempt to read from field 'int android.graphics. Typeface.mStyle' on a null object reference in method 'android.graphics. Typeface android.graphics.Typeface.create(android.graphics.Typeface, int)'
综上解析：
文件缺失是根源：系统尝试读取 /system/etc/fonts.xml 来加载字体配置，但该文件不存在（FileNotFoundException）。
引发空对象：由于字体配置文件缺失，SystemFonts 模块无法正确初始化字体相关对象，导致后续操作中出现了值为 null 的 Typeface 对象。
空指针异常爆发：当代码执行到 Typeface.create 方法时，试图从这个 null 的 Typeface 对象中读取 mStyle 字段，从而触发 NullPointerException。

解决思路：
1、拷贝镜像，独立挂载这个2号机。#用于判断： 看看是不是镜像原文件已经缺失文件了
2、find /data/lxc_volumns -name fonts.xml
案例3：
再有就是检查各种文件是否缺失的问题，例如： business-conf.xml 是否存在   /system/etc/...xml

### 交付问题汇总
1. dumpsys package com.google.android.webview | grep version                  #看包的版本
2. 工作流提示： execute script error，errorCode：100106，message:procees dufs failed. upload clean file failed.code:1,msg:lost connection  名称：应用镜像制作[996测试]     物理机ip：11.25.207.1  实例编号：VM010141208002
   问题解决：查找对应机房中：rsync- agent服务器（堡垒机中输入：rsync-agent）：找到常山  10.6.234.11	10.6.234.12
   在常山服务器远程ssh 连接虚机：ssh -i /data/paas/App_Distribution/app-update-tool/rsa/wsy_wsy -p 62485 root@10.141.208.2
   一般连接失败
   问题解决：将wsy_wsy  改为 id_rsa_arm     即可。这个配置不支持多个密钥连接。  **无须重启生效**
   对标的服务是：armvm-app-native-rsync-agent-CS
   [paas@CS-10.6.234.11 ~]cat /data/paas/App_Distribution/network-storage-tool/conf/config.conf |grep _key
device_keyfile=/data/paas/App_Distribution/app-update-tool/rsa/id_rsa_arm
vm_keyfile=/data/paas/App_Distribution/app-update-tool/rsa/id_rsa_arm

下次通过find 直接查找：
[paas@CS-10.6.234.11 ~]find /data -name network-storage-tool 2>/dev/null
/data/paas/App_Distribution/network-storage-tool

okr后续反思：
1、个人协同方面得到哪些提升

2、个人的成长在哪里。。

3、平时交付多思考
```
交付时效问题：
1. 指派工单的时长
2. 之前流程规范性问题，例如：manage-agent 网络不通、端口不通的情况
3. 客户自定义配置项有问题，例如：system.su 在自定义配置文件中，刷机后未生效。 可能与资源包冲突等问题
4. 与pmo沟通，apk无法下载，是否重置等问题
5. 指定日期更新的刷机工单。
```

# 排查问题汇总

### TOb-P2P配置check是否丢失
#会话地址. 业务模式设为PAAS,且配置该项才有session模式. 没配置, 即nosession模式
SessionServerAddr=https://ctlcheck.gc.com.cn
已知问题，这台秘钥都是wsy_wsy没更换，是救活设备了，checking-server地址也没改

1. 证书文件
```
ls /data/local/container/cert/ -lrt
md5sum /data/local/container/cert/*
```
2. manage.conf 配置文件
```
cat /data/local/container/manage.conf |egrep "CertPem=|CertKey=|SessionServerAddr=|ErrorPostAddr=|Appkey=|AppSecret=|DesKey=|AuthVer=|WSUsingSSL=|IDR_Interval=|SelectFrameTimout=|IDR_Interval=|RateControlMode=|WebRTC_RatesSetting="
```
综上，可以直接使用
```shell
ls -lrt /data/local/container/cert/ && md5sum /data/local/container/cert/* && cat /data/local/container/manage.conf |egrep "CertPem=|CertKey=|SessionServerAddr=|ErrorPostAddr=|Appkey=|AppSecret=|DesKey=|AuthVer=|WSUsingSSL=|IDR_Interval=|SelectFrameTimout=|IDR_Interval=|RateControlMode=|WebRTC_RatesSetting="
```
TOB 的p2p 配置,解压p2p.tar 包后,如下：
```
root@mciserver:/tmp/output# ls -lrt
total 28
-rwxrwxrwx 1 mci mci 14989 Dec 18  2024 update.sh
-rwxrwxrwx 1 mci mci   629 Apr 29 11:29 package.conf
-rwxrwxrwx 1 mci mci  1675 Apr 29 11:30 armvm.com.key
-rwxrwxrwx 1 mci mci  3961 Apr 29 11:30 armvm.com.crt
root@mciserver:/tmp/output# cat package.conf
# This config file is for P2P package.

# common configs
common.meta_version=1
common.class=p2p
common.version=1.0.1
common.soc=any
common.rootfs=any

p2p.certpem=/data/local/container/cert/armvm.com.crt              #根据路径改
p2p.certkey=/data/local/container/cert/armvm.com.key
p2p.session_server_addr=https://paas.armvm.com
p2p.error_post_addr=https://paas.armvm.com                         #根据地址改
p2p.appkey=a4d4cf34b943429488cd6690f4dd373a                                         #下面九项，私有化或者海外都是默认
p2p.appsecret=244d43ca991b8817153a2a2d28c71ab1
p2p.deskey=7f3e6028b8c0059c496497e5ed12ece8
p2p.authver=3
p2p.wsusing_ssl=1



p2p.idr_interval=30
p2p.select_frame_timeout=1
p2p.rate_control_mode=2
p2p.webrtc_ratessetting=5000,10,512,500,2,2
```