- [笔记大全- 笔记大全](#笔记大全--笔记大全)
  - [常规不熟悉的命令](#常规不熟悉的命令)
    - [nginx 文件服务器](#nginx-文件服务器)
    - [常见问题](#常见问题)
  - [支持人员](#支持人员)
  - [wsphone\_nodes](#wsphone_nodes)
    - [私有化上架流程](#私有化上架流程)
    - [刷机：运管平台常见到的问题](#刷机运管平台常见到的问题)
    - [其他常见问题](#其他常见问题)
    - [云手机离线问题处理集合1](#云手机离线问题处理集合1)
    - [预警处理](#预警处理)
    - [刷机各问题](#刷机各问题)
    - [pcdn](#pcdn)
  - [ebtables隔离问题汇总](#ebtables隔离问题汇总)
  - [pgsql 最近涉及到的sql命令](#pgsql-最近涉及到的sql命令)
  - [待学排查](#待学排查)
    - [接口查询工具](#接口查询工具)
  - [周报汇总](#周报汇总)
  - [post请求，找时间实验下](#post请求找时间实验下)
- [--max-time 10：超时时间（10 秒内没响应就停止等待）](#--max-time-10超时时间10-秒内没响应就停止等待)
  - [脚本思路](#脚本思路)
  - [pass各服务问题定位](#pass各服务问题定位)
    - [服务汇总，manage-proxy manage-agent ctrl-server](#服务汇总manage-proxy-manage-agent-ctrl-server)
  - [F12定位问题汇总](#f12定位问题汇总)
  - [各值班问题汇总](#各值班问题汇总)
  - [值班服务问题汇总](#值班服务问题汇总)
    - [反馈机房网络延迟数值很高，判断是否和推流有关系](#反馈机房网络延迟数值很高判断是否和推流有关系)
  - [如流机器人使用方法](#如流机器人使用方法)
    - [md语法send](#md语法send)
    - [link + 艾特(@群成员(仅可以与TEXT类型、LINK类型一起使用，IMAGE类型、MARKDOWN类型不能使用AT类型))](#link--艾特群成员仅可以与text类型link类型一起使用image类型markdown类型不能使用at类型)
    - [图片send](#图片send)
    - [基础text](#基础text)
  - [值班服务问题学习汇总 1：管理代理 服务： manage-proxy](#值班服务问题学习汇总-1管理代理-服务-manage-proxy)


# 笔记大全- [笔记大全](#笔记大全)
## 常规不熟悉的命令
```
1、 Centos7 ssh远程登录。  需要 vi /etc/ssh/sshd_config  将PermitRootLogin yes  放开注释即可。
```
### nginx 文件服务器
```
[root@nginx ~]# cat /etc/nginx/nginx.conf

user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;
server {
        listen  8080;
        server_name  localhost;
        charset utf-8;
        #root 指令用来指定文件在服务器上的基路径
        root /data/statics;
        #location指令用来映射请求到本地文件系统
        location / {
           autoindex on; # 索引
           autoindex_exact_size on; # 显示文件大小
           autoindex_localtime on; # 显示文件时间
        }
   }

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}

wget 限速：  wget --limit-rate=500K               #单位500KB/s

```
### 常见问题
1、cat /proc/fault_events,可以看到文件系统是否有损坏的问题  
2、 file flags /flæɡ/  
最基础含义：旗子；旗帜（如国旗、信号旗等）  （电脑 / 文件系统中）标志；标记；属性（如你之前遇到的 "file flags" 即 “文件属性标志”）。  
chattr: Operation not supported while reading flags on /data/lxc_container/data/0   出现这个问题。 df -T /data/lxc_container/data/0  
```root@mciserver:~# df -T /data/lxc_container/data/0
Filesystem     Type      1K-blocks     Used Available Use% Mounted on
dufs           dufs.dufs 222778080 40315948 171072796  20% /data/lxc_container/data/0            #可以看到dufs配置，卸载dufs服务后，再次尝试即可

```
3、 lsof   
lsof /dev/msi_gps             #可以看到占用这个文件的进程有哪些    
4、time 统计时间  
nohup 统计时间：  
nohup bash -c 'time sh upload_batch.sh -h ip.txt -s uptime' >output.log &  
5、readlink 用法
```
ln -s $(readlink container_mgr) container_mgr.bak
ln -sf container_mgr.1.5.conf container_mgr
ln -sf $(readlink container_mgr.bak) container_mgr
```
6、sed 清理空白行
sed -i 's/^[[:space:]]*//g' daishuai.txt    #11.33.8.76  变为  11.33.8.76    

sed '/^[[:space:]]*$/d' 文件名  #删除所有空白行（行首到行尾全是空白）    

grep '[[:space:]]' 文件名      #查找包含空白的行：    

#如果只需要删除空行，保留原有格式（不处理空格），可以简化为：sed '/^$/d' daichuli_ip.txt > no_empty_lines_ip.txt  
```
其他常见的预定义字符类可以辅助记忆，比如：
[[:digit:]]：匹配数字（digit 是 “数字”）
[[:alpha:]]：匹配字母（alpha 是 “字母”）
[[:alnum:]]：匹配字母 + 数字（alnum = alpha + num）
它们的格式都是 [[:xxx:]]，功能与 xxx 的英文含义直接相关，[[:space:]] 同理。
```

7、 复制 调试  
```shell
禁止：不让复制的调试
控制台输入：
document.designMode = 'on'
```
8、两种按行输出的方式echo 和printf  
echo 10.40.68.{49..58} | tr ' ' '\n'
printf "%s\n" 10.40.68.{49..58}
9、 maxdepth  
find /data/lxc_volumns -maxdepth 1 -name 'system' -type d
10、 findmnt  
findmnt -t ext4    # 查找所有 ext4 文件系统
findmnt -t overlay # 查找所有 OverlayFS 挂
findmnt /data   #直接查看  
11、 linux 内核查看文件
cat /proc/version  
12、 losetup -a 的作用
它会列出系统中当前所有 loop 设备 及其挂载源文件。  
例如：/dev/loop6: [45829]:4587542 (/data/lxc_volumns/super_f2fs_aosp12_rk3588_base_2.46.0.mcir5.base_0701_1530_1.img)  
13、 diff
#提示： 当物理机的一个文件时间戳 和 云手机中的时间戳 不同，并不代表他们没有被rsync 。可能是内容一致。
diff 参数 -y -q                #-q：只报告不同的文件  -y 2列看差异，    
```
root@mciserver:/data/lxc_container/data/0/local/tmp# diff -q md6.txt md6.txt2
root@mciserver:/data/lxc_container/data/0/local/tmp# diff  md6.txt md6.txt2
root@mciserver:/data/lxc_container/data/0/local/tmp# vi md6.txt
root@mciserver:/data/lxc_container/data/0/local/tmp# diff -q md6.txt md6.txt2
Files md6.txt and md6.txt2 differ
root@mciserver:/data/lxc_container/data/0/local/tmp# diff  md6.txt md6.txt2
119c119
< dfa6975e8687fd7d606e8d7924eb84db72            #代表为左边的文件
---
> a6975e8687fd7d606e8d7924eb84db72                 #代表为右边的文件

```  
14、 comm
comm -13 已排序的文件1 已排序的文件2          #结果是排除文件2中，和文件1共同的内容后。 只输出文件2 独有的内容。
comm -3 已排序的文件1 已排序的文件2        #得出文件1 和文件2 有差异的结果。
comm -12 已排序的文件1 已排序的文件2        #得出文件1和2 共同的内容。  
15、 find+grep 过滤文件内容
```shell
 find /data -type f |grep -rl dropbear  #用于过滤出文件内容中包含dropbear的文件，即：/data/.mci/dropbear_service。       
 或者：find /system -type f |xargs grep -rl dropbear       #可以看到：/system/xbin/dropbear_service           注意：我们需要的是rc 的配置。
 cat /data/.mci/dropbear_service               #当然这个文件也有可能是空的。 那一版就需要手动去启动了
 #可以看到如下配置：    
 SSHD_PORT=`getprop ro.sshd.port 62485`
 /system/xbin/dropbear -p $SSHD_PORT -A -j -e -k -R  /data/.ssh/authorized_keys -r /data/.ssh/dropbear_rsa_host_key
 上面有个变量为：$SSHD_PORT 。获取方式为getprop
 #经过find 和grep 过滤出该文件出现在： 最好是 find         /data  /vendor/ /odm/ /system    都尝试下，这样速度会更快一点 
 cat /vendor/build.prop |grep ro.sshd.port                 #经过测试该文件中的ro参数都可以通过getprop 得出。  /system/build.prop 也可以，经过测试其他文件都可以这样获取。
ro.sshd.port=62485 -p 22
#################手动启动dropbear 以及解决无法启动成功的问题。
1、思路：去正常机器查看下22 或者 62485 端口。  例如：dropbear -A -F -e -j -k -R /data/.ssh/authorized_keys -r /data/.ssh/dropbear_rsa_host_key -p 62485 -p 22   #这个去rc配置中找
2、进入异常设备执行： /system/xbin/dropbear -A -F -e -j -k -R /data/.ssh/authorized_keys -r /data/.ssh/dropbear_rsa_host_key -p 62485 -p 22   && echo $?    
3、若执行不成功，则 ls -lrt /data/.ssh/authorized_keys  ls -lrt /data/.ssh/dropbear_rsa_host_key          #一般是这2个文件为空了。去其他正常的设备cp一份即可。 
4、copy思路：find /data -type f -name dropbear_rsa_host_key|xargs ls -lrt            #直接执行这个即可。
root@mciserver:~# find /data -type f -name dropbear_rsa_host_key |xargs ls -lrt
-rw------- 1 root root   0 Jul 31 23:42 /data/lxc_container/data/1/.ssh/dropbear_rsa_host_key                               #替换
-rw------- 1 root root   0 Jul 31 23:42 /data/local/acb-dufs/dufs-dir/remote/VM010251230030/.ssh/dropbear_rsa_host_key          #替换
-rw------- 1 root root  96 Jul 31 23:42 /data/local/acb-dufs/dufs-dir/cache/home/VM010251230030/.ssh/dropbear_rsa_host_key
-rw------- 1 root root 805 Aug  4 16:15 /data/lxc_container/data/0/.ssh/dropbear_rsa_host_key
5、替换后重新执行命令即可成功。
##################
```
16、apt源  
apt-update 不成功，也可以apt install 下载
#该错误信息 “E: The repository 'https://mirrors.tuna.tsinghua.edu.cn/debian bullseye - backports Release' does not have a Release file.” 表示从清华大学镜像源获取 Debian 的 bullseye - backports 仓库的 Release 文件时失败，通常是因为相关仓库已停止维护。
17、 windows 清理dns缓冲  
ipconfig /flushdns  
18、 md5值windows校验  
打开cmd：  
certutil -hashfile C:\Users\wangyulong\Downloads\zboot-rk3588_android12_2.9.0.lxc_0422.img md5
19、 windows-powershell-md5校验  
Get-FileHash -Path system_backup.tar.gz  -Algorithm MD5  
20、修改时间，时区问题  
linux一切皆文件
```
手动修改时区（适用于无 systemd 的老系统）系统没有 timedatectl（极少数情况），可手动修改时区符号链接

ls -l /etc/localtime
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

结果：root@mciserver:~# ls -l /etc/localtime
lrwxrwxrwx. 1 root root 34 Apr  3 06:50 /etc/localtime -> /usr/share/zoneinfo/Asia/Hong_Kong
```
```
date 查看时间
timedatectl    #查看时间以及时区
timedatectl list-timezones | grep Asia/Shanghai  #过滤上海时区
timedatectl set-timezone Asia/Shanghai   #设置为中国上海时区
timedatectl   #再次查看时间以及时区

```
` getprop | grep timezone  #虚机过滤时区`
21、  paste命令  
eg：sh data_batch.sh -h ip.txt -s "paste -d '|' /sys/devices/platform/fe330000.sdhci/mmc_host/mmc1/mmc1:0001/life_time /sys/devices/platform/fe330000.sdhci/mmc_host/mmc1/mmc1:0001/pre_eol_info"

```shell
#paste 的用法
[device@zc-10-6-42-115 linshi]$ cat file1.txt file2.txt
apple
banana
cherry
red
yellow
pink
[device@zc-10-6-42-115 linshi]$ paste file1.txt file2.txt
apple	red
banana	yellow
cherry	pink
[device@zc-10-6-42-115 linshi]$ paste -d "|" file1.txt file2.txt
apple|red
banana|yellow
cherry|pink

```
22、 ncdu命令  
du -sh 某些目录。由于下面的小文件太多，导致无法直接读取，可以使用ncdu更加快捷
eg：
![ncdu](https://github.com/linuxlaowang/tuchuang/blob/master/nodes/F8ECB676-D48E-4F53-879F-4DF5EF42BC30.JPG?raw=true)  
```
#当出现play保护机制的问题，可以执行该命令：绕过或关闭用户对于应用包验证的确认提示：settings put global package_verifier_user_consent -1  （重启会失效）

```
23、
## 支持人员
```
apass 平台：RD 王萌  吕抒钰
张锦辉： 云手机sdk开发问题。
推流问题： 思民、万钊
toc海外授权问题报错（9692051）：杨杨，潘利才
gps定位不协同问题：lsof /dev/msi_gps  #看是否只有remote-play调用           找陈思民 和陈娇

###游戏
 冒险岛世界，辅助搬砖帝
  夜鸦
  时空猎人

```
## wsphone_nodes
### 私有化上架流程
```
一、预备阶段
1、登录vpn后，查看pass服务清单，登录pass后台。 可以借鉴 公有云上架流程文档
2、查看工单中上架型号、以及上架的云手机ip
3、pass后台查看云手机ip，看是否有这个网段存在，防止冲突。 没有则继续看上架流程。以及设备型号，上架多少ip，网段是否够。
二、工程阶段
1、开始上架：看工单确定设备的最大虚机数，在（pass后台）基础设置-设备配置                ？疑问：这里能设置多次吗，这次和上次设置开数的区别是什么。
2、pass后台：新增功能：  
    设备编码：一般填客户的首字母即可。例如：JSQ          
    设备ip、型号、系统版本：批量新增，指的是arm设备。型号、版本都可以从工单中获取。
    虚机设备开始ip：要看工单中指定的私有化ip网段。  例如：172.17.124.0/23           
    网关 掩码：都要填写工单中的私有化： 虚机ip的网关、掩码 
3、上架后，可以点击查询即可看到上架后的设备ip，虚机ip 了以及对应的 开数。
4、bmcip 需要sql去更新即可。  物理设备，可以看到目前管理口ip为空，现在用下面的sql上架后再次查询即可。
5、千万不要忘记还有一步：静态ip下发
select pad_code from rf_pad rp,rf_device rd where rp.device_id=rd.device_id and substring(device_ip from '\d+.\d+.\d+.') in ('11.37.11.','11.37.12.')              #查询pad_code，私有化上架查，记得进入对应的库：redfinger_paas

云手机配置：通过pass后台也可以导出pad_code后， 云手机配置-----修改是否启用静态ip： 填是，加上padcode即可             --------------完成上架。绑定了私有化ip后就不用绑定mac了。私有化是这样。

私有化上架bmc的方法：
select bmc_manage_port_ip from rf_device where substring(device_ip from '\d+.\d+.\d+.') in ('10.1.10.');

UPDATE rf_device SET bmc_manage_port_ip='172.26.0.211' WHERE substring(device_ip from '\d+.\d+.\d+.') in ('10.1.11.');
```
```
上架私有化刷机：#更改manage-proxy地址以及ftp地址和密码
sed -i 's/^FTPUrl.*/FTPUrl=ftp:\/\/10.10.8.252:21/' /data/local/container/manage.conf
sed -i 's/^UserPwd.*/UserPwd=private-cloud:ed323paasF/' /data/local/container/manage.conf
sed -i 's/^Server.*/Server=10.10.8.252:7918/' /data/local/container/manage.conf
#检验是否更改
cat /data/local/container/manage.conf|egrep '^Server=|ftp|UserPwd'
```
### 刷机：运管平台常见到的问题
1、  常见错误1：物理机脚本执行报错：内部服务通信失败，无非就是manage-agent 到 proxy 到 server 的问题。
paas-base-dg.armvm.com     manage-server服务。可以参考： https://console.cloud.baidu-int.com/devops/icafe/issue/ACSI-5297/show?source=drawer-header  
2、  常见错误2：
### 其他常见问题
1、调整CPU使用策略解除绑核，调整内存/swap使用优先级
```shell
解除绑核策略：
背景：单开挂虚拟机场景，光速虚拟机。用户测试我们的设备cpu跑不满8个核，是因为我们cpu策略绑大核了。物理内存使用最大只能到50-60%，就会用swap
综上背景，需要更改 cpu策略与swap策略如下：
1、物理机root镜像里的init.rc文件，以下都注释掉              # /data/lxc_volumns/root_?/init.rc
#write cgroup cpuset
write /dev/cpuset/foreground/cpuset.cpus 4-7
write /dev/cpuset/background/cpuset.cpus 0-3
write /dev/cpuset/system-background/cpuset.cpus 0-7
write /dev/cpuset/top-app/cpuset.cpus 4-7
write /dev/cpuset/camera-daemon/cpuset.cpus 4-7
调整内存/swap使用优先级：
1、固化操作，物理机container_$SN.conf增加lxc.cgroup.memory.swappiness=1        
# /data/lxc_container/container_?.conf  以及  /data/lxc_container/ro.container_?.conf    都需要改,否则reboot后，配置文件会被还原。
2、立即生效，虚拟机内：echo 1 > /dev/memcg/memory.swappiness
```

2、 ebtables 隔离策略清除问题
手动执行ebtables规则清除命令。 ebtables -F ，重启是会被pass还原  
需要： ebtables -F ; rm /data/local/init_sh/paas_*  

3、这个是在启动CDN服务前 部署arm设备的的dufs原因
解决办法：每一片执行： /data/local/acb-dufs/acb-dufs.sh register-device  。#可以看到dufs报错，没有注册信息  

4、网络问题定位  
当ssh概率卡顿，需要考虑网络侧是否存在了问题。即：可能模块存在问题（更换后未成功）。如下截图
![ssh虚机，概率会卡着](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/ssh-%E7%BD%91%E7%BB%9C%E5%AE%9A%E4%BD%8D.PNG)

5、 查看云手机patch 的apk路径  
dg apt show patch:bosszhipin|grep bosszhipin
6、 查看云手机的apk及路径  
pm list packages  
pm path com.xxx
7、 apk 路径  
pm list packages -f |grep -i magisk                 #一般安装的apk的物理机路径为：/data/lxc_volumns/super_0/system/app/
package:/system/app/Magisk-v29.0/base.apk=com.topjohnwu.magisk  

root@mciserver:~# ls /data/lxc_volumns/super_0/system/app/Magisk-v29.0/     #/data/lxc_volumns/super_$sn/system   指定安装路径为这里后，会放到app下
base.apk  lib
8、 查看apk的详细信息  
dumpsys package com.topjohnwu.magisk
9、 查看云手机启动时间  
```
查看进程启动时间-----以此可以获取到云手机的启动时间。
eg: mar 为3月
root@mciserver:/data/local/tmp/linshi# ps -p 5044 -o lstart         #这里查看 -o
                 STARTED
Sat Mar 15 18:36:49 2025
获取进程pid：
pidof bitcap
```
10、 logcat  
```
logcat *:E  #查看错误日志
# 清空现有日志后监听崩溃信息
logcat -c
logcat --pid=1234 
logcat -f /sdcard/log.txt
```
11、 getprobe 过滤时区  
```
getprop | grep timezone  #虚机过滤时区
getprop |grep net     # 可以看到网关         #ro.net.provisioned.gw       ro.net.provisioned.ip      可以分别得到网关和ip地址
getprop |grep version.release #可以看到版本号等
```
12、 修改fps帧数  
将/data/lxc_volumns/super_$SN/vendor/build.prop中的60帧，需要改成30：（上次是system，优先级没有vendor高，被覆盖了导致没生效）
比如：msiq.display.config=720x1280@60,320
         msiq.display.config=720x1280@30,320
13、 sdk日志位置  
/sdcard/Android/data/应用包名/files/log目录下的sw开头的文件，默认保留7天。
14、 查看分辨率日志  
``shell
#查看摄像头中的分辨率
过滤remote-play日志，camera和width就可以看到了
#回显如下：
[07 25 15:37:48.471 44813][CameraRemoteImpl]cameraInfo, RFVIDEO_GET_PIXFORMAT, width:1280, height:720, fmt:876758866

 摄像头不能指定申请分辨率 这是云机app回调给镜像HAL层 再到remote-play 最后返回到客户端的分辨率，云机app决定了摄像头的分辨率
 #上面这句话有待确认
 #所以说，一个是镜像版本要支持  二是改镜像配置文件即可。
 
 vendor/build.prop
camera.support.1080P=true
  加了camera.support.1080P=true
重启物理机生效了 这是交付时候没加的配置
``
15、 云手机命令1  
```
#查看刷的资源包版本
root@mciserver:~# cat /data/lxc_volumns/system_0/etc/.resource_package_version        #资源包（如果软件包支持写入版本） ： 云手机的 /system/etc/.resource_package_version
Thu Jul 10 12:46:25 HKT 2025
1.8.0.pg.mcir5.10.aochen_google.20250605

#查看谷歌商店是否存在：可以用  pm path com.android.vending
#查看分辨率 
wm size
#查看分辨率以及fps、dpi 
getprop msiq.display.config
#查看时区
getprop | grep timezone
#查看桌面是否启动
ps -ef|grep launcher
```
16、 云手机dns问题  
aosp版本查询：getprop ro.product.base_version            #看安卓版本  getprop |grep version.release
| AOSP版本 |   开始支持的版本 |
| :-- | :--: |
| 8.1 |  4.49.0  |
| 10 | 2.56.0  |
| 12 | 2.33.0 |
| 13 | 1.9.0 |
| 15 | 默认支持 |

综上版本支持dns动态修改：  
dns设置：  settings put secure net_override_dns 10.255.255.244  
dns查看：  settings get secure net_override_dns  
#dns 查看是否生效，请用：  
android10以上：dumpsys dnsresolver  
android10以下：dumpsys netd
17、 云手机安卓版本以及sdk版本以及对应关系  
| Android 版本 | SDK（API Level） |  
| :-- | :--: | 
| Android 14 | 34 |
|Android 13|	33|
|Android 12|	31、32
|Android 11|	30
|Android 10|	29
|Android 9	|28
|Android 8.1|	27
|Android 8.0|	26
```
getprop ro.build.version.release  #查看安卓云手机版本
getprop ro.build.version.sdk  #getprop ro.build.version.sdk
```
18、 查看设备型号，芯片型号  
cat /sys/firmware/devicetree/base/compatible  
rockchip,androidrockchip,rk3399-excavator-edp-avbrockchip,rk3399

19、 营销平台显示断网原理  
营销从dg获取的；dg是根据能否请求 http://lite-ip.cloud-control.top:8778/ip 这个链接来判断的（该url 通过dg dump net 获取）
营销平台根据arm设备执行： dg dump net 后的checkUrl地址判断是否有网络。但是一般这里的*conn.outIp": null* 字段是null的话，说明了应该是没有出口的公网ip，也是无法curl成功的。

### 云手机离线问题处理集合1
现象：remote-play 未启动，可能是证书问题。
报错：[ERR][07 24 11:52:58.697 6323][remote-service]Failed to **load server certificate**, error:02001002:system library:fopen:No such file or directory
排查：manage.conf 是有2个，即：
root@mciserver:/data/local/container/commdir# ls -lrt /data/local/container/commdir/manage.conf
-rw-r--r-- 1 root root 9417 Jul 24 04:40 /data/local/container/commdir/manage.conf                  #/commdir/manage.conf 
root@mciserver:/data/local/container/commdir# ls -lrt /data/local/container/manage.conf
-rw-r--r-- 1 root root 9411 Jul 24 11:47 /data/local/container/manage.conf                      #manage.conf

root@mciserver:/data/local/container/commdir# cat /data/local/container/manage.conf |grep Cert
CertPem=/commdir/gc.com.cn.crt
CertKey=/commdir/gc.com.cn.key
root@mciserver:/data/local/container/commdir# cat /data/local/container/commdir/manage.conf |grep Cert
CertPem=/commdir/armvm.com.cn.crt
CertKey=/commdir/armvm.com.cn.key                                                                           #这个证书看是否存在，ls commdier/armvm.com.cn.* 
#综上，证书一般不存在，也可以去同网段其他机器看下。证书为 gc.com.cn.*     且 目录下存在这个文件。

解决办法：
root@mciserver:/data/local/container/commdir# sed -i 's@CertKey=.*@CertKey=/commdir/gc.com.cn.key@' /data/local/container/commdir/manage.conf
root@mciserver:/data/local/container/commdir# sed -i 's@CertPem=.*@CertPem=/commdir/gc.com.cn.crt@' /data/local/container/commdir/manage.conf
重启云手机即可。 pass后台正常显示在线。
### 预警处理
【生产环境】
PaaS虚机直连监控
合肥机房-可用区1--VM010119030019 connect fail
截图地址：https://bj.bcebos.com/bac-private/saas-point/qa/rpm/20250720204359.png
解决方案：10.6.34.3 设备离线。 系统测定位内存问题。后续重启恢复。
问题：paas测对应链路未知。

20、 拟真理解  
配IP+刷拟真了，语言没变。需要执行命令 dg  osemu ip
dg osemu --help
21、 dg 和 dumpsys 的用法区别  
dumpsys <service>   #安卓原生命令。查看各种服务的状态
dg #非标准命令
```shell
#dg 命令大全
在云手机中也可以使用内置的dg命令调用系统服务api，功能和效果与sdk一致。即：dg_api       debug_get  或者理解为 device_get     dump 导出
dg dump base      #可以获取到AOSP版本（安卓开源项目）。例如：buildBaseVersion": "1.21.1.mciq85.base             #1.21.1AOSP版本
dg dump plugin            #查看apk插件有哪些，例如：sms、root、kernel、av、apt、proxy、patch（Android热补丁框架，支持app及系统服务热修补能力）
dg dump net               #可以查看出口公网ip。 也可以通过 curl cip.cc  或者 curl ipinfo.io 
#curl 报错：status": 429：
HTTP 状态码 429 是标准的 “请求过多” 错误，表示客户端发送的请求频率超过了服务器的限制。
#error.title": "Rate limit exceeded"
错误标题，直译为 “速率限制已超出”，即请求频率超过了允许的上限。
dg dump pm     #查看pm 相关，可以看到谷歌三件或者5件套。其中keepFingerprintApps    表示：保持 指纹 apps   代表了唯一凭证
dg dump display   #可以看到fps、dpi、分辨率的情况    例如：    getprop msiq.display.config
dg dump av         #可以查到av版本


eg::/ # dumpsys dnsresolver
NetId: 100          #网络标识ID
  DnsEvent subsampling map: 7:10 0:100 default:1
  DNS servers: # IP (total, successes, errors, timeouts, internal errors, RTT avg, last sample)
    10.255.255.240 (64, 64, 0, 0, 0, 0ms, 73s)
    #服务器地址：10.255.255.240
    #统计信息：共 64 次查询，64 次成功，无错误、超时或内部错误，平均 RTT（响应时间）0ms，最后一次采样在 73 秒前
    #这里即可看出：   DNS 服务器工作正常
  No search domains defined      #无 DNS 搜索域，解析规则简单。无法自动补齐域名。如：ww
  DNS parameters: sample validity = 1800s, success threshold = 25%, samples (min, max) = (8, 64), base_timeout = 5000msec, retry count = 2times
  # 超时与重试：基础超时时间为 5000ms（5 秒），重试 2 次，整体容错性中等。
  # 采样与阈值：采样有效期 30 分钟，成功阈值 25%（即只要 25% 的查询成功，就认为服务器可用），说明系统对 DNS 服务器的 “健康度” 要求较低，更容易保留可用状态。
  #无并发查询超时限制（0）：可能允许长时间的并发查询，但也可能导致极端情况下的资源占用。
  DNS64 config: none
  #DNS64 配置：无
  Private DNS mode: OPPORTUNISTIC #opportunistic 模式，优先尝试私有 DNS，失败则用常规 DNS
  Private DNS configuration (1 entries)
    10.255.255.240 name{} status{fail}
  #私有 DNS 配置：10.255.255.240（状态为失败，未成功启用）
  Concurrent DNS query timeout: 0
  #并发 DNS 查询超时：0（无超时限制）
```
22、更换镜像 
独立镜像还是共享的？共享的删下overlay的upper目录继续

### 刷机各问题
1、 free -h 内存  
free -h 无法准确查看的情况下，echo $(cat /dev/memcg/memory.limit_in_bytes) /1024/1024 | bc      使用这条命令即可。
2、 芯片版本  
```shell
设备型号：cat /sys/firmware/devicetree/base/compatible
AOSP 10（Android Open Source Project 10）
1、cat /data/local/device_update/cloudphone_info.conf
这个看到的应该是软件包的版本和安卓系统版本
2、getprop |grep version.release  
这个看到的是安卓的版本
3、getprop|grep ro.product.base_version
这个看到的是安卓的aosp的版本号。
例如：
:/ #  getprop|grep ro.product.base_version
[ro.product.base_version]: [2.47.1.mcir5.base]
```
3、 rootfs 版本  
grep ROOTFS_PATCHES_VERSION /data/local/init_sh/rootfs-guard.sh  
rootfs-patch：/data/local/device_update/software/rootfs-patch.status          #rootfs-patch  没有就是没有更新过 ，rootfs-patch。1.3.0 版本+支持清理云手机日志
rootfs：/etc/os-buildversion
4、 op-agent 版本  
/data/local/arm-op-agent/arm-op-agent version
5、dufs 版本
cat /data/local/acb-dufs/version

6、 重试任务失败（可以后续尝试，这个并未检验）
1、更新mgr版本到3.38
2、虚机在线
长沙测试专用机器 10.0.16.88
yw_opert 用户下，/data/ftp/dyj/download/container_mgr-linux-3.38.0.sh

7、设备离线问题处理
长沙测试专用机器 10.0.16.88
cs_opert 用户下，/home/cs_opert/wangyu/shell/remount_overlay.sh
vi forover.txt 物理IP=sn

8、 各种修复bug脚本服务器
10.6.178.4 cd /data/file_storge/padctl_bin/ 下

### pcdn

## ebtables隔离问题汇总
```
1、报错：touch script error touch script error arm isolate update error             #可能是磁盘不足
```

## pgsql 最近涉及到的sql命令
1、 postgresql 的sql常用命令
```shell
[root@DDY-172.26.0.71 ~]su - postgres             #登录pg 用户
Last login: Fri May 23 14:42:08 CST 2025 on pts/3

[postgres@DDY-172.26.0.71 ~]/opt/pgsql-12.11/bin/psql         #执行登录操作，一般为免密
\list      --查看有那些库 或者 \l
\c 数据库名  --connect  表示连接数据库
\dt        --"Display Tables"（显示表） ，快捷命令相当于：  
-- 查看当前数据库中所有表     
SELECT table_name FROM information_schema.tables WHERE table_type = 'BASE TABLE' AND table_schema = 'public';

 查看 是否有表                           \dt rf_pad 

\d users   --可以查看user表的表结构
eg：
redfinger_paas=# \dt rf_pad
          List of relations
 Schema |  Name  | Type  |   Owner
--------+--------+-------+-----------
 public | rf_pad | table | redfinger
(1 row)

redfinger_paas=# select pad_code from rf_pad where device_id in (select device_id from rf_device where substring(device_ip from '\d+.\d+.\d+.\d+') in ('10.1.65.77','10.1.65.78','10.1.65.79','10.1.65.80')) order by pad_code;
    pad_code
----------------
 VM010002129131
 VM010002129132
 VM010002129133
 VM010002129134
 VM010002129135
 VM010002129136
 VM010002129137
 VM010002129138
 VM010002129139
 VM010002129140
 VM010002129141
 VM010002129142
 VM010002129143
 VM010002129144
 VM010002129145
 VM010002129146
 VM010002129147
 VM010002129148
 VM010002129149
 VM010002129150
(20 rows)

redfinger_paas=#

```
“schemas” 常见读音有英式读音 /ˈskiːməz/     #模式  
columns  英式读音：/ˈkɒləmz/    （表格、数据库中的）列
```pgsql
SELECT distinct rf_idc.idc_name as 机房, rf_pad.pad_source as 设备池, rf_device.device_ip as 物理机IP,rf_device.device_management_entity as 设备管理方,rf_device.server_type as 设备型号,
rf_pad.pad_ip as 虚拟机IP, rf_pad.pad_code as 虚拟机编号, rf_device.device_status as 物理机状态, rf_pad.vm_status as 虚拟机状态
FROM rf_pad,rf_device,rf_idc
WHERE rf_pad.device_id = rf_device.device_id and rf_device.idc_id = rf_idc.idc_id
and rf_pad.pad_source not like '%toC_%'
-- and rf_device.server_type = '3588'
-- and rf_pad.merchant_user_id != '2013'
and rf_device.device_status = '1' 
and rf_pad.grant_open_status = 'on'
and rf_device.device_management_entity = 'toB'
```
综上，根据上面输出：查询设备在线且虚机授权的tob设备sql语句
```
#GROUP BY 本身就会去重每个组合，不需要再加 DISTINCT
SELECT 
  rf_idc.idc_name AS 机房, 
  rf_device.device_ip AS 物理机IP,
  rf_device.device_management_entity AS 设备管理方
FROM 
  rf_pad, rf_device, rf_idc
WHERE 
  rf_pad.device_id = rf_device.device_id 
  AND rf_device.idc_id = rf_idc.idc_id
  AND rf_pad.pad_source NOT LIKE '%toC_%'
  AND rf_device.device_status = '1' 
  AND rf_pad.grant_open_status = 'on'
  AND rf_device.device_management_entity = 'toB'
GROUP BY 
  rf_idc.idc_name, rf_device.device_ip, rf_device.device_management_entity limit 10;
```
![如上sql输出结果](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/sql.png)

```
#待分析sql
update ide_toc_remote set control_ip='10.4.150.211',control_port=9916,capture_ip='10.4.150.203',capture_port=8012 where control_ip='10.4.150.211' and pad_id in (select pad_id from rf_pad where device_id in (select device_id from rf_device where (device_ip like '11.36.1.%'
or device_ip like '10.185.30.%'
or device_ip like '10.185.29.%'
or device_ip like '10.185.28.%'
or device_ip like '10.185.27.%'
or device_ip like '10.185.100.%'
or device_ip like '11.36.4.%')) and idc_id=312);
---------------
SELECT distinct substring(pad_ip from '\d+.\d+.\d+.')
FROM rf_pad
WHERE EXISTS (
  SELECT 1
  FROM unnest(string_to_array(pad_ip, ',')) AS ip
  WHERE 
    split_part(trim(ip), '.', 1) = '10' 
    AND split_part(trim(ip), '.', 2) = '159' 
    AND split_part(trim(ip), '.', 3)::INT BETWEEN 112 AND 220
);
```

## 待学排查
### 接口查询工具
Charles 也没有抓到超时的接口请求。。
## 周报汇总
 1、从大局上整理问题，不要单纯说个人问题（显得自己问题很多）
 2、平时记录下各种吐槽问题，可以周会上汇总。要客观，不能带有主观色彩。
## post请求，找时间实验下
curl -X POST https://hl-download.armvm.com/gather/report/software-version.html \
  -H "Content-Type: application/json" \
  -d '{"version": "v2.1.3", "device_id": "abc123456"}' \
  --max-time 10  
  #-X POST：声明这是一个 POST 请求  
  #-H "Content-Type: application/json"：告诉服务器，发送的数据是 JSON 格式  
  #-d '{"version": "...", "device_id": "..."}'：要发送的具体数据（JSON 格式）  
  # --max-time 10：超时时间（10 秒内没响应就停止等待）  

#成功：类似 {"code":0, "msg":"success", "data":{}}（表示版本信息上报成功）  
#失败：比如 {"code":3100003, "msg":"参数[version]格式错误"}（需要按提示修改参数格式，比如换 version 为 2.1.3 或 2.1.3.100 再试）

## 脚本思路
1、
```shell
1、当有三种情况。
过滤总内存，过滤M， 过滤G 。 三个逻辑又各自有if判断。 这样的话 else 嵌套太深，需要 将第一次if去掉。
if grep -q ^MemoryLimit /lib/systemd/system/manage-main.service;then
grep ^MemoryLimit.*M /lib/systemd/system/manage-main.service
grep ^MemoryLimit.*G /lib/systemd/system/manage-main.service
...
...
else
  TOTALMEM="wupeizhi"
fi
}


优化思路：
local MEMLINE=$(grep ^MemoryLimit /lib/systemd/system/manage-main.service 2>/dev/null)          #直接给总内存赋值，根据结果进行if判断，这样else 不会嵌套太深。
    if [[ -z "$MEMLINE" ]]; then
        MEM_RESULT="wucfg"
        echo "$MEM_RESULT"
        return
    fi
```
2、lxc-ls 本地执行与远程执行效果不同
```
[device@zc-10-6-42-115 wangyulong]$ ssh -i wsy_wsy -p 62485 root@11.28.204.90 'lxc-ls'
0
1
2
3
4            #每个容器名单独占一行，这是 lxc-ls 在非交互式环境（无终端）下的默认输出格式。

Last login: Fri Aug  1 18:36:17 2025 from 10.6.42.115
root@mciserver:~# lxc-ls
0    1    2    3    4
```
3、 bash中双小括号的使用
```
if (( $a < $b )); then
也是有效的，但不必要加 $          #在 Bash 的整数条件表达式语法 ((...)) 中，变量名前面可以 不加 $，这是语法的特性之一。
```
3、 脚本中遇到reboot后继续执行的脚本如何处理（待检验）
```
  1、重启后继续执行脚本的原理
 思路： 创建启动后执行的脚本+创建临时的systemd 服务
#创建启动后执行的脚本
tee /usr/local/bin/post_reboot.sh >/dev/null <<'EOF'
#!/bin/bash
# 重启后执行的动作
echo "$(date '+%F %T') success" >> /tmp/reboot.log
# 你也可以改成发钉钉、飞书等通知，比如：
# curl -X POST -H "Content-Type: application/json" \
#      -d '{"msg":"server rebooted"}' https://example.com/webhook
EOF
chmod +x /usr/local/bin/post_reboot.sh
#创建临时的systemd服务
tee /etc/systemd/system/post-reboot.service >/dev/null <<'EOF'
[Unit]
Description=Post reboot action
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/post_reboot.sh
# 执行一次后就删除自己
ExecStartPost=/bin/bash -c 'systemctl disable post-reboot.service'

[Install]
WantedBy=multi-user.target
EOF

执行服务：sudo systemctl enable post-reboot.service
执行重启：reboot。
* 重启后，post_reboot.sh 会自动执行一次
* 执行完会自动把自己 disable 掉，不会下次开机再触发
```
4、shell中对于sudo 命令的使用。
sudo echo 'abc' >> /tmp/test.sh              #对应非sudo无权限执行的用户来说，这个无法执行。 （重定向操作不继承 sudo 的权限） 
核心原因是 重定向操作（>>）不受 sudo 权限提升的影响  
a. sudo 会提升 echo 命令的权限
b.但 重定向操作 >> /tmp/test.sh 是由当前 shell 进程执行的，而非 sudo 提升权限后的进程。 也就是说，>> 操作的权限依赖于 当前登录用户的权限，而非 sudo 赋予的 root 权限。     
实现方法1：
sudo bash -c "echo 'abc' >> /tmp/test.sh"
方法2：
echo 'abc' | sudo tee -a /tmp/test.sh > /dev/null     

## pass各服务问题定位
### 服务汇总，manage-proxy manage-agent ctrl-server
```
服务用户(paas)
 manage-proxy 与 manage-server
一、检查proxy服务是否正常（一般场景是：大量pass状态离线、任务执行失败。==要检查proxy节点是否正常）
1、看进程    vip位置。以及vip脚本是否正常
2、有进程，看日志
cd /data/paas/base-service/manage-proxy/node节点/logs
3、过滤看是否出现  heartbeat  心跳检测或者 过滤 connected
二、manage-proxy 与 manage-server 的关系， proxy、server 互相链接 的服务。（例如：paas后台的一个重启任务，pass后台给到server，server给到proxy。再去给设备。 回调相反即可。）
manage-server 由其他同事管理

三、大量pass状态离线、任务执行失败。==要检查proxy节点是否正常
检测方法。例如：11.14.4.80
1、 arm设备telnet proxy 的ip和端口 是否通
arm设备： ps-ef|grep mange-agent              #manage-agent 10.6.42.218:7918  这个ip:端口即proxy的ip和端口
这个telnet通代表了进程是存在的，服务是否正常还需要进一步排查。
2、看日志
cd /data/paas/base-service/manage-proxy/node节点/logs  #cat 后出现：connection refused  
这个代表的是无法连接管理服务。即：manage-server
现象：pass后台执行任务失败（例如：重启remote-play），pass报错：mange-proxy节点链接失败。一般就是 manage-proxy的配置文件错了  或者是  manage-server 服务
a. 进入manage-proxy的配置文件
cat run.sh |grep manage_server。 再配合ps -ef|grep mange-proxy 可以看参数对应的意义
-a :manage_server_ip
-p :manage_server_port
-n : node_name
-P : node_port
-t : status_timeout

确定 server的ip 端口是否可以telnet 通。 在 manage-proxy节点测试。
b. 确定mange-server 的信息（通过node-name去查询）
manage-server 的ip 和端口，  可以通过243 服务器进行查看对应的ip和端口。

设备--proxy--管理服务--paas

通过243  过滤#查看节点编号node_name=DRILL-MANAGE-PROXY-01
vi /data/mci/kioa/_ansibleBasic/base-service/hosts-manage-proxy-vip     例如：

[proxy_drill_vip_01]

PROXY-DRILL-VIP-01    node_name=DRILL-MANAGE-PROXY-01    manage_proxy_port=7918    manage_server_ip=10.6.218.203   manage_server_port=8988

[proxy_drill_vip_01:vars]
ansible_host=10.6.42.218

c.
去42.115 上看  ps-ef|grep proxy      #看到的是 manage——proxy -a -p   #表示管理-server的ip和端口8988，检测是否一致。
若不一致： 更改run.sh后
sh run.sh stop 后会自动拉齐proxy进程。再去看看日志即可。
########################
推流演练：控制+nginx （一一对应） ：推流不到控制节点，就会黑屏。

 控制（控制节点）是一个池子，用户链接后随机分配。是否分配有pass后台对应节点是否启用决定。节点ip对应的是x86地址
提示：一台服务器上可能部署了多个节点，有相同ip的多个端口
控制是用来推流的，用户的画面。
proxy是用来管理设备一些任务状态         推给remote-play后展现出来。

控制节点： 节点类型 这里可以查到。

https://manager-prod.cloud-control.top/armvm-console-manager/facility/pad/connectDevice?padCode=VM010248007067&packname=&controlIp=paasdrillc.armvm.com&controlPort=10027&sessionId=console966297cfca834aa48b191ca31a387505&userId=8184381

解释： 
1、
10027 就是websocket端口，禁用掉一个后，去自动切换到其他节点。      端口逻辑，在pass后台中的控制节点中： 有节点端口 和 websocket（NG） 端口。-----转给节点端口 。提示：websocket 最后一位的7是固定的。
websocket 的中间编号代表了 节点编号。（百+千位）
节点端口：例如：10020 代表第2个节点  10160  代表第16个节点。
2、
controlIp  就是节点ip的域名

控制服务+ remote 是一组
管理-proxy + manage-agent 是一组。

3、control-server 重启会生成一个新进程
```
## F12定位问题汇总
云手机黑屏f12定位如下：
![f12定位方法](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/f12%E5%AE%9A%E4%BD%8D%E9%94%99%E8%AF%AF.JPG?raw=true)

## 各值班问题汇总
1、 针对于命令执行失败的问题解决  
a. 一般都是命令不通。例如dg dgbak  或者am ams  。cp 或者mv 一份即可。但是有些没有权限操作
b.  简单有效的办法是去：物理机直接cp 一份到对应的虚机目录下。这样不会担心没有权限的问题。也不用有额外的操作。

2、 dns错误导致 www.baidu.com 无法解析（未尝试，一般reboot即可恢复）
```
1、dumpsys dnsresolver           #可以看到dns为：10.255.255.242（当时未启用，导致dns解析出问题）
2、第二种查询方式
getprop | grep dns
[net.dns1]: [10.255.255.242]            #这个可能是由于设置了：net_override_dns=10.255.255.242
[ro.net.provisioned.dns]: [10.255.255.240,10.255.255.240]           #这个未启用
3、
执行 settings list system｜grep dns（设置的覆盖分辨率 导致）

4、想要恢复默认dns：
settings put secure net_override_dns 10.255.255.240；settings delete secure net_override_dns;         #出现2中dns修复方法
```
3、开启adb权限，又称为绑定adb 
```
将 /data/local/container/manage.conf 文件中的adbSwitch=0 改为 adbSwitch=1
将 sys.powerboot.adbd=ture 追加到 /data/lxc_volumns/system_0/build.prop (不通的安卓版本目录不一样)

回验：重启云手机后
ps -ef|grep adbd          #即可。
##### 手动执行命令为：dg config -a system.adb=true;setprop persist.adb.auth false;stop adbd;start adbd
```
## 值班服务问题汇总
### 反馈机房网络延迟数值很高，判断是否和推流有关系
```
1、先登录ARM机器上看看P2P日志，可以看remote的相关日志。查询方式如下：
cat /data/local/logs/remote-play/remote-play.log.2.20250811 |egrep -i 'rtt_ms|loss' |grep " 21:49:" --color=auto
日志可以看到：
WebRTC（Web Real - Time Communication），即网页实时通信，是一项免费开源的技术标准与框架，让浏览器、移动应用等能在无需额外插件或软件的情况下，直接实现实时音视频通话、数据传输 ，广泛用于视频会议、在线教育、直播连麦等场景，以下从核心功能和理解角度拆解：

rtt_ms  :即往返时延，单位是毫秒（ms）.一个数据包往返一次的时间是 65 毫秒  
retransmit_bps 是 重传数据的比特率，单位是比特每秒（bps） 。 133008 bps 意味着当前每秒有 133008 比特的数据在进行重传操作。重传率高（该数值大），通常反映网络存在较多丢包、不稳定的情况，可能导致视频画面花屏、卡顿，因为需要不断补发数据来填补丢失的内容. 这里高通常会看到cum_loss 也会高  
cum_loss 是 累计丢包数 。 指从通话开始到当前时刻，发送出去但未被成功接收（也未通过重传等机制弥补）的数据包总数。这里 140 就是累计丢包的数量  
这些指标都是用于衡量 WebRTC 视频通话过程中网络传输质量和稳定性的关键参数，通过它们能排查网络延迟、丢包、重传等问题对通话体验的影响。
```

```
1\tail -f control-server-worker_ZHTW-PAD-CONTROL-01_20250715-194617.239150
检测日志有正常输出


2、/etc/keepalived/keepalived.conf  为keepalived 的配置文件可以过滤出201vip 使用的检测脚本是哪个。

    script "/home/ctlserver/HA/sh/ha_switch.sh"
    notify_master "/etc/keepalived/notify.py master"
    notify_backup "/etc/keepalived/notify.py backup"

3、通过查看/home/ctlserver/HA/sh/ha_switch.sh。发现每几秒执行这个脚本：/home/ctlserver/HA/sh/process.sh stop (vip 已经飘走)

4、/home/ctlserver/HA/sh/process.sh 可以看到都执行了：/home/ctlserver/HA/sh/chk_nginx.sh

declare -a all_processes_config=(
"root  $SHELL_PATH/  chk_nginx.sh  null  null  root  chk_nginx  null"
)

5、[ctlserver@TW-10.6.181.1 logs]cat check_process.log-20250714 |grep "23:05:"
---------- start app on all nodes ... [ 2025-07-14 23:05:10 ] -----------
---------- start app on all nodes ... [ 2025-07-14 23:05:19 ] -----------
---------- start app finish ... [ 2025-07-14 23:05:19 ] -----------------
---------- switch to backup server ... [ 2025-07-14 23:05:19 ] ----------               #可以看到切换到了备机

6、[ctlserver@TW-10.6.181.1 logs]cat /var/log/messages |grep VI_2
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Changing effective priority from 100 to 95
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Received advert with higher priority 99, ours 95
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Entering BACKUP STATE
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) removing protocol VIPs.
Jul 14 23:06:37 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Changing effective priority from 100 to 95
Jul 14 23:06:43 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Changing effective priority from 95 to 100
Jul 14 23:53:53 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Transition to MASTER STATE
Jul 14 23:53:54 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Entering MASTER STATE
Jul 14 23:53:54 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) setting protocol VIPs.
Jul 14 23:53:54 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Sending/queueing gratuitous ARPs on bond0 for 10.6.181.201
Jul 14 23:53:59 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Sending/queueing gratuitous ARPs on bond0 for 10.6.181.201

##################
7、[ctlserver@TW-10.6.181.1 logs]cat /var/log/messages |grep -C 10 VI_2
Jul 14 23:05:06 tw181001 systemd-logind: Removed session 48555217.
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: Process [68139] didn't respond to SIGTERM
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: Process [68140] didn't respond to SIGTERM
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: Process [68141] didn't respond to SIGTERM
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: pid 68139 exited due to signal 9
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Script(ha_switch_redfinger) timed out
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Script(ha_switch) timed out
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Script(ha_switch_proxy) timed out
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_8) Changing effective priority from 100 to 95
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_3) Changing effective priority from 100 to 95
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_2) Changing effective priority from 100 to 95
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: pid 68140 exited due to signal 9
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: pid 68141 exited due to signal 9
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: /home/redfinger/HA/sh/ha_switch.sh exited due to signal 15
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: /home/ctlserver/HA/sh/ha_switch.sh exited due to signal 15
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: /home/manageproxy/HA/sh/ha_switch.sh exited due to signal 15
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: VRRP_Instance(VI_1) Received advert with lower priority 99, ours 100, forcing new election
Jul 14 23:05:10 tw181001 Keepalived_vrrp[54944]: Sending gratuitous ARP on bond0 for 10.6.181.240
```

## 如流机器人使用方法
```
群主创建机器人：获取webhook地址和群id以及个人id+回调地址（个人搭建的网站用来接收机器人消息，回调结论）
例如：
webhook地址：http://apiin.im.baidu.com/api/msg/groupmsgsend?access_token=de34b0b530b106d15178e2630ea7f790d
群id：即群号：11461246
个人id：即去掉邮箱后缀即是
```
### md语法send
```
curl -X POST 'http://apiin.im.baidu.com/api/msg/groupmsgsend?access_token=de34b0b530b106d15178e2630ea7f790d' \
  -H "Content-Type:application/json" \
  -d '{
    "message": {
      "header": {
        "toid": [11461246]
      },
      "body": [
        {
          "type": "MD",
          "content": "# 大狗子反馈 \n不要摸鱼<font color=\"red\">，请相关同事注意。</font>"
        }
      ]
    }
  }'
```

### link + 艾特(@群成员(仅可以与TEXT类型、LINK类型一起使用，IMAGE类型、MARKDOWN类型不能使用AT类型))
```
curl -X POST 'http://apiin.im.baidu.com/api/msg/groupmsgsend?access_token=de34b0b530b106d15178e2630ea7f790d' \
  -H "Content-Type:application/json" \
  -d '{
    "message": {
      "header": {
        "toid": [11461246]
      },
      "body": [
        {
          "type": "LINK",
          "href": "https://www.baidu.com/"
        },
        {
                "atuserids":["wangyulong09"],
                "atall":false,
                "type":"AT"
        }
      ]
    }
  }'
```
### 图片send
```
curl -X POST 'http://apiin.im.baidu.com/api/msg/groupmsgsend?access_token=de34b0b530b106d15178e2630ea7f790d' \
  -H "Content-Type:application/json" \
  -d '{
    "message": {
      "header": {
        "toid": [11461246]
      },
      "body": [
        {
          "type": "IMAGE",
           "content": "/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAMgAyADASIAAhEBAxEB/8QAHAAAAQUBA......................WUCTEpFRKofMlcKCSInmCbMopXRUgUswUbpkBLpXULpIJlw3J7hDSvZAS6V1AFPdBK4TqCV0RO6V1DMU90U5KV1EnVNdBNMSo3T3QODdPdRumREimuE10rqtP//Z"
        }
      ]
    }
  }'

##1、获取base64 编码的方法cmd，特别长。但是必须经过处理放到一行
certutil -encode "C:\Users\wangyulong\Desktop\tsl.jpg" temp.txt && type temp.txt | findstr /v "BEGIN" | findstr /v "END" > img_base64.txt && del temp.txt
##2、不能在curl 的代码上加注释，例如 //图片byte数据base64编码后的值，byte小于1m
```
### 基础text
```
curl -X POST 'http://apiin.im.baidu.com/api/msg/groupmsgsend?access_token=de34b0b530b106d15178e2630ea7f790d' \
   -H "Content-Type:application/json" \
   -d '{
    "message": {
       "header":{
            "toid":[11461246]
        },
        "body": [
		  {
		  "type": "TEXT", 
		  "content": "hi, robot!"
		  }
		       ]
     }
  }'
```
综上。如截图所示  
![如流机器人send_result](https://github.com/linuxlaowang/tuchuang/raw/master/nodes/reboot.JPG)

## 值班服务问题学习汇总 1：管理代理 服务： manage-proxy
```
1、国内\外  pass后台： 物理机配置： 查询ip，可以看到机房，防火墙------------确定机房位置              设备管理节点：可以看到这片物理机分别的管理节点
2、控制节点：节点类型为管理节点 防火墙为：例如：江苏常熟百度防火墙
```
